# ========================================
# LYDIAN-IQ SECURITY HEADERS CONFIGURATION
# ========================================
# Purpose: Web security headers for production deployment
# Compliance: OWASP Top 10, NIST 800-53, PCI-DSS
# Version: 1.0

# Content Security Policy (CSP)
# Restricts resource loading to prevent XSS, data injection, and other attacks
Content-Security-Policy: default-src 'self'; \
  img-src 'self' data: https://*.cloudinary.com https://*.azure.com; \
  font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com; \
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; \
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; \
  connect-src 'self' https://api.lydian.ai https://*.azure.com https://*.openai.com https://*.anthropic.com; \
  frame-ancestors 'none'; \
  object-src 'none'; \
  base-uri 'self'; \
  form-action 'self'; \
  upgrade-insecure-requests;

# Referrer Policy
# Controls how much referrer information is sent with requests
Referrer-Policy: strict-origin-when-cross-origin;

# Permissions Policy (formerly Feature-Policy)
# Disables browser features that are not needed
Permissions-Policy: geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=();

# X-Frame-Options
# Prevents clickjacking attacks by disabling framing
X-Frame-Options: DENY;

# X-Content-Type-Options
# Prevents MIME-sniffing attacks
X-Content-Type-Options: nosniff;

# X-XSS-Protection
# Enables browser XSS protection (legacy, CSP is preferred)
X-XSS-Protection: 1; mode=block;

# Strict-Transport-Security (HSTS)
# Forces HTTPS connections for 1 year, including subdomains, with preload
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload;

# Cross-Origin-Embedder-Policy
# Prevents cross-origin resources from being embedded
Cross-Origin-Embedder-Policy: require-corp;

# Cross-Origin-Opener-Policy
# Isolates browsing context to prevent cross-origin attacks
Cross-Origin-Opener-Policy: same-origin;

# Cross-Origin-Resource-Policy
# Controls cross-origin resource sharing
Cross-Origin-Resource-Policy: same-origin;

# ========================================
# ENVIRONMENT-SPECIFIC OVERRIDES
# ========================================

# Development (relaxed CSP for hot-reload)
# [dev] Content-Security-Policy: default-src 'self' 'unsafe-inline' 'unsafe-eval' *; connect-src *;

# Staging (moderate CSP)
# [staging] Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://*.azure.com;

# Production (strict CSP - use above configuration)
# [production] Use the strict configuration defined above

# ========================================
# CORS CONFIGURATION (for API Gateway)
# ========================================
# Access-Control-Allow-Origin: https://console.lydian.ai, https://chat.lydian.ai
# Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
# Access-Control-Allow-Headers: Content-Type, Authorization, X-Request-ID, X-Correlation-ID
# Access-Control-Allow-Credentials: true
# Access-Control-Max-Age: 86400

# ========================================
# WEBHOOK SECURITY
# ========================================
# All incoming webhooks MUST include:
# - X-Signature: HMAC-SHA256 signature
# - X-Timestamp: Unix timestamp (replay window ≤ 300s)
# - X-Nonce: Unique request identifier
# Missing or invalid signatures → 401 Unauthorized

# ========================================
# RATE LIMITING HEADERS
# ========================================
# X-RateLimit-Limit: Maximum requests per window
# X-RateLimit-Remaining: Remaining requests in current window
# X-RateLimit-Reset: Unix timestamp when limit resets
# Retry-After: Seconds to wait before retrying (429 responses)

# ========================================
# CUSTOM SECURITY HEADERS
# ========================================
# X-Request-ID: Unique request identifier for tracing
# X-Correlation-ID: End-to-end correlation ID
# X-Content-Hash: SHA-256 hash of response body (integrity check)
# X-Legal-Gate: Connector status (sandbox|partner_ok|disabled)
