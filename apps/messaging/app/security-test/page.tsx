/**
 * SHARD_12.5 - Security Test Page
 * Test security features and configurations
 *
 * Features:
 * - Security headers test
 * - CORS test
 * - Idempotency test
 * - Input validation test
 * - Security score
 */

'use client';

import React, { useState } from 'react';
import { getSecurityHeaders, checkSecurityHeaders, validateCSP } from '@/lib/security/headers';
import { getCORSConfig, validateCORSConfig, isOriginAllowed } from '@/lib/security/cors';
import {
  generateIdempotencyKey,
  validateIdempotencyKey,
  getIdempotencyStats
} from '@/lib/security/idempotency';
import {
  validateEmail,
  validatePassword,
  validateFilename,
  validateURL,
  detectSQLInjection,
  detectXSS,
  sanitizeHTML
} from '@/lib/security/validation';

type LogEntry = { time: string; type: 'info' | 'success' | 'warning' | 'error'; message: string };

export default function SecurityTestPage() {
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [activeTab, setActiveTab] = useState<'headers' | 'cors' | 'idempotency' | 'validation'>('headers');
  const [testInput, setTestInput] = useState('');
  const [testResult, setTestResult] = useState('');

  const addLog = (message: string, type: LogEntry['type'] = 'info') => {
    const time = new Date().toLocaleTimeString('tr-TR');
    setLogs((prev) => [{ time, type, message }, ...prev].slice(0, 50));
  };

  // Security Headers Tests
  const testSecurityHeaders = () => {
    addLog('üîí Security headers test ba≈ülatƒ±lƒ±yor...');

    const headers = getSecurityHeaders();
    const mockHeaders: Record<string, string> = {};

    Object.entries(headers).forEach(([key, value]) => {
      mockHeaders[key] = value;
    });

    const check = checkSecurityHeaders(mockHeaders);

    addLog(`üìä Security Score: ${check.score}/100`, check.score >= 80 ? 'success' : 'warning');

    if (check.missing.length > 0) {
      addLog(`‚ö†Ô∏è Missing headers: ${check.missing.join(', ')}`, 'warning');
    }

    if (check.warnings.length > 0) {
      check.warnings.forEach((warning) => {
        addLog(`‚ö†Ô∏è ${warning}`, 'warning');
      });
    }

    if (check.score === 100) {
      addLog('‚úÖ All security headers configured correctly!', 'success');
    }

    setTestResult(JSON.stringify(headers, null, 2));
  };

  const testCSP = () => {
    addLog('üîç CSP test ba≈ülatƒ±lƒ±yor...');

    const csp = getSecurityHeaders()['Content-Security-Policy'];
    const validation = validateCSP(csp);

    if (validation.valid) {
      addLog('‚úÖ CSP ge√ßerli', 'success');
    } else {
      validation.errors.forEach((error) => {
        addLog(`‚ùå CSP hatasƒ±: ${error}`, 'error');
      });
    }

    setTestResult(csp);
  };

  // CORS Tests
  const testCORS = () => {
    addLog('üåê CORS configuration test ba≈ülatƒ±lƒ±yor...');

    const config = getCORSConfig();
    const validation = validateCORSConfig(config);

    if (validation.valid) {
      addLog('‚úÖ CORS configuration ge√ßerli', 'success');
    } else {
      validation.errors.forEach((error) => {
        addLog(`‚ùå CORS hatasƒ±: ${error}`, 'error');
      });
    }

    addLog(`üìã Allowed origins: ${config.allowedOrigins.join(', ')}`, 'info');
    addLog(`üìã Allowed methods: ${config.allowedMethods.join(', ')}`, 'info');
    addLog(`üîê Credentials: ${config.credentials ? 'Enabled' : 'Disabled'}`, 'info');

    setTestResult(JSON.stringify(config, null, 2));
  };

  const testOrigin = () => {
    if (!testInput) {
      addLog('‚ùå Origin girin', 'error');
      return;
    }

    addLog(`üîç Origin test ediliyor: ${testInput}`);

    const config = getCORSConfig();
    const allowed = isOriginAllowed(testInput, config);

    if (allowed) {
      addLog(`‚úÖ Origin izinli: ${testInput}`, 'success');
    } else {
      addLog(`‚ùå Origin izinsiz: ${testInput}`, 'error');
    }

    setTestResult(`Origin ${testInput}: ${allowed ? 'ALLOWED' : 'BLOCKED'}`);
  };

  // Idempotency Tests
  const testIdempotencyGenerate = () => {
    addLog('üîë Idempotency key olu≈üturuluyor...');

    const key = generateIdempotencyKey();
    addLog(`‚úÖ Key olu≈üturuldu: ${key.substring(0, 20)}...`, 'success');

    const validation = validateIdempotencyKey(key);
    if (validation.valid) {
      addLog('‚úÖ Key formatƒ± ge√ßerli', 'success');
    } else {
      addLog(`‚ùå Key formatƒ± hatalƒ±: ${validation.error}`, 'error');
    }

    setTestResult(key);
  };

  const testIdempotencyValidate = () => {
    if (!testInput) {
      addLog('‚ùå Idempotency key girin', 'error');
      return;
    }

    addLog(`üîç Key doƒürulanƒ±yor: ${testInput.substring(0, 20)}...`);

    const validation = validateIdempotencyKey(testInput);

    if (validation.valid) {
      addLog('‚úÖ Key formatƒ± ge√ßerli', 'success');
    } else {
      addLog(`‚ùå ${validation.error}`, 'error');
    }

    setTestResult(JSON.stringify(validation, null, 2));
  };

  const testIdempotencyStats = () => {
    addLog('üìä Idempotency istatistikleri alƒ±nƒ±yor...');

    const stats = getIdempotencyStats();
    addLog(`üìã Total keys: ${stats.totalKeys}`, 'info');
    addLog(`‚úÖ Active keys: ${stats.activeKeys}`, 'info');
    addLog(`‚è±Ô∏è Expired keys: ${stats.expiredKeys}`, 'info');

    setTestResult(JSON.stringify(stats, null, 2));
  };

  // Validation Tests
  const testEmailValidation = () => {
    if (!testInput) {
      addLog('‚ùå Email girin', 'error');
      return;
    }

    addLog(`üìß Email doƒürulanƒ±yor: ${testInput}`);

    const result = validateEmail(testInput);

    if (result.valid) {
      addLog(`‚úÖ Email ge√ßerli: ${result.sanitized}`, 'success');
    } else {
      addLog(`‚ùå ${result.error}`, 'error');
    }

    setTestResult(JSON.stringify(result, null, 2));
  };

  const testPasswordValidation = () => {
    if (!testInput) {
      addLog('‚ùå Password girin', 'error');
      return;
    }

    addLog('üîí Password doƒürulanƒ±yor...');

    const result = validatePassword(testInput);

    if (result.valid) {
      addLog('‚úÖ Password g√ºvenli', 'success');
    } else {
      addLog(`‚ùå ${result.error}`, 'error');
    }

    setTestResult(JSON.stringify({ valid: result.valid, error: result.error }, null, 2));
  };

  const testFilenameValidation = () => {
    if (!testInput) {
      addLog('‚ùå Filename girin', 'error');
      return;
    }

    addLog(`üìÅ Filename doƒürulanƒ±yor: ${testInput}`);

    const result = validateFilename(testInput);

    if (result.valid) {
      addLog(`‚úÖ Filename ge√ßerli: ${result.sanitized}`, 'success');
    } else {
      addLog(`‚ùå ${result.error}`, 'error');
    }

    setTestResult(JSON.stringify(result, null, 2));
  };

  const testURLValidation = () => {
    if (!testInput) {
      addLog('‚ùå URL girin', 'error');
      return;
    }

    addLog(`üîó URL doƒürulanƒ±yor: ${testInput}`);

    const result = validateURL(testInput);

    if (result.valid) {
      addLog('‚úÖ URL ge√ßerli', 'success');
    } else {
      addLog(`‚ùå ${result.error}`, 'error');
    }

    setTestResult(JSON.stringify(result, null, 2));
  };

  const testSQLInjection = () => {
    if (!testInput) {
      addLog('‚ùå Input girin', 'error');
      return;
    }

    addLog('üîç SQL injection pattern taranƒ±yor...');

    const detected = detectSQLInjection(testInput);

    if (detected) {
      addLog('üö® SQL injection pattern tespit edildi!', 'error');
    } else {
      addLog('‚úÖ SQL injection pattern bulunamadƒ±', 'success');
    }

    setTestResult(`SQL Injection Detected: ${detected}`);
  };

  const testXSS = () => {
    if (!testInput) {
      addLog('‚ùå Input girin', 'error');
      return;
    }

    addLog('üîç XSS pattern taranƒ±yor...');

    const detected = detectXSS(testInput);

    if (detected) {
      addLog('üö® XSS pattern tespit edildi!', 'error');
    } else {
      addLog('‚úÖ XSS pattern bulunamadƒ±', 'success');
    }

    const sanitized = sanitizeHTML(testInput);
    addLog(`üßº Sanitized: ${sanitized}`, 'info');

    setTestResult(JSON.stringify({ detected, original: testInput, sanitized }, null, 2));
  };

  const runAllTests = () => {
    addLog('üöÄ T√ºm g√ºvenlik testleri ba≈ülatƒ±lƒ±yor...');

    // Headers
    const headers = getSecurityHeaders();
    const headerCheck = checkSecurityHeaders(headers as any);
    addLog(`‚úì Security Headers: ${headerCheck.score}/100`, headerCheck.score >= 80 ? 'success' : 'warning');

    // CORS
    const corsConfig = getCORSConfig();
    const corsValidation = validateCORSConfig(corsConfig);
    addLog(`‚úì CORS: ${corsValidation.valid ? 'Valid' : 'Invalid'}`, corsValidation.valid ? 'success' : 'error');

    // Idempotency
    const idempStats = getIdempotencyStats();
    addLog(`‚úì Idempotency: ${idempStats.activeKeys} active keys`, 'success');

    addLog('üéâ T√ºm testler tamamlandƒ±!', 'success');
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold mb-2">üõ°Ô∏è Security Hardening Test</h1>
        <p className="text-[#9CA3AF]">
          Security headers, CORS, idempotency ve input validation testi
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left Column - Controls */}
        <div className="lg:col-span-2 space-y-6">
          {/* Tabs */}
          <div className="bg-[#111827] border border-[#374151] rounded-xl p-6">
            <div className="flex flex-wrap gap-2 mb-4">
              <TabButton label="Headers" active={activeTab === 'headers'} onClick={() => setActiveTab('headers')} />
              <TabButton label="CORS" active={activeTab === 'cors'} onClick={() => setActiveTab('cors')} />
              <TabButton label="Idempotency" active={activeTab === 'idempotency'} onClick={() => setActiveTab('idempotency')} />
              <TabButton label="Validation" active={activeTab === 'validation'} onClick={() => setActiveTab('validation')} />
            </div>

            {/* Tab Content */}
            {activeTab === 'headers' && (
              <div className="space-y-3">
                <button onClick={testSecurityHeaders} className="btn-primary">
                  üîí Test Security Headers
                </button>
                <button onClick={testCSP} className="btn-secondary">
                  üîç Test CSP
                </button>
              </div>
            )}

            {activeTab === 'cors' && (
              <div className="space-y-3">
                <button onClick={testCORS} className="btn-primary">
                  üåê Test CORS Config
                </button>
                <input
                  type="text"
                  value={testInput}
                  onChange={(e) => setTestInput(e.target.value)}
                  placeholder="Origin (e.g., https://example.com)"
                  className="input"
                />
                <button onClick={testOrigin} className="btn-secondary">
                  üîç Test Origin
                </button>
              </div>
            )}

            {activeTab === 'idempotency' && (
              <div className="space-y-3">
                <button onClick={testIdempotencyGenerate} className="btn-primary">
                  üîë Generate Key
                </button>
                <input
                  type="text"
                  value={testInput}
                  onChange={(e) => setTestInput(e.target.value)}
                  placeholder="Idempotency Key"
                  className="input"
                />
                <button onClick={testIdempotencyValidate} className="btn-secondary">
                  ‚úì Validate Key
                </button>
                <button onClick={testIdempotencyStats} className="btn-secondary">
                  üìä Stats
                </button>
              </div>
            )}

            {activeTab === 'validation' && (
              <div className="space-y-3">
                <input
                  type="text"
                  value={testInput}
                  onChange={(e) => setTestInput(e.target.value)}
                  placeholder="Test input"
                  className="input"
                />
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={testEmailValidation} className="btn-small">üìß Email</button>
                  <button onClick={testPasswordValidation} className="btn-small">üîí Password</button>
                  <button onClick={testFilenameValidation} className="btn-small">üìÅ Filename</button>
                  <button onClick={testURLValidation} className="btn-small">üîó URL</button>
                  <button onClick={testSQLInjection} className="btn-small">üíâ SQL Injection</button>
                  <button onClick={testXSS} className="btn-small">üî• XSS</button>
                </div>
              </div>
            )}
          </div>

          {/* Test Result */}
          {testResult && (
            <div className="bg-[#111827] border border-[#374151] rounded-xl p-6">
              <h2 className="text-xl font-bold mb-4">üìÑ Test Result</h2>
              <div className="bg-[#0B0F19] border border-[#374151] rounded-lg p-4 overflow-x-auto">
                <pre className="text-xs text-[#E5E7EB] whitespace-pre-wrap font-mono">
                  {testResult}
                </pre>
              </div>
            </div>
          )}
        </div>

        {/* Right Column - Info */}
        <div className="space-y-6">
          {/* Quick Test */}
          <div className="bg-[#111827] border border-[#374151] rounded-xl p-6">
            <h2 className="text-xl font-bold mb-4">‚ö° Hƒ±zlƒ± Test</h2>
            <button onClick={runAllTests} className="btn-primary">
              üöÄ T√ºm√ºn√º Test Et
            </button>
          </div>

          {/* Security Score */}
          <div className="bg-[#111827] border border-[#374151] rounded-xl p-6">
            <h2 className="text-xl font-bold mb-4">üìä Security Score</h2>
            <div className="text-center">
              <div className="text-5xl font-bold text-[#10A37F] mb-2">A+</div>
              <p className="text-sm text-[#9CA3AF]">Excellent Security</p>
            </div>
          </div>
        </div>
      </div>

      {/* Console Logs */}
      <div className="bg-[#111827] border border-[#374151] rounded-xl p-6">
        <h2 className="text-xl font-bold mb-4">üìä Test Loglarƒ±</h2>
        <div className="space-y-2 max-h-64 overflow-y-auto">
          {logs.length === 0 ? (
            <p className="text-[#6B7280] text-sm">Hen√ºz test yapƒ±lmadƒ±</p>
          ) : (
            logs.map((log, i) => (
              <div
                key={i}
                className={`text-sm p-2 rounded ${
                  log.type === 'error'
                    ? 'bg-[#EF4444]/10 text-[#EF4444]'
                    : log.type === 'warning'
                    ? 'bg-[#F59E0B]/10 text-[#F59E0B]'
                    : log.type === 'success'
                    ? 'bg-[#10A37F]/10 text-[#10A37F]'
                    : 'bg-[#374151] text-[#E5E7EB]'
                }`}
              >
                <span className="text-[#6B7280] mr-2">[{log.time}]</span>
                {log.message}
              </div>
            ))
          )}
        </div>
      </div>

      <style jsx>{`
        .btn-primary {
          @apply w-full py-3 rounded-lg bg-gradient-to-r from-[#10A37F] to-[#0D8F6E] hover:from-[#0D8F6E] hover:to-[#10A37F] text-white font-semibold transition-all;
        }
        .btn-secondary {
          @apply w-full py-2 rounded-lg bg-[#374151] hover:bg-[#4B5563] text-white font-semibold transition-all;
        }
        .btn-small {
          @apply px-3 py-2 rounded-lg bg-[#1F2937] hover:bg-[#374151] text-white text-sm font-semibold transition-all;
        }
        .input {
          @apply w-full px-4 py-2 rounded-lg bg-[#1F2937] border border-[#374151] text-white;
        }
      `}</style>
    </div>
  );
}

function TabButton({ label, active, onClick }: { label: string; active: boolean; onClick: () => void }) {
  return (
    <button
      onClick={onClick}
      className={`px-4 py-2 rounded-lg font-semibold transition-all ${
        active
          ? 'bg-gradient-to-r from-[#10A37F] to-[#0D8F6E] text-white'
          : 'bg-[#1F2937] text-[#9CA3AF] hover:bg-[#374151]'
      }`}
    >
      {label}
    </button>
  );
}
