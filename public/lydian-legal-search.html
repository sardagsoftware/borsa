<!-- Cache-Buster: 1759577324 -->
<!DOCTYPE html>
<html lang="tr" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyDian Hukuk AI - Hukuki Danƒ±≈ümanlƒ±k Asistanƒ±</title>
    <link rel="icon" type="image/png" href="/lydian-logo.png">

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fonts - Inline critical fonts for instant load -->
    <style>
        /* Righteous font for Logo - Inline for instant load */
        @font-face {
            font-family: 'Righteous';
            font-style: normal;
            font-weight: 400;
            font-display: block;
            src: url(https://fonts.gstatic.com/s/righteous/v14/1cXxaUPXBpj2rGoU7C9WhnGFucE.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Righteous&display=swap" rel="stylesheet">

    <style>
/* ============================================================
   üèõÔ∏è LYDIAN HUKUK AI - PREMIUM LEGAL CHAT INTERFACE 2025
   ============================================================ */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* ‚öñÔ∏è JUSTICE COLOR SYSTEM - Gold & Maroon Theme */
    --justice-gold: #C4A962;
    --justice-gold-bright: #D4B972;
    --justice-maroon: #8B1538;
    --justice-maroon-bright: #A01D48;

    /* üé® JUSTICE GRADIENTS */
    --gradient-primary: linear-gradient(135deg, #C4A962 0%, #8B1538 100%);
    --gradient-subtle: linear-gradient(135deg, rgba(196, 169, 98, 0.1) 0%, rgba(139, 21, 56, 0.1) 100%);
    --gradient-header: linear-gradient(180deg, #1C2536 0%, rgba(28, 37, 54, 0.95) 100%);

    /* üåë DARK NAVY BACKGROUND SYSTEM */
    --bg-primary: #1C2536;
    --bg-secondary: rgba(28, 37, 54, 0.95);
    --bg-tertiary: rgba(28, 37, 54, 0.9);
    --bg-hover: #1C2536;
    --bg-sidebar: #202123;
    --bg-sidebar-hover: #2a2b32;

    /* üìù LIGHT TEXT COLORS */
    --text-primary: #E5E7EB;
    --text-secondary: #D1D5DB;
    --text-tertiary: #9CA3AF;
    --text-muted: #6B7280;
    --text-inverse: #1C2536;

    /* üåü JUSTICE SHADOWS */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);
    --shadow-gold: 0 4px 12px rgba(196, 169, 98, 0.25);
    --shadow-maroon: 0 4px 12px rgba(139, 21, 56, 0.25);
    --shadow-hover: 0 8px 20px rgba(196, 169, 98, 0.2);

    /* üî≤ JUSTICE BORDERS */
    --border-light: 1px solid rgba(196, 169, 98, 0.2);
    --border-medium: 1px solid rgba(196, 169, 98, 0.3);
    --border-gold: 1px solid #C4A962;
    --border-maroon: 1px solid #8B1538;
    --border-dark: 1px solid rgba(196, 169, 98, 0.1);

    /* Legacy compatibility - Justice theme */
    --primary-accent: #C4A962;
    --primary-hover: #D4B972;
    --legal-teal: #C4A962;
    --legal-blue: #8B1538;
    --legal-light-teal: rgba(196, 169, 98, 0.1);
    --legal-gradient-teal: linear-gradient(135deg, #C4A962 0%, #8B1538 100%);
    --border-teal: 1px solid #C4A962;
    --glow-teal: 0 4px 12px rgba(196, 169, 98, 0.25);
}

/* ============================================================
   üåä PREMIUM KEYFRAME ANIMATIONS
   ============================================================ */

@keyframes gradientFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes borderRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes hoverLift {
    0% {
        transform: translateY(0);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    100% {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
}

@keyframes borderShine {
    0%, 100% {
        border-color: #C4A962;
    }
    50% {
        border-color: #8B1538;
    }
}

@keyframes neonPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOutLeft {
    from {
        opacity: 1;
        transform: translateX(0);
        max-height: 100px;
    }
    to {
        opacity: 0;
        transform: translateX(-20px);
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-bottom: 0;
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes typingDot {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
    }
    30% {
        transform: translateY(-12px);
        opacity: 1;
    }
}

@keyframes floatParticle {
    0% {
        transform: translateY(100vh) translateX(0) rotate(0deg);
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    90% {
        opacity: 1;
    }
    100% {
        transform: translateY(-100vh) translateX(100px) rotate(360deg);
        opacity: 0;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

@keyframes scaleIn {
    from { transform: scale(0); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

@keyframes buttonPress {
    0% { transform: scale(1); }
    50% { transform: scale(0.95); }
    100% { transform: scale(1); }
}

@keyframes subtleGlow {
    0%, 100% {
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    50% {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes typing {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
}

@keyframes floatOrb1 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -50px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
}

@keyframes floatOrb2 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(-40px, 30px) scale(1.05); }
    66% { transform: translate(25px, -25px) scale(0.95); }
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
    background: linear-gradient(135deg, #1C2536 0%, #0F1419 100%);
    color: var(--text-primary);
    min-height: 100vh;
    display: flex;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    position: relative;
    overflow-x: hidden;
}

/* Floating gradient orbs */
body::before {
    content: '';
    position: fixed;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(196, 169, 98, 0.15), transparent 70%);
    border-radius: 50%;
    top: -250px;
    right: -250px;
    filter: blur(100px);
    animation: floatOrb1 20s ease-in-out infinite;
    z-index: 0;
}

body::after {
    content: '';
    position: fixed;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(139, 21, 56, 0.15), transparent 70%);
    border-radius: 50%;
    bottom: -200px;
    left: -200px;
    filter: blur(100px);
    animation: floatOrb2 25s ease-in-out infinite;
    z-index: 0;
}

/* ============================================================
   TYPOGRAPHY - Premium Headings
   ============================================================ */

h1, h2, h3 {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    color: var(--justice-gold);
    text-shadow: 0 0 20px rgba(196, 169, 98, 0.3);
}

/* ============================================================
   SIDEBAR - Conversation History
   ============================================================ */

.sidebar {
    width: 260px;
    background: rgba(28, 37, 54, 0.98) !important;
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(196, 169, 98, 0.2);
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    position: relative;
    z-index: 10;
}

.sidebar.collapsed {
    transform: translateX(-280px);
}

.sidebar-header {
    padding: 1rem;
    border-bottom: var(--border-dark);
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--justice-gold);
    text-shadow: 0 0 20px rgba(196, 169, 98, 0.4);
    font-family: 'Righteous', cursive;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    letter-spacing: 0.5px;
}

.logo:hover {
    color: var(--justice-gold-bright);
    text-shadow: 0 0 30px rgba(196, 169, 98, 0.6);
    transition: all 0.3s ease;
}

.new-chat-btn {
    margin: 0.75rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, var(--justice-gold), var(--justice-maroon)) !important;
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(196, 169, 98, 0.3);
}

.new-chat-btn:hover {
    background: linear-gradient(135deg, var(--justice-gold-bright), var(--justice-maroon-bright)) !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(196, 169, 98, 0.4);
}

.conversations-list {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.conversation-item {
    padding: 0.75rem;
    background: transparent;
    border-radius: 8px;
    margin-bottom: 0.25rem;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
}

.conversation-item:hover {
    background: var(--bg-sidebar-hover);
    color: var(--text-inverse);
    transform: translateX(4px);
    box-shadow: var(--shadow-sm);
}

.conversation-item.active {
    background: var(--bg-sidebar-hover);
    color: var(--text-inverse);
    border-left: 3px solid var(--justice-gold);
    padding-left: calc(0.75rem - 3px);
}

.conversation-title {
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.conversation-date {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
}

/* Sidebar Footer & User Menu */
.sidebar-footer {
    margin-top: auto;
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    min-height: 80px; /* Ensure footer is always visible */
    z-index: 100; /* Above other sidebar content */
}

.user-menu-btn {
    width: 100%;
    padding: 0.875rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #FFFFFF;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
}

.user-menu-btn:hover {
    background: rgba(196, 169, 98, 0.15);
    border-color: var(--justice-gold);
    box-shadow: var(--shadow-gold);
    transform: translateY(-1px);
}

.user-menu-btn span {
    flex: 1;
    text-align: left;
}

.user-menu-btn .chevron {
    transition: transform 0.3s ease;
}

.user-menu-btn.active .chevron {
    transform: rotate(180deg);
}

.user-dropdown {
    position: absolute;
    bottom: 100%;
    left: 1rem;
    right: 1rem;
    background: rgba(28, 37, 54, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(196, 169, 98, 0.2);
    border-radius: 12px;
    margin-bottom: 0.5rem;
    box-shadow: var(--shadow-xl);
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition: all 0.3s ease;
}

.user-dropdown.active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
}

.user-dropdown-item {
    padding: 0.875rem 1rem;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    font-size: 0.9375rem;
}

.user-dropdown-item:first-child {
    border-radius: 12px 12px 0 0;
}

.user-dropdown-item:last-child {
    border-radius: 0 0 12px 12px;
}

.user-dropdown-item:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.user-dropdown-divider {
    height: 1px;
    background: var(--border-light);
    margin: 0.25rem 0;
}

/* ============================================================
   MAIN CHAT AREA
   ============================================================ */

.main-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 10;
}

/* Header */
.chat-header {
    padding: 1rem 2rem;
    background: transparent !important;
    border-bottom: 1px solid rgba(196, 169, 98, 0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sidebar-toggle {
    width: 36px;
    height: 36px;
    background: rgba(196, 169, 98, 0.15);
    border: 1px solid rgba(196, 169, 98, 0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
    color: var(--justice-gold);
}

.sidebar-toggle:hover {
    background: rgba(196, 169, 98, 0.25);
    border-color: var(--justice-gold);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(196, 169, 98, 0.3);
}

.chat-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--justice-gold);
    text-shadow: 0 0 20px rgba(196, 169, 98, 0.4);
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 0.5px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-btn {
    padding: 0.5rem 1rem;
    background: transparent;
    border: var(--border-gold);
    border-radius: 8px;
    color: var(--justice-gold);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.header-btn:hover {
    background: var(--gradient-subtle);
    transform: translateY(-2px);
    box-shadow: var(--shadow-gold);
    border-color: var(--justice-gold-bright);
}

/* Export/Share Button */
.export-btn-container {
    position: relative;
    display: inline-block;
}

/* Language Toggle Button */
.lang-toggle-btn {
    padding: 0.5rem 0.875rem;
    background: var(--bg-tertiary);
    border: var(--border-light);
    border-radius: 8px;
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-right: 0.75rem;
}

.lang-toggle-btn:hover {
    background: var(--bg-secondary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.lang-toggle-btn span {
    line-height: 1;
}

#langIcon {
    font-size: 1.25rem;
}

#langText {
    font-weight: 700;
    letter-spacing: 0.5px;
}

.export-btn {
    padding: 0.5rem 1rem;
    background: var(--gradient-primary);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: var(--shadow-base);
}

.export-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-gold);
}

.export-btn svg {
    width: 18px;
    height: 18px;
}

.export-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background: #FFFFFF;
    border: var(--border-light);
    border-radius: 12px;
    box-shadow: var(--shadow-xl);
    min-width: 200px;
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 1000;
}

.export-dropdown.active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
}

.export-dropdown-item {
    padding: 0.875rem 1rem;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    font-size: 0.9375rem;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
}

.export-dropdown-item:first-child {
    border-radius: 12px 12px 0 0;
}

.export-dropdown-item:last-child {
    border-radius: 0 0 12px 12px;
}

.export-dropdown-item:hover {
    background: var(--bg-secondary);
}

.export-dropdown-item svg {
    width: 20px;
    height: 20px;
    color: var(--justice-gold);
}

.export-dropdown-divider {
    height: 1px;
    background: var(--border-light);
    margin: 0.25rem 0;
}

/* Messages Container */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    padding-bottom: 180px;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
    scroll-behavior: smooth;
}

.messages-container::-webkit-scrollbar {
    width: 8px;
}

.messages-container::-webkit-scrollbar-track {
    background: transparent;
}

.messages-container::-webkit-scrollbar-thumb {
    background: var(--gradient-primary);
    border-radius: 10px;
    transition: all 0.3s ease;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--justice-gold-bright), var(--justice-maroon-bright));
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    padding: 4rem 2rem;
    animation: fadeIn 0.6s ease;
    background: transparent;
}

.welcome-section {
    text-align: center;
}

.welcome-icon {
    font-size: 6rem;
    margin-bottom: 1rem;
    animation: balanceScale 3s ease-in-out infinite;
    display: inline-block;
    /* Hukuki altƒ±n tonu - kanun kitaplarƒ±nda kullanƒ±lan klasik altƒ±n */
    background: linear-gradient(135deg, #B8860B 0%, #DAA520 50%, #B8860B 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

@keyframes balanceScale {
    0%, 100% {
        transform: rotate(-8deg);
    }
    50% {
        transform: rotate(8deg);
    }
}

.welcome-title {
    font-size: 2.5rem;
    font-weight: 800;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.75rem;
    letter-spacing: -0.5px;
}

.welcome-subtitle {
    font-size: 1.125rem;
    color: rgba(196, 169, 98, 0.8) !important;
    font-weight: 500;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.quick-actions {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.quick-action-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: transparent !important;
    border: 2px solid rgba(196, 169, 98, 0.3);
    padding: 1.5rem;
    border-radius: 12px;
}

.quick-action-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 8px 24px rgba(196, 169, 98, 0.2);
    background: transparent !important;
    border-color: var(--justice-gold);
}

.quick-action-card:hover .quick-action-icon {
    background: var(--gradient-primary);
    transform: scale(1.1) rotate(5deg);
    box-shadow: var(--shadow-gold);
}

.quick-action-icon {
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--justice-gold);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.quick-action-icon svg {
    width: 28px;
    height: 28px;
    stroke: white;
    stroke-width: 2.5;
}

.quick-action-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: rgba(196, 169, 98, 0.9) !important;
    text-align: center;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.quick-action-desc {
    display: none;
}

/* Message Bubbles */
.message {
    display: flex;
    gap: 1rem;
    animation: slideInUp 0.4s ease;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 0.5rem;
}

.message.user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
    box-shadow: var(--shadow-base);
    transition: all 0.3s ease;
}

.message.user .message-avatar {
    background: var(--gradient-primary);
    color: white;
}

.message.ai .message-avatar {
    background: var(--bg-sidebar);
    color: white;
}

.message-content {
    flex: 1;
    max-width: 70%;
}

.message.user .message-content {
    text-align: right;
}

.message-bubble {
    padding: 1rem 1.25rem;
    border-radius: 16px;
    font-size: 0.9375rem;
    line-height: 1.6;
    box-shadow: var(--shadow-base);
    transition: all 0.3s ease;
}

.message.user .message-bubble {
    background: var(--gradient-primary);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.ai .message-bubble {
    background: rgba(28, 37, 54, 0.7);
    backdrop-filter: blur(20px);
    color: var(--text-primary);
    border: 1px solid rgba(196, 169, 98, 0.2);
    border-bottom-left-radius: 4px;
}

.message.ai .message-bubble:hover {
    background: var(--bg-primary);
    box-shadow: var(--shadow-md);
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-top: 0.5rem;
}

/* Typing Indicator */
.typing-indicator {
    display: flex;
    gap: 0.25rem;
    padding: 0.75rem;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: var(--justice-gold);
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

/* ============================================================
   INPUT AREA (Fixed Bottom)
   ============================================================ */

.input-area {
    position: fixed;
    bottom: 0;
    left: 260px;
    right: 0;
    background: transparent !important;
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(196, 169, 98, 0.2);
    padding: 1.5rem;
    transition: all 0.3s ease;
    z-index: 20;
}

.sidebar.collapsed ~ .main-chat .input-area {
    left: 0;
}

.input-container {
    max-width: 900px;
    margin: 0 auto;
    position: relative;
}

.input-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 1rem;
    background: linear-gradient(135deg, rgba(28, 37, 54, 0.7), rgba(20, 25, 40, 0.8)) !important;
    backdrop-filter: blur(15px);
    border: 2px solid rgba(196, 169, 98, 0.6);
    border-radius: 20px;
    padding: 1.25rem 1.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(196, 169, 98, 0.2), inset 0 2px 4px rgba(196, 169, 98, 0.1);
}

.input-wrapper:focus-within {
    border-color: #C4A962;
    box-shadow: 0 0 0 3px rgba(196, 169, 98, 0.25), 0 8px 32px rgba(196, 169, 98, 0.4);
    transform: translateY(-2px);
    background: linear-gradient(135deg, rgba(28, 37, 54, 0.85), rgba(20, 25, 40, 0.9)) !important;
}

.message-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 1.05rem;
    font-family: inherit;
    resize: none;
    max-height: 200px;
    min-height: 24px;
    line-height: 1.5;
    color: #E5D4A6 !important;
    background: transparent !important;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

.message-input::placeholder {
    color: #C4A962 !important;
    font-weight: 500;
    opacity: 0.85;
    letter-spacing: 0.3px;
}

.input-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.input-btn {
    width: 40px;
    height: 40px;
    background: rgba(196, 169, 98, 0.15) !important;
    border: 1.5px solid rgba(196, 169, 98, 0.4) !important;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: #C4A962 !important;
}

.input-btn svg {
    width: 20px !important;
    height: 20px !important;
    color: #C4A962 !important;
    stroke: #C4A962 !important;
    stroke-width: 2.5 !important;
    fill: none !important;
    filter: drop-shadow(0 2px 4px rgba(196, 169, 98, 0.3));
}

.input-btn:hover {
    background: rgba(196, 169, 98, 0.3) !important;
    border-color: #C4A962 !important;
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(196, 169, 98, 0.4);
}

/* üé§ VOICE RECORDING ANIMATIONS */
#voiceBtn.recording {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    border-color: #ef4444 !important;
    animation: pulse-recording 1.5s ease-in-out infinite;
}

#voiceBtn.recording svg {
    color: white !important;
    stroke: white !important;
}

@keyframes pulse-recording {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
        transform: scale(1.05);
    }
}

#voiceBtn.processing {
    background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
    border-color: #3b82f6 !important;
    animation: spin-processing 1s linear infinite;
}

@keyframes spin-processing {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.send-btn {
    background: linear-gradient(135deg, var(--justice-gold), var(--justice-maroon)) !important;
    color: white;
    font-weight: 600;
    padding: 0 1.25rem;
    border-radius: 8px;
    height: 40px;
    border: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(196, 169, 98, 0.3);
}

.send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(196, 169, 98, 0.4);
}

.send-btn:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 4px 12px rgba(196, 169, 98, 0.3);
}

/* ============================================================
   MOBILE RESPONSIVE
   ============================================================ */

@media (max-width: 768px) {
    /* üì± Mobil: Sidebar ba≈ülangƒ±√ßta KAPALI */
    .sidebar {
        position: fixed;
        left: -280px; /* Kapalƒ± pozisyon */
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease-in-out;
    }

    /* Sidebar a√ßƒ±k durumu */
    .sidebar.mobile-open {
        left: 0;
        box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
    }

    /* Overlay (sidebar a√ßƒ±kken arka plan) */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }

    /* Sidebar toggle butonu mobilde her zaman g√∂r√ºns√ºn */
    .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 0.75rem;
        left: 0.75rem;
        z-index: 1001;
        background: var(--justice-gold);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        width: 44px;
        height: 44px;
    }

    .sidebar-toggle:hover {
        background: var(--justice-gold-bright);
        transform: scale(1.05);
    }

    /* Ana i√ßerik mobilde full width */
    .main-chat {
        margin-left: 0 !important;
    }

    .input-area {
        left: 0;
        padding: 1rem;
        width: 100%;
    }

    .messages-container {
        padding: 1rem;
        padding-bottom: 160px;
        padding-top: 70px; /* Hamburger menu i√ßin bo≈üluk */
    }

    .message-content {
        max-width: 85%;
    }

    .quick-actions {
        grid-template-columns: 1fr;
    }

    /* Header mobilde compact - toggle butonu i√ßin bo≈üluk */
    .chat-header {
        padding: 0.75rem 1rem 0.75rem 60px; /* Sol padding artƒ±rƒ±ldƒ± */
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .header-title {
        font-size: 1.1rem;
    }

    .chat-title {
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-mode-selector {
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
    }
}
    </style>

    <!-- Export Libraries - Using CDN.jsdelivr.net (CSP Compliant) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js">
// Mask sensitive API response data
function maskApiResponse(response) {
  if (response && typeof response === 'object') {
    // Mask model information
    if (response.model) response.model = 'ai-engine';
    if (response.engine) response.engine = 'ai-engine';
    if (response.provider) response.provider = 'ai-provider';

    // Mask headers
    if (response.headers) {
      delete response.headers['x-request-id'];
      delete response.headers['openai-'];
      delete response.headers['anthropic-'];
    }
  }
  return response;
}
</script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <!-- üì± Mobil Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar: Conversation History -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo" style="font-family: 'Inter', sans-serif !important; font-weight: 900 !important;">‚öñÔ∏è LyDian Hukuk</div>
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span data-i18n="newChat">New Chat</span>
        </button>

        <div class="conversations-list" id="conversationsList">
            <!-- Conversations will be loaded here -->
        </div>

        <!-- User Menu (Sidebar Footer) -->
        <div class="sidebar-footer">
            <button class="user-menu-btn" id="userMenuBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span data-i18n="userMenuAccount">My Account</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </button>
            <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-item" id="profileMenuItem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span data-i18n="menuProfile">My Profile</span>
                </div>
                <div class="user-dropdown-item" id="archiveMenuItem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8"/>
                        <rect x="1" y="3" width="22" height="5"/>
                        <line x1="10" y1="12" x2="14" y2="12"/>
                    </svg>
                    <span data-i18n="menuArchive">Archive</span>
                </div>
                <div class="user-dropdown-item" id="settingsMenuItem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
                    </svg>
                    <span data-i18n="menuSettings">Settings</span>
                </div>
                <div class="user-dropdown-divider"></div>
                <div class="user-dropdown-item" id="logoutMenuItem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span data-i18n="menuLogout">Logout</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 class="chat-title" data-i18n="legalAI">LyDian Legal AI</h1>
            </div>

            <div class="header-right">
                <!-- Language Toggle Button -->
                <button class="lang-toggle-btn" id="langToggle" onclick="toggleLanguage()" title="Change Language">
                    <span id="langIcon">üáπüá∑</span>
                    <span id="langText">TR</span>
                </button>

                <div class="export-btn-container">
                    <button class="export-btn" id="exportBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        <span data-i18n="exportShare">Export</span>
                    </button>
                    <div class="export-dropdown" id="exportDropdown">
                        <button class="export-dropdown-item" onclick="exportToPDF()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span data-i18n="exportPDF">Save as PDF</span>
                        </button>
                        <button class="export-dropdown-item" onclick="exportToDOCX()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <line x1="10" y1="9" x2="8" y2="9"></line>
                            </svg>
                            <span data-i18n="exportWord">Save as Word</span>
                        </button>
                        <button class="export-dropdown-item" onclick="exportToTXT()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            <span data-i18n="exportText">Save as Text</span>
                        </button>
                        <div class="export-dropdown-divider"></div>
                        <button class="export-dropdown-item" onclick="copyShareLink()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                            <span data-i18n="copyLink">Linki Kopyala</span>
                        </button>
                        <button class="export-dropdown-item" onclick="shareConversation()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                            <span data-i18n="share">Payla≈ü</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="welcome-section">
                    <div class="welcome-icon">‚öñÔ∏è</div>
                    <h2 class="welcome-title" data-i18n="welcomeTitle">Welcome to LyDian Legal AI</h2>
                    <p class="welcome-subtitle" data-i18n="welcomeSubtitle">AI-powered legal consultation for your legal questions</p>
                </div>

                <div class="quick-actions">
                    <div class="quick-action-card" data-action="law-search">
                        <div class="quick-action-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                        </div>
                        <div class="quick-action-title" data-i18n="quickActionLawSearch">Search Legal Articles</div>
                        <div class="quick-action-desc" data-i18n="quickActionLawSearchDesc">Access TMK, TCK, TTK, ƒ∞K articles</div>
                    </div>

                    <div class="quick-action-card" data-action="case-law">
                        <div class="quick-action-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                        </div>
                        <div class="quick-action-title" data-i18n="quickActionCaseLaw">Search Case Law</div>
                        <div class="quick-action-desc" data-i18n="quickActionCaseLawDesc">Supreme Court and Council of State decisions</div>
                    </div>

                    <div class="quick-action-card" data-action="contract">
                        <div class="quick-action-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="quick-action-title" data-i18n="quickActionContract">Contract Draft</div>
                        <div class="quick-action-desc" data-i18n="quickActionContractDesc">Create contracts quickly</div>
                    </div>

                    <div class="quick-action-card" data-action="precedent">
                        <div class="quick-action-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </div>
                        <div class="quick-action-title" data-i18n="quickActionPrecedent">Precedent Research</div>
                        <div class="quick-action-desc" data-i18n="quickActionPrecedentDesc">Browse similar cases</div>
                    </div>
                </div>
            </div>

            <!-- Messages will be appended here -->
        </div>

        <!-- Input Area (Fixed Bottom) -->
        <div class="input-area">
            <div class="input-container">
                <div class="input-wrapper">
                    <!-- Premium Legal AI Badge -->

                    <style>
                        @keyframes floatBadge {
                            0%, 100% { transform: translateX(-50%) translateY(0px); }
                            50% { transform: translateX(-50%) translateY(-5px); }
                        }
                        @keyframes pulse {
                            0%, 100% { opacity: 1; transform: scale(1); }
                            50% { opacity: 0.5; transform: scale(1.2); }
                        }
                    </style>

                    <textarea
                        class="message-input"
                        id="messageInput"
                        placeholder="Type your legal question..."
                        data-i18n-placeholder="inputPlaceholder"
                        rows="1"
                    ></textarea>

                    <div class="input-actions">
                        <!-- Image Upload -->
                        <button class="input-btn" id="imageBtn" title="G√∂rsel Y√ºkle">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </button>
                        <input type="file" id="imageUpload" accept="image/*,.pdf,.doc,.docx" style="display:none">

                        <!-- Document Upload -->
                        <button class="input-btn" id="documentBtn" title="Dok√ºman Y√ºkle">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <line x1="10" y1="9" x2="8" y2="9"/>
                            </svg>
                        </button>
                        <input type="file" id="documentUpload" accept=".pdf,.doc,.docx" style="display:none">

                        <!-- Voice Input -->
                        <button class="input-btn" id="voiceBtn" title="Sesli Kayƒ±t">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                        </button>

                        <button class="send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// ============================================================
// üèõÔ∏è LYDIAN HUKUK AI - CHAT LOGIC
// ============================================================

// üåç MULTI-LANGUAGE TRANSLATION SYSTEM
let translations = {};
// ‚ö†Ô∏è Fƒ∞X: Her zaman T√ºrk√ße ba≈üla, localStorage temizle
localStorage.removeItem('lydian-legal-lang'); // Clear old language setting
let currentLang = 'tr'; // ALWAYS start in Turkish

// Load translation file
async function loadTranslations() {
    try {
        const response = await fetch('/i18n/legal-translations.json');
        translations = await response.json();
        console.log('‚úÖ √áeviri dosyasƒ± y√ºklendi, T√ºrk√ße aktif');
        applyTranslations();
    } catch (error) {
        console.warn('‚ö†Ô∏è √áeviri dosyasƒ± y√ºklenemedi:', error);
        translations = { tr: {} }; // Fallback
    }
}

// Get translated text
function t(key) {
    return translations[currentLang]?.[key] || translations['tr']?.[key] || key;
}

// Apply translations to page
function applyTranslations() {
    document.getElementById('htmlRoot').lang = currentLang;
    document.title = t('pageTitle');

    // Update placeholder
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.placeholder = t('searchPlaceholder') || 'Hukuki sorunuzu yazƒ±n...';
    }

    // üåç AUTO-TRANSLATE ALL ELEMENTS WITH data-i18n (EXCEPT DROPDOWN ITEMS)
    // ‚úÖ DROPDOWN ELEMENTLERƒ∞Nƒ∞ ATLA - DOM manip√ºlasyonu yapma
    const userDropdownElement = document.getElementById('userDropdown');

    document.querySelectorAll('[data-i18n]').forEach(element => {
        // ‚ö†Ô∏è SKIP: User dropdown i√ßindeki elementleri atla
        if (userDropdownElement && userDropdownElement.contains(element)) {
            return; // Dropdown i√ßi - √ßevirme!
        }

        const key = element.getAttribute('data-i18n');
        const translatedText = t(key);

        if (translatedText && translatedText !== key) {
            // SADECE textContent g√ºncelle - innerHTML, classList, attributes DOKUNma
            if (element.children.length === 0) {
                // √áocuƒüu yok - direkt √ßevir
                element.textContent = translatedText;
            } else {
                // √áocuƒüu var - sadece ilk text node'u bul ve onu deƒüi≈ütir
                for (let node of element.childNodes) {
                    if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                        node.textContent = translatedText;
                        break; // Sadece ilk text node
                    }
                }
            }
        }
    });

    // ‚úÖ DROPDOWN ƒ∞√áƒ∞Nƒ∞ AYRICA √áEVƒ∞R (DOM manip√ºlasyonu yapmadan)
    if (userDropdownElement) {
        userDropdownElement.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            const translatedText = t(key);
            if (translatedText && translatedText !== key && element.children.length === 0) {
                element.textContent = translatedText;
            }
        });
    }

    console.log(`‚úÖ Dil deƒüi≈ütirildi: ${currentLang}`);
    // ‚úÖ UPDATE LANGUAGE BUTTON
    const langIcon = document.getElementById('langIcon');
    const langText = document.getElementById('langText');
    if (langIcon && langText) {
        if (currentLang === 'tr') {
            langIcon.textContent = 'üáπüá∑';
            langText.textContent = 'TR';
        } else {
            langIcon.textContent = 'üá¨üáß';
            langText.textContent = 'EN';
        }
    }

}

// Change language function - KESIN K√ñKTEN √á√ñZ√úM - V4 (User Dropdown Fix)
function changeLanguage(lang, event) {
    // √ñNCE t√ºm event propagation'u durdur
    if (event) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
    }

    currentLang = lang;
    localStorage.setItem('lydian-legal-lang', lang);

    console.log(`üåç Dil deƒüi≈ütiriliyor: ${lang}`);

    // ‚úÖ K√ñKTEN FIX: Hem modal hem user dropdown durumunu kaydet
    const settingsModal = document.getElementById('settingsModal');
    const userDropdown = document.getElementById('userDropdown');
    const userMenuBtn = document.getElementById('userMenuBtn');

    const wasModalOpen = settingsModal !== null;
    const wasUserDropdownActive = userDropdown?.classList.contains('active') || false;
    const wasUserBtnActive = userMenuBtn?.classList.contains('active') || false;

    console.log(`üìã √ñNCE - Modal: ${wasModalOpen ? 'A√áIK' : 'KAPALI'}, User Dropdown: ${wasUserDropdownActive ? 'A√áIK' : 'KAPALI'}`);

    // √áevirileri uygula
    applyTranslations();

    // Language selector'ƒ± g√ºncelle WITHOUT triggering onChange
    const settingsLanguage = document.getElementById('settingsLanguage');
    if (settingsLanguage && settingsLanguage.value !== lang) {
        const originalOnChange = settingsLanguage.onchange;
        settingsLanguage.onchange = null;
        settingsLanguage.value = lang;
        settingsLanguage.onchange = originalOnChange;
    }

    // ‚úÖ RESTORE: Settings Modal
    const modalAfter = document.getElementById('settingsModal');
    if (wasModalOpen && modalAfter) {
        modalAfter.style.display = 'flex';
        modalAfter.style.visibility = 'visible';
        modalAfter.style.opacity = '1';
        modalAfter.style.pointerEvents = 'auto';
    }

    // ‚úÖ RESTORE: User Dropdown (DOUBLE FIX - Immediate + Delayed)
    // Immediate restore (hemen)
    const userDropdownImmediate = document.getElementById('userDropdown');
    const userMenuBtnImmediate = document.getElementById('userMenuBtn');

    if (wasUserDropdownActive && userDropdownImmediate) {
        userDropdownImmediate.classList.add('active');
    }
    if (wasUserBtnActive && userMenuBtnImmediate) {
        userMenuBtnImmediate.classList.add('active');
    }

    // Delayed restore (DOM manipulation tamamlandƒ±ktan sonra tekrar)
    setTimeout(() => {
        const userDropdownAfter = document.getElementById('userDropdown');
        const userMenuBtnAfter = document.getElementById('userMenuBtn');

        if (wasUserDropdownActive && userDropdownAfter) {
            userDropdownAfter.classList.add('active');
            console.log(`‚úÖ User dropdown RESTORED (delayed) - active class eklendi`);
        }
        if (wasUserBtnActive && userMenuBtnAfter) {
            userMenuBtnAfter.classList.add('active');
            console.log(`‚úÖ User menu button RESTORED (delayed) - active class eklendi`);
        }
    }, 150);

    console.log(`‚úÖ Dil deƒüi≈ütirildi: ${lang} - T√ºm UI durumu korundu`);

    return false;
}

// Toggle language function for button click
function toggleLanguage() {
    const newLang = currentLang === 'tr' ? 'en' : 'tr';
    changeLanguage(newLang);
}

// üóëÔ∏è DEPRECATED: reattachDropdownListeners() artƒ±k gerekli deƒüil
// Dropdown/modal i√ßi artƒ±k √ßevrilmiyor, bu y√ºzden event listener'lar bozulmuyor
// Eski kod kaldƒ±rƒ±ldƒ± - K√ñKTEN √á√ñZ√úM uygulandƒ± ‚úÖ

// State Management
const state = {
    conversations: [],
    currentConversationId: null,
    messages: [],
    user: null
};

// DOM Elements
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const newChatBtn = document.getElementById('newChatBtn');
const conversationsList = document.getElementById('conversationsList');
const messagesContainer = document.getElementById('messagesContainer');
const emptyState = document.getElementById('emptyState');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await loadTranslations(); // üåç Load translations first
    loadUserData();
    loadConversations();
    setupEventListeners();
    console.log('‚úÖ LyDian Hukuk AI Chat Y√ºklendi');
    console.log(`üåç Active Language: ${currentLang}`);
});

// üì± Window resize handler - mobil/desktop ge√ßi≈ülerini y√∂net
window.addEventListener('resize', () => {
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    // Desktop'a ge√ßildiƒüinde mobil sƒ±nƒ±flarƒ±nƒ± temizle
    if (window.innerWidth > 768) {
        sidebar.classList.remove('mobile-open');
        sidebarOverlay.classList.remove('active');
    }
});

// Event Listeners
function setupEventListeners() {
    // Sidebar Toggle (Mobil uyumlu)
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    sidebarToggle.addEventListener('click', () => {
        // Mobil ekranlarda (768px altƒ±)
        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('mobile-open');
            sidebarOverlay.classList.toggle('active');
        } else {
            // Desktop'ta normal collapse
            sidebar.classList.toggle('collapsed');
        }
    });

    // Overlay'e tƒ±klandƒ±ƒüƒ±nda sidebar'ƒ± kapat (mobil)
    sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.remove('mobile-open');
        sidebarOverlay.classList.remove('active');
    });

    // New Chat
    newChatBtn.addEventListener('click', startNewConversation);

    // Send Message
    sendBtn.addEventListener('click', sendMessage);

    // Enter to send (Shift+Enter for new line)
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = messageInput.scrollHeight + 'px';
    });

    // Quick Actions
    document.querySelectorAll('.quick-action-card').forEach(card => {
        card.addEventListener('click', () => {
            const action = card.dataset.action;
            handleQuickAction(action);
        });
    });

    // User Menu Toggle
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');

    userMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        userMenuBtn.classList.toggle('active');
        userDropdown.classList.toggle('active');
    });

    // Close user menu when clicking outside
    document.addEventListener('click', (e) => {
        const settingsModal = document.getElementById('settingsModal');
        const isModalOpen = settingsModal && settingsModal.style.display === 'flex';

        // ‚úÖ FIX: Dropdown dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat, i√ßine tƒ±klandƒ±ƒüƒ±nda a√ßƒ±k bƒ±rak
        if (!isModalOpen && !userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
            userMenuBtn.classList.remove('active');
            userDropdown.classList.remove('active');
        }
    });

    // User Menu Items
    document.getElementById('profileMenuItem')?.addEventListener('click', () => {
        showProfileModal();
    });

    document.getElementById('archiveMenuItem')?.addEventListener('click', showArchive);

    document.getElementById('settingsMenuItem')?.addEventListener('click', () => {
        showSettingsModal();
    });

    document.getElementById('logoutMenuItem')?.addEventListener('click', () => {
        if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?')) {
            localStorage.removeItem('legalAI_user');
            localStorage.removeItem('legalAI_conversations');
            localStorage.removeItem('legalAI_archive');
            window.location.href = '/';
        }
    });

    // Image Upload Handler
    document.getElementById('imageBtn')?.addEventListener('click', () => {
        document.getElementById('imageUpload').click();
    });

    document.getElementById('imageUpload')?.addEventListener('change', handleImageUpload);

    // Document Upload Handler
    document.getElementById('documentBtn')?.addEventListener('click', () => {
        document.getElementById('documentUpload').click();
    });

    document.getElementById('documentUpload')?.addEventListener('change', handleDocumentUpload);

    // Voice Recording Handler
    document.getElementById('voiceBtn')?.addEventListener('click', handleVoiceInput);
}

// Show Archive
function showArchive() {
    const archive = JSON.parse(localStorage.getItem('legalAI_archive') || '[]');

    if (archive.length === 0) {
        alert('Ar≈üivinizde hen√ºz kayƒ±t bulunmuyor.');
        return;
    }

    let archiveHTML = `
        <div id="archiveModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem;">
            <div style="background: var(--bg-primary); border-radius: 16px; max-width: 900px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 32px; box-shadow: var(--shadow-xl);" onclick="event.stopPropagation()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: var(--border-light);">
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        Ar≈üiv (${archive.length} kayƒ±t)
                    </h2>
                    <button onclick="closeArchiveModal()" style="width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; font-size: 20px; color: var(--text-secondary); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div style="display: flex; flex-direction: column; gap: 16px;">
    `;

    archive.forEach((item, index) => {
        archiveHTML += `
            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: var(--border-light); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                <div style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 12px; display: flex; align-items: center;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    ${item.date}
                </div>
                <div style="font-weight: 600; color: var(--primary-accent); margin-bottom: 8px; font-size: 14px;">Soru:</div>
                <div style="margin-bottom: 16px; color: var(--text-primary); line-height: 1.6;">${escapeHtml(item.question)}</div>
                <div style="font-weight: 600; color: var(--primary-accent); margin-bottom: 8px; font-size: 14px;">Cevap:</div>
                <div style="color: var(--text-secondary); line-height: 1.6;">${escapeHtml(item.answer.substring(0, 300))}${item.answer.length > 300 ? '...' : ''}</div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: var(--border-light); font-size: 12px; color: var(--text-tertiary);">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="9" y1="9" x2="15" y2="9"/>
                        <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                    LyDian AI
                </div>
            </div>
        `;
    });

    archiveHTML += `
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', archiveHTML);
}

function closeArchiveModal() {
    const modal = document.getElementById('archiveModal');
    if (modal) {
        modal.remove();
    }
}

// Load User Data
function loadUserData() {
    const userData = localStorage.getItem('legalAI_user');
    if (userData) {
        state.user = JSON.parse(userData);
    }
}

// Load Conversations
function loadConversations() {
    const saved = localStorage.getItem('legalAI_conversations');
    if (saved) {
        state.conversations = JSON.parse(saved);
        renderConversations();
    }
}

// Save Conversations
function saveConversations() {
    localStorage.setItem('legalAI_conversations', JSON.stringify(state.conversations));
}

// Render Conversations
function renderConversations() {
    conversationsList.innerHTML = state.conversations.map(conv => `
        <div class="conversation-item ${conv.id === state.currentConversationId ? 'active' : ''}"
             data-id="${conv.id}">
            <div class="conversation-title">${conv.title}</div>
            <div class="conversation-date">${formatDate(conv.date)}</div>
        </div>
    `).join('');

    // Add click handlers
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', () => {
            loadConversation(item.dataset.id);
        });
    });
}

// Start New Conversation
function startNewConversation() {
    const newConv = {
        id: Date.now().toString(),
        title: 'Yeni Sohbet',
        date: new Date().toISOString(),
        messages: []
    };

    state.conversations.unshift(newConv);
    state.currentConversationId = newConv.id;
    state.messages = [];

    saveConversations();
    renderConversations();
    renderMessages();

    // üì± Mobilde sidebar'ƒ± kapat
    if (window.innerWidth <= 768) {
        sidebar.classList.remove('mobile-open');
        document.getElementById('sidebarOverlay').classList.remove('active');
    }
}

// Load Conversation
function loadConversation(id) {
    // üì± Mobilde sidebar'ƒ± kapat
    if (window.innerWidth <= 768) {
        sidebar.classList.remove('mobile-open');
        document.getElementById('sidebarOverlay').classList.remove('active');
    }

    const conv = state.conversations.find(c => c.id === id);
    if (conv) {
        state.currentConversationId = id;
        state.messages = conv.messages || [];
        renderMessages();
        renderConversations();
    }
}

// Send Message
async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    // Create conversation if needed
    if (!state.currentConversationId) {
        startNewConversation();
    }

    // Add user message
    const userMessage = {
        id: Date.now().toString(),
        role: 'user',
        content: text,
        timestamp: new Date().toISOString()
    };

    state.messages.push(userMessage);
    saveCurrentConversation();
    renderMessages();
    messageInput.value = '';
    messageInput.style.height = 'auto';

    // Show typing indicator
    showTypingIndicator();

    // Get user settings
    const settings = JSON.parse(localStorage.getItem('legalAI_settings') || '{}');
    const aiModel = settings.aiModel || 'premium-model-1'; // Enterprise AI model
    const temperature = settings.temperature || 0.7;
    const maxTokens = settings.maxTokens || 4096;

    // üóÑÔ∏è KNOWLEDGE GRAPH ENHANCEMENT - Multi-Language Legal Article Detection
    let knowledgeContext = '';

    // üåç Global Legal Systems Pattern Matching
    const legalPatterns = {
        // üáπüá∑ T√ºrk Hukuk Sistemi
        turkish: /(TCK|BK|CMK|HMK|ƒ∞ƒ∞K|Aƒ∞HM|TMK|ƒ∞YUK|ƒ∞cra ƒ∞flas|4857|5237|6098|6100|6102)\s*(\d+)/gi,

        // üá∫üá∏ US Law
        us: /(U\.S\.C\.|USC|CFR|Federal Register)\s*(\d+)|(\d+)\s*(U\.S\.|U\.S|USC)/gi,

        // üá¨üáß UK Law
        uk: /(Act|Statute|SI|Statutory Instrument)\s*(\d{4})|(\d{4})\s*(Act)/gi,

        // üá©üá™ Deutsches Recht
        german: /(BGB|StGB|ZPO|HGB|GG|AO|EStG)\s*¬ß\s*(\d+)|¬ß\s*(\d+)\s*(BGB|StGB|ZPO)/gi,

        // üá´üá∑ Droit fran√ßais
        french: /(Code civil|Code p√©nal|Code de commerce)\s*(Article|Art\.)\s*(\d+)|Art\.\s*(\d+)/gi,

        // üá™üá∏ Derecho espa√±ol
        spanish: /(C√≥digo Civil|C√≥digo Penal|CP|CC)\s*(Art√≠culo|Art\.)\s*(\d+)/gi,

        // üáÆüáπ Diritto italiano
        italian: /(Codice Civile|Codice Penale|C\.C\.|C\.P\.)\s*(Articolo|Art\.)\s*(\d+)/gi,

        // üá®üá≥ ‰∏≠ÂõΩÊ≥ïÂæã (Chinese Law)
        chinese: /(ÂàëÊ≥ï|Ê∞ëÊ≥ïÂÖ∏|ÂêàÂêåÊ≥ï|ÂÖ¨Âè∏Ê≥ï)\s*Á¨¨\s*(\d+)\s*Êù°/gi,

        // üáØüáµ Êó•Êú¨Ê≥ï (Japanese Law)
        japanese: /(Ê∞ëÊ≥ï|ÂàëÊ≥ï|ÂïÜÊ≥ï|‰ºöÁ§æÊ≥ï)\s*Á¨¨\s*(\d+)\s*Êù°/gi,

        // üá∏üá¶ ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ≥ÿπŸàÿØŸä (Saudi Law)
        arabic: /(ŸÜÿ∏ÿßŸÖ|ŸÇÿßŸÜŸàŸÜ)\s*(ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑŸÖÿØŸÜŸäÿ©|ÿßŸÑÿ¨ÿ≤ÿßÿ¶Ÿä|ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä)\s*(ÿßŸÑŸÖÿßÿØÿ©|ŸÖ\.)\s*(\d+)/gi
    };

    // Detect all legal articles across all languages
    const matches = [];
    for (const [lang, pattern] of Object.entries(legalPatterns)) {
        const langMatches = [...text.matchAll(pattern)];
        langMatches.forEach(match => {
            matches.push({ lang, match });
        });
    }

    if (matches.length > 0) {
        try {
            for (const matchObj of matches) {
                const article = matchObj.match[0].replace(/\s+/g, ' '); // Normalize spacing
                const lang = matchObj.lang;

                // Neo4j'den emsal davalarƒ± getir (multi-language support)
                const kgResponse = await fetch(`/api/knowledge-graph/precedents/${encodeURIComponent(article)}`);
                const kgData = await kgResponse.json();

                if (kgData.success && kgData.precedents && kgData.precedents.length > 0) {
                    // Language-specific context headers
                    const contextHeaders = {
                        turkish: 'üìã ƒ∞lgili Emsal Kararlar:',
                        us: 'üìã Relevant Precedents:',
                        uk: 'üìã Relevant Case Law:',
                        german: 'üìã Relevante Pr√§zedenzf√§lle:',
                        french: 'üìã Jurisprudence pertinente:',
                        spanish: 'üìã Jurisprudencia relevante:',
                        italian: 'üìã Giurisprudenza pertinente:',
                        chinese: 'üìã Áõ∏ÂÖ≥Âà§‰æã:',
                        japanese: 'üìã Èñ¢ÈÄ£Âà§‰æã:',
                        arabic: 'üìã ÿßŸÑÿ≥Ÿàÿßÿ®ŸÇ ÿßŸÑŸÇÿ∂ÿßÿ¶Ÿäÿ© ÿ∞ÿßÿ™ ÿßŸÑÿµŸÑÿ©:'
                    };

                    knowledgeContext += `\n\n${contextHeaders[lang] || 'üìã Precedents:'} ${article}\n`;

                    kgData.precedents.slice(0, 3).forEach((p, idx) => {
                        knowledgeContext += `${idx + 1}. ${p.karar_no} (${p.mahkeme}, ${p.tarih})\n`;
                        knowledgeContext += `   ${lang === 'turkish' ? 'Sonu√ß' : 'Result'}: ${p.sonuc}\n`;
                        knowledgeContext += `   ${lang === 'turkish' ? '√ñzet' : 'Summary'}: ${p.ozet}\n\n`;
                    });
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Knowledge Graph access error:', error.message);
            // Continue without Knowledge Graph context
        }
    }

    // Call AI Chat API with Azure power + Real Legal Database
    try {
        // üåç Language-specific system prompts
        const systemPrompts = {
            tr: `Sen T√ºrk hukuku konusunda uzman bir yapay zeka asistanƒ±sƒ±n. T√ºrkiye Cumhuriyeti yasalarƒ±nƒ±, Yargƒ±tay ve Danƒ±≈ütay i√ßtihatlarƒ±nƒ± bilen ve doƒüru hukuki danƒ±≈ümanlƒ±k sunan bir AI'sƒ±n. Azure AI g√º√ßl√º altyapƒ±sƒ± ile √ßalƒ±≈üƒ±yorsun.${knowledgeContext ? `\n\nüìö Emsal ƒ∞√ßtihat Veritabanƒ± (Neo4j):\n${knowledgeContext}` : ''}`,
            en: `You are an expert AI legal assistant. You provide accurate legal consultation based on Turkish Republic laws, Supreme Court (Yargƒ±tay) and Council of State (Danƒ±≈ütay) precedents. Powered by Azure AI infrastructure.${knowledgeContext ? `\n\nüìö Legal Precedents Database (Neo4j):\n${knowledgeContext}` : ''}`,
            de: `Sie sind ein KI-Rechtsexperte. Sie bieten genaue Rechtsberatung basierend auf den Gesetzen der T√ºrkischen Republik und relevanten Pr√§zedenzf√§llen. Angetrieben von Azure AI.${knowledgeContext ? `\n\nüìö Rechtsdatenbank (Neo4j):\n${knowledgeContext}` : ''}`,
            fr: `Vous √™tes un assistant juridique IA expert. Vous fournissez des conseils juridiques pr√©cis bas√©s sur les lois de la R√©publique turque et les pr√©c√©dents pertinents. Aliment√© par Azure AI.${knowledgeContext ? `\n\nüìö Base de donn√©es juridique (Neo4j):\n${knowledgeContext}` : ''}`,
            es: `Eres un asistente legal de IA experto. Proporcionas consultas legales precisas basadas en las leyes de la Rep√∫blica Turca y precedentes relevantes. Impulsado por Azure AI.${knowledgeContext ? `\n\nüìö Base de datos legal (Neo4j):\n${knowledgeContext}` : ''}`
        };

        const systemPrompt = systemPrompts[currentLang] || systemPrompts['en'];

        // ‚úÖ Use real legal AI endpoint with security
        const response = await fetch('/api/legal-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Language': currentLang || 'en'
            },
            body: JSON.stringify({
                message: text,
                language: currentLang || 'en',
                systemPrompt: systemPrompt,
                knowledgeContext: knowledgeContext,
                settings: {
                    engine: aiModel,
                    temperature: temperature,
                    maxTokens: maxTokens
                }
            })
        });

        const data = await response.json();

        // Hide typing indicator
        hideTypingIndicator();

        if (data.success && data.response) {
            // Add AI message (clean response without model badge)
            const aiMessage = {
                id: (Date.now() + 1).toString(),
                role: 'ai',
                content: data.response, // Clean response from backend
                timestamp: new Date().toISOString()
            };

            state.messages.push(aiMessage);

            // Update conversation title if first message
            const conv = state.conversations.find(c => c.id === state.currentConversationId);
            if (conv && conv.title === 'Yeni Sohbet') {
                conv.title = text.substring(0, 40) + (text.length > 40 ? '...' : '');
            }

            saveCurrentConversation();
            renderMessages();
            renderConversations();

            // Save to archive
            saveToArchive(text, data.response, data.model || 'AI');
        } else {
            throw new Error(data.error || 'API yanƒ±t vermedi');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('‚ùå Hata:', error);
        alert('Bir hata olu≈ütu: ' + error.message);
    }
}

// Save Current Conversation
function saveCurrentConversation() {
    const conv = state.conversations.find(c => c.id === state.currentConversationId);
    if (conv) {
        conv.messages = state.messages;
        conv.date = new Date().toISOString();
        saveConversations();
    }
}

// Render Messages
function renderMessages() {
    if (state.messages.length === 0) {
        emptyState.style.display = 'flex';
        return;
    }

    emptyState.style.display = 'none';

    const messagesHTML = state.messages.map((msg, index) => {
        const isUser = msg.role === 'user';
        const time = formatTime(msg.timestamp);

        // Clean AI response from any model badges or technical headers
        let cleanContent = msg.content;
        if (!isUser) {
            // Remove "‚ú® **Azure Advanced AI Turbo Yanƒ±tƒ±**" and similar patterns
            cleanContent = cleanContent
                .replace(/‚ú®\s*\*\*Azure\s+GPT[^*]*\*\*/gi, '')
                .replace(/‚ú®\s*\*\*.*?Turbo.*?Yanƒ±t[^*]*\*\*/gi, '')
                .replace(/^\s*[\n\r]+/, '') // Remove leading newlines
                .trim();
        }

        const avatarHTML = isUser ? `
            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
        ` : `
            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #C4A962 0%, #D4B972 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(196, 169, 98, 0.3);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
            </div>
        `;

        return `
            <div class="message ${msg.role}" style="position: relative; display: flex; gap: 12px; align-items: flex-start; margin-bottom: 20px;">
                ${avatarHTML}
                <div class="message-content" style="flex: 1;">
                    <div class="message-bubble" style="position: relative; padding: 12px 16px; border-radius: 12px; background: ${isUser ? 'var(--primary-accent)' : 'var(--bg-secondary)'}; color: ${isUser ? '#ffffff' : 'var(--text-primary)'};">
                        ${escapeHtml(cleanContent)}
                    </div>
                    <div class="message-time" style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">${time}</div>
                </div>
                <button onclick="deleteMessage(${index})" style="opacity: 0; transition: opacity 0.2s; width: 28px; height: 28px; border: none; background: var(--gray-100); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);" onmouseover="this.style.background='#fee2e2'; this.style.color='#dc2626'" onmouseout="this.style.background='var(--gray-100)'; this.style.color='var(--text-secondary)'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
            </div>
        `;
    }).join('');

    // Keep empty state, append messages after it
    const existingMessages = messagesContainer.querySelectorAll('.message');
    existingMessages.forEach(m => m.remove());

    messagesContainer.insertAdjacentHTML('beforeend', messagesHTML);

    // Add hover effect to show delete buttons
    const messages = messagesContainer.querySelectorAll('.message');
    messages.forEach(message => {
        const deleteBtn = message.querySelector('button');
        if (deleteBtn) {
            message.addEventListener('mouseenter', () => {
                deleteBtn.style.opacity = '1';
            });
            message.addEventListener('mouseleave', () => {
                deleteBtn.style.opacity = '0';
            });
        }
    });

    scrollToBottom();
}

// Delete Message Function
function deleteMessage(index) {
    if (confirm('Bu mesajƒ± silmek istediƒüinize emin misiniz?')) {
        state.messages.splice(index, 1);
        saveCurrentConversation();
        renderMessages();
    }
}

// Show Typing Indicator
function showTypingIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'message ai';
    indicator.innerHTML = `
        <div class="message-avatar">‚öñÔ∏è</div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    `;
    messagesContainer.appendChild(indicator);
    scrollToBottom();
}

// Hide Typing Indicator
function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// Quick Actions
function handleQuickAction(action) {
    // ‚úÖ Multi-language quick action prompts
    const promptsMap = {
        tr: {
            'law-search': 'T√ºrk Medeni Kanunu madde 185 hakkƒ±nda bilgi verir misin?',
            'case-law': 'Yargƒ±tay 2. Hukuk Dairesi bo≈üanma davasƒ± i√ßtihatlarƒ±nƒ± g√∂ster',
            'contract': 'Basit bir kira s√∂zle≈ümesi taslaƒüƒ± hazƒ±rla',
            'precedent': 'ƒ∞≈ü kazasƒ± tazminat davalarƒ± i√ßin emsal kararlar neler?'
        },
        en: {
            'law-search': 'Can you provide information about Article 185 of Turkish Civil Code?',
            'case-law': 'Show me Supreme Court 2nd Civil Chamber divorce case precedents',
            'contract': 'Draft a simple rental agreement',
            'precedent': 'What are the precedent cases for workplace accident compensation lawsuits?'
        }
    };

    const prompts = promptsMap[currentLang] || promptsMap.tr;
    const prompt = prompts[action];
    if (prompt) {
        messageInput.value = prompt;
        messageInput.focus();
    }
}

// Save to Archive
function saveToArchive(question, answer, model) {
    try {
        const archive = JSON.parse(localStorage.getItem('legalAI_archive') || '[]');
        const entry = {
            id: Date.now(),
            question,
            answer,
            model,
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleString('tr-TR')
        };
        archive.unshift(entry);
        if (archive.length > 100) archive.length = 100;
        localStorage.setItem('legalAI_archive', JSON.stringify(archive));
    } catch (error) {
        console.error('‚ùå Ar≈üiv hatasƒ±:', error);
    }
}

// Utilities
function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;

    if (diff < 86400000) return 'Bug√ºn';
    if (diff < 172800000) return 'D√ºn';
    return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
}

function formatTime(dateStr) {
    return new Date(dateStr).toLocaleTimeString('tr-TR', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

function scrollToBottom() {
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
}

// ============================================================
// üé§ AZURE SPEECH-TO-TEXT INTEGRATION
// ============================================================

let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];

async function handleVoiceInput() {
    const voiceBtn = document.getElementById('voiceBtn');

    if (!isRecording) {
        // Start recording
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });

            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                // Show processing state
                voiceBtn.classList.remove('recording');
                voiceBtn.classList.add('processing');
                voiceBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                `;

                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                await transcribeAudio(audioBlob);

                // Reset button after processing
                voiceBtn.classList.remove('processing');
                voiceBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                `;

                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            isRecording = true;

            // Visual feedback with animation
            voiceBtn.classList.add('recording');
            voiceBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                </svg>
            `;

            console.log('üé§ Ses kaydƒ± ba≈üladƒ±... (T√ºrk√ße hukuk terimleri aktif)');
        } catch (error) {
            console.error('‚ùå Mikrofon eri≈üim hatasƒ±:', error);
            let errorMsg = 'Mikrofon eri≈üimi reddedildi. ';
            if (error.name === 'NotAllowedError') {
                errorMsg += 'L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan mikrofon izni verin.';
            } else if (error.name === 'NotFoundError') {
                errorMsg += 'Mikrofon bulunamadƒ±. L√ºtfen bir mikrofon baƒülayƒ±n.';
            } else {
                errorMsg += error.message;
            }
            alert(errorMsg);
        }
    } else {
        // Stop recording
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            isRecording = false;

            // Remove recording animation
            voiceBtn.classList.remove('recording');

            console.log('üé§ Ses kaydƒ± durdu, hukuki transkript i≈üleniyor...');
        }
    }
}

async function transcribeAudio(audioBlob) {
    try {
        showTypingIndicator();

        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        formData.append('language', 'tr-TR'); // Turkish legal language support

        // üèõÔ∏è LEGAL-SPECIFIC SPEECH-TO-TEXT API
        const response = await fetch('/api/speech/transcribe-legal', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        hideTypingIndicator();

        if (data.success && data.text) {
            messageInput.value = data.text;
            messageInput.focus();

            // Show legal entities found (if any)
            if (data.legalEntities) {
                const { legalTerms, caseTypes, courts } = data.legalEntities;
                const foundTerms = [];

                if (legalTerms?.length > 0) foundTerms.push(`Hukuki terimler: ${legalTerms.join(', ')}`);
                if (caseTypes?.length > 0) foundTerms.push(`Dava t√ºrleri: ${caseTypes.join(', ')}`);
                if (courts?.length > 0) foundTerms.push(`Mahkemeler: ${courts.join(', ')}`);

                if (foundTerms.length > 0) {
                    console.log('üîç Tespit edilen hukuki kavramlar:', foundTerms.join(' | '));
                }
            }

            console.log('‚úÖ Hukuki transkript tamamlandƒ±:', data.text);
            console.log(`üìä G√ºven skoru: ${Math.round(data.confidence * 100)}%`);
        } else {
            throw new Error(data.error || data.message || 'Transkript ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('‚ùå Transkript hatasƒ±:', error);

        // User-friendly error messages
        let errorMessage = 'Ses tanƒ±ma hatasƒ±: ';
        if (error.message.includes('not configured')) {
            errorMessage += 'Azure Speech servisi yapƒ±landƒ±rƒ±lmamƒ±≈ü. L√ºtfen yazarak soru sorun.';
        } else if (error.message.includes('403')) {
            errorMessage += 'Eri≈üim engellendi. L√ºtfen sayfayƒ± yenileyin.';
        } else if (error.message.includes('500')) {
            errorMessage += 'Sunucu hatasƒ±. L√ºtfen daha sonra tekrar deneyin.';
        } else {
            errorMessage += error.message;
        }

        alert(errorMessage);
    }
}

// ============================================================
// üñºÔ∏è AZURE DOCUMENT INTELLIGENCE - IMAGE ANALYSIS
// ============================================================

async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        showTypingIndicator();

        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/azure/legal/computer-vision', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success) {
            // Create detailed analysis message
            let analysisContent = 'üì∏ G√∂rsel Analiz Sonucu:\n\n';

            if (data.description) {
                analysisContent += `üìù A√ßƒ±klama: ${data.description}\n\n`;
            }

            if (data.text && data.text.length > 0) {
                analysisContent += `üìÑ Metin ƒ∞√ßeriƒüi:\n${data.text.join('\n')}\n\n`;
            }

            if (data.objects && data.objects.length > 0) {
                analysisContent += `üîç Tespit Edilen Objeler:\n${data.objects.map(o => `- ${o}`).join('\n')}\n\n`;
            }

            if (data.legal_implications) {
                analysisContent += `‚öñÔ∏è Hukuki Deƒüerlendirme:\n${data.legal_implications}`;
            }

            const analysisMessage = {
                id: (Date.now() + 2).toString(),
                role: 'ai',
                content: analysisContent,
                engine: 'Azure Computer Vision',
                timestamp: new Date().toISOString()
            };

            state.messages.push(analysisMessage);
            saveCurrentConversation();
            renderMessages();

            console.log('‚úÖ G√∂rsel analiz tamamlandƒ±');
        } else {
            throw new Error(data.error || 'G√∂rsel analiz ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('‚ùå G√∂rsel analiz hatasƒ±:', error);
        alert('G√∂rsel analiz hatasƒ±: ' + error.message);
    }

    // Reset input
    event.target.value = '';
}

// ============================================================
// üìÑ AZURE DOCUMENT INTELLIGENCE - PDF/WORD ANALYSIS
// ============================================================

async function handleDocumentUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        showTypingIndicator();

        const formData = new FormData();
        formData.append('file', file);
        formData.append('documentType', 'legal'); // Legal document type

        const response = await fetch('/api/azure/legal/document-intelligence', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success) {
            // Create detailed document analysis message
            let analysisContent = 'üìÑ Dok√ºman Analiz Sonucu:\n\n';

            if (data.documentType) {
                analysisContent += `üìã Dok√ºman Tipi: ${data.documentType}\n\n`;
            }

            if (data.content) {
                analysisContent += `üìù ƒ∞√ßerik:\n${data.content.substring(0, 500)}${data.content.length > 500 ? '...' : ''}\n\n`;
            }

            if (data.key_phrases && data.key_phrases.length > 0) {
                analysisContent += `üîë Anahtar Kelimeler:\n${data.key_phrases.map(k => `- ${k}`).join('\n')}\n\n`;
            }

            if (data.entities && data.entities.length > 0) {
                analysisContent += `üë• Tespit Edilen Varlƒ±klar:\n${data.entities.map(e => `- ${e}`).join('\n')}\n\n`;
            }

            if (data.legal_summary) {
                analysisContent += `‚öñÔ∏è Hukuki √ñzet:\n${data.legal_summary}`;
            }

            const analysisMessage = {
                id: (Date.now() + 2).toString(),
                role: 'ai',
                content: analysisContent,
                engine: 'Azure Document Intelligence',
                timestamp: new Date().toISOString()
            };

            state.messages.push(analysisMessage);
            saveCurrentConversation();
            renderMessages();

            console.log('‚úÖ Dok√ºman analiz tamamlandƒ±');
        } else {
            throw new Error(data.error || 'Dok√ºman analiz ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('‚ùå Dok√ºman analiz hatasƒ±:', error);
        alert('Dok√ºman analiz hatasƒ±: ' + error.message);
    }

    // Reset input
    event.target.value = '';
}

// Profile Modal Function
function showProfileModal() {
    // Get user data from localStorage
    const user = JSON.parse(localStorage.getItem('legalAI_user') || '{}');

    // Create modal HTML
    const modalHTML = `
        <div id="profileModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: var(--border-light);">
                    <h2 style="margin: 0; color: var(--text-primary); font-size: 24px; display: flex; align-items: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        Profil Bilgileri
                    </h2>
                    <button onclick="closeProfileModal()" style="width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">Ad Soyad</label>
                    <input type="text" id="profileName" value="${user.name || ''}" style="width: 100%; padding: 12px; border: var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">E-posta</label>
                    <input type="email" id="profileEmail" value="${user.email || ''}" style="width: 100%; padding: 12px; border: var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">Telefon</label>
                    <input type="tel" id="profilePhone" value="${user.phone || ''}" style="width: 100%; padding: 12px; border: var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">Meslek</label>
                    <input type="text" id="profileProfession" value="${user.profession || ''}" style="width: 100%; padding: 12px; border: var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <div style="margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--primary-accent);">
                    <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px; display: flex; align-items: center;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Hesap Olu≈üturma Tarihi
                    </div>
                    <div style="font-size: 14px; color: var(--text-primary); font-weight: 500;">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('tr-TR') : 'Bilinmiyor'}</div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeProfileModal()" style="padding: 12px 24px; background: var(--gray-100); border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--text-secondary); transition: all 0.2s; font-weight: 500;" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">ƒ∞ptal</button>
                    <button onclick="saveProfile()" style="padding: 12px 24px; background: var(--primary-accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-hover)'" onmouseout="this.style.background='var(--primary-accent)'">Kaydet</button>
                </div>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeProfileModal() {
    const modal = document.getElementById('profileModal');
    if (modal) {
        modal.remove();
    }
}

function saveProfile() {
    const name = document.getElementById('profileName').value.trim();
    const email = document.getElementById('profileEmail').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const profession = document.getElementById('profileProfession').value.trim();

    // Validate
    if (!name) {
        alert('L√ºtfen adƒ±nƒ±zƒ± giriniz');
        return;
    }

    if (!email) {
        alert('L√ºtfen e-posta adresinizi giriniz');
        return;
    }

    // Get existing user data
    const user = JSON.parse(localStorage.getItem('legalAI_user') || '{}');

    // Update user data
    user.name = name;
    user.email = email;
    user.phone = phone;
    user.profession = profession;
    user.updatedAt = new Date().toISOString();

    if (!user.createdAt) {
        user.createdAt = new Date().toISOString();
    }

    // Save to localStorage
    localStorage.setItem('legalAI_user', JSON.stringify(user));

    // Close modal
    closeProfileModal();

    // Show success message
    alert('‚úÖ Profil bilgileriniz ba≈üarƒ±yla g√ºncellendi!');
}

// Settings Modal Function
function showSettingsModal() {
    // Get settings from localStorage
    const settings = JSON.parse(localStorage.getItem('legalAI_settings') || '{}');

    // Default settings
    const defaultSettings = {
        language: settings.language || 'tr',
        aiengine: settings.aiModel || 'premium-model-1',
        temperature: settings.temperature || 0.7,
        maxTokens: settings.maxTokens || 2000,
        autoSave: settings.autoSave !== false,
        soundEnabled: settings.soundEnabled !== false,
        theme: settings.theme || 'light'
    };

    // Create modal HTML
    const modalHTML = `
        <div id="settingsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: var(--border-light);">
                    <h2 style="margin: 0; color: var(--text-primary); font-size: 24px; display: flex; align-items: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
                            <path d="m4.93 4.93 4.24 4.24m5.66 0 4.24-4.24m-4.24 9.9 4.24 4.24m-9.9-4.24-4.24 4.24"/>
                        </svg>
                        <span data-i18n="settingsModalTitle">Ayarlar</span>
                    </h2>
                    <button onclick="closeSettingsModal()" style="width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; color: var(--text-primary); margin-bottom: 16px; padding-bottom: 12px; border-bottom: var(--border-light); display: flex; align-items: center; font-weight: 600;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                        </svg>
                        <span data-i18n="settingsAIModelTitle">AI Model Ayarlarƒ±</span>
                    </h3>

                    <!-- AI Model Selection HIDDEN - Backend uses Ultra Intelligence Model (Advanced AI Platform) -->
                    <input type="hidden" id="settingsAIModel" value="premium-model-1">

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;"><span data-i18n="settingsTemperatureLabel">Temperature (Yaratƒ±cƒ±lƒ±k)</span>: ${defaultSettings.temperature}</label>
                        <input type="range" id="settingsTemperature" min="0" max="1" step="0.1" value="${defaultSettings.temperature}" style="width: 100%; accent-color: var(--primary-accent);" oninput="document.getElementById('tempValue').textContent = this.value">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                            <span data-i18n="settingsTemperaturePrecise">Kesin (0.0)</span>
                            <span id="tempValue" style="color: var(--primary-accent); font-weight: 600;">${defaultSettings.temperature}</span>
                            <span data-i18n="settingsTemperatureCreative">Yaratƒ±cƒ± (1.0)</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;" data-i18n="settingsMaxTokensLabel">Maksimum Token</label>
                        <select id="settingsMaxTokens" style="width: 100%; padding: 12px; border: var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="1000" ${defaultSettings.maxTokens === 1000 ? 'selected' : ''}>1000 (<span data-i18n="settingsTokenShort">Kƒ±sa</span>)</option>
                            <option value="2000" ${defaultSettings.maxTokens === 2000 ? 'selected' : ''}>2000 (<span data-i18n="settingsTokenMedium">Orta</span>)</option>
                            <option value="4000" ${defaultSettings.maxTokens === 4000 ? 'selected' : ''}>4000 (<span data-i18n="settingsTokenLong">Uzun</span>)</option>
                            <option value="8000" ${defaultSettings.maxTokens === 8000 ? 'selected' : ''}>8000 (<span data-i18n="settingsTokenVeryLong">√áok Uzun</span>)</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; color: var(--text-primary); margin-bottom: 16px; padding-bottom: 12px; border-bottom: var(--border-light); display: flex; align-items: center; font-weight: 600;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        <span data-i18n="settingsGeneralTitle">Genel Ayarlar</span>
                    </h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">üåç Dil / Language</label>
                        <select id="settingsLanguage" onchange="changeLanguage(this.value, event)" style="width: 100%; padding: 12px; border: var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="tr" ${defaultSettings.language === 'tr' ? 'selected' : ''}>üáπüá∑ T√ºrk√ße</option>
                            <option value="en" ${defaultSettings.language === 'en' ? 'selected' : ''}>üá∫üá∏ English</option>
                            <option value="de" ${defaultSettings.language === 'de' ? 'selected' : ''}>üá©üá™ Deutsch</option>
                            <option value="fr" ${defaultSettings.language === 'fr' ? 'selected' : ''}>üá´üá∑ Fran√ßais</option>
                            <option value="es" ${defaultSettings.language === 'es' ? 'selected' : ''}>üá™üá∏ Espa√±ol</option>
                            <option value="ar" ${defaultSettings.language === 'ar' ? 'selected' : ''}>üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                            <option value="zh" ${defaultSettings.language === 'zh' ? 'selected' : ''}>üá®üá≥ ‰∏≠Êñá</option>
                            <option value="ja" ${defaultSettings.language === 'ja' ? 'selected' : ''}>üáØüáµ Êó•Êú¨Ë™û</option>
                            <option value="ru" ${defaultSettings.language === 'ru' ? 'selected' : ''}>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                            <option value="pt" ${defaultSettings.language === 'pt' ? 'selected' : ''}>üáµüáπ Portugu√™s</option>
                            <option value="it" ${defaultSettings.language === 'it' ? 'selected' : ''}>üáÆüáπ Italiano</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <input type="checkbox" id="settingsAutoSave" ${defaultSettings.autoSave ? 'checked' : ''} style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-accent);">
                            <span style="color: var(--text-primary); font-size: 14px;" data-i18n="settingsAutoSave">Konu≈ümalarƒ± otomatik kaydet</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <input type="checkbox" id="settingsSoundEnabled" ${defaultSettings.soundEnabled ? 'checked' : ''} style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-accent);">
                            <span style="color: var(--text-primary); font-size: 14px;" data-i18n="settingsSoundEnabled">Bildirim seslerini etkinle≈ütir</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;" data-i18n="settingsThemeLabel">Tema</label>
                        <select id="settingsTheme" style="width: 100%; padding: 12px; border: var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="light" ${defaultSettings.theme === 'light' ? 'selected' : ''}><span data-i18n="settingsThemeLight">A√ßƒ±k</span></option>
                            <option value="dark" ${defaultSettings.theme === 'dark' ? 'selected' : ''}><span data-i18n="settingsThemeDark">Koyu</span></option>
                            <option value="auto" ${defaultSettings.theme === 'auto' ? 'selected' : ''}><span data-i18n="settingsThemeAuto">Otomatik</span></option>
                        </select>
                    </div>
                </div>

                <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--primary-accent); margin-bottom: 24px;">
                    <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px; display: flex; align-items: center;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <span data-i18n="settingsTipTitle">ƒ∞pucu</span>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary);" data-i18n="settingsTipText">Ayarlar otomatik olarak tarayƒ±cƒ±nƒ±zda saklanƒ±r ve bir sonraki ziyaretinizde korunur.</div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeSettingsModal()" style="padding: 12px 24px; background: var(--gray-100); border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--text-secondary); transition: all 0.2s; font-weight: 500;" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'"><span data-i18n="btnCancel">ƒ∞ptal</span></button>
                    <button onclick="saveSettings()" style="padding: 12px 24px; background: var(--primary-accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-hover)'" onmouseout="this.style.background='var(--primary-accent)'"><span data-i18n="btnSave">Kaydet</span></button>
                </div>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Apply translations to modal after DOM insertion
    setTimeout(() => applyTranslations(), 10);
}

// ‚úÖ K√ñKTEN Fƒ∞X: remove() yerine display:none kullan
function closeSettingsModal() {
    console.trace('üö® closeSettingsModal() √áAƒûRILDIƒûI - Kim √ßaƒüƒ±rdƒ±?');
    const modal = document.getElementById('settingsModal');
    if (modal) {
        console.log('‚ö†Ô∏è Modal kapanƒ±yor - display:none yapƒ±lƒ±yor');
        // ‚ùå ESKƒ∞ (YANLI≈û): modal.remove(); ‚Üí DOM'dan siler!
        // ‚úÖ YENƒ∞ (DOƒûRU): Sadece gizle
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
    }
}

function saveSettings() {
    const settings = {
        language: document.getElementById('settingsLanguage').value,
        aiengine: document.getElementById('settingsAIModel').value,
        temperature: parseFloat(document.getElementById('settingsTemperature').value),
        maxTokens: parseInt(document.getElementById('settingsMaxTokens').value),
        autoSave: document.getElementById('settingsAutoSave').checked,
        soundEnabled: document.getElementById('settingsSoundEnabled').checked,
        theme: document.getElementById('settingsTheme').value,
        updatedAt: new Date().toISOString()
    };

    // Save to localStorage
    localStorage.setItem('legalAI_settings', JSON.stringify(settings));

    // Close modal
    closeSettingsModal();

    // Show success message
    alert('‚úÖ Ayarlarƒ±nƒ±z ba≈üarƒ±yla kaydedildi!');

    // Apply theme if changed
    applyTheme(settings.theme);
}

function applyTheme(theme) {
    if (theme === 'dark') {
        document.body.style.background = '#1a1a1a';
        document.body.style.color = '#ffffff';
    } else if (theme === 'light') {
        document.body.style.background = '#ffffff';
        document.body.style.color = '#1a1a1a';
    } else if (theme === 'auto') {
        // Check system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.style.background = '#1a1a1a';
            document.body.style.color = '#ffffff';
        } else {
            document.body.style.background = '#ffffff';
            document.body.style.color = '#1a1a1a';
        }
    }
}

// Initialize settings on page load
window.addEventListener('DOMContentLoaded', () => {
    const settings = JSON.parse(localStorage.getItem('legalAI_settings') || '{}');

    // FORCE Azure as default AI model
    if (!settings.aiModel || !settings.aiModel.startsWith('premium-')) {
        settings.aiModel = 'premium-model-1';
        localStorage.setItem('legalAI_settings', JSON.stringify(settings));
    }

    if (settings.theme) {
        applyTheme(settings.theme);
    }

    // Export button dropdown toggle
    const exportBtn = document.getElementById('exportBtn');
    const exportDropdown = document.getElementById('exportDropdown');

    if (exportBtn && exportDropdown) {
        exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportDropdown.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                exportDropdown.classList.remove('active');
            }
        });
    }
});

// ============================================================
// üì• EXPORT & SHARE FUNCTIONS
// ============================================================

// Get all conversation messages
function getConversationData() {
    const messages = [];
    const messageElements = document.querySelectorAll('.message');

    messageElements.forEach(msg => {
        const isUser = msg.classList.contains('user');
        const bubble = msg.querySelector('.message-bubble');
        const time = msg.querySelector('.message-time');

        if (bubble) {
            messages.push({
                role: isUser ? 'Kullanƒ±cƒ±' : 'AI Asistan',
                content: bubble.textContent.trim(),
                timestamp: time ? time.textContent.trim() : new Date().toLocaleString('tr-TR')
            });
        }
    });

    return messages;
}

// Export as PDF
async function exportToPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const messages = getConversationData();
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 20;
        const maxWidth = pageWidth - (margin * 2);
        let yPosition = 20;

        // Header
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('LyDian Hukuk AI - G√∂r√º≈üme Kaydƒ±', margin, yPosition);
        yPosition += 10;

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Tarih: ${new Date().toLocaleString('tr-TR')}`, margin, yPosition);
        yPosition += 15;

        // Messages
        doc.setFontSize(11);
        messages.forEach((msg, index) => {
            // Check if we need a new page
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }

            // Role
            doc.setFont(undefined, 'bold');
            doc.text(`${msg.role}:`, margin, yPosition);
            yPosition += 7;

            // Content
            doc.setFont(undefined, 'normal');
            const lines = doc.splitTextToSize(msg.content, maxWidth);
            lines.forEach(line => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.text(line, margin, yPosition);
                yPosition += 6;
            });

            yPosition += 5;
        });

        // Save PDF
        const filename = `lydian-hukuk-${new Date().getTime()}.pdf`;
        doc.save(filename);

        // Close dropdown
        document.getElementById('exportDropdown').classList.remove('active');

        // Show success message
        showNotification('PDF ba≈üarƒ±yla kaydedildi!', 'success');
    } catch (error) {
        console.error('PDF export error:', error);
        showNotification('PDF olu≈üturulurken hata olu≈ütu', 'error');
    }
}

// Export as DOCX (using simple HTML format that Word can open)
function exportToDOCX() {
    try {
        const messages = getConversationData();

        let htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LyDian Hukuk AI - G√∂r√º≈üme Kaydƒ±</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        h1 { color: #C4A962; border-bottom: 3px solid #C4A962; padding-bottom: 10px; }
        .message { margin: 20px 0; padding: 15px; border-radius: 8px; }
        .user { background: rgba(196, 169, 98, 0.15); border-left: 4px solid #C4A962; }
        .ai { background: rgba(139, 21, 56, 0.1); border-left: 4px solid #8B1538; }
        .role { font-weight: bold; color: #1F2937; margin-bottom: 8px; }
        .timestamp { color: #6B7280; font-size: 0.9em; margin-top: 8px; }
    <\/style>
<\/head>
<body>
    <h1>LyDian Hukuk AI - G√∂r√º≈üme Kaydƒ±</h1>
    <p><strong>Tarih:</strong> ${new Date().toLocaleString('tr-TR')}</p>
    <hr>
`;

        messages.forEach(msg => {
            const className = msg.role === 'Kullanƒ±cƒ±' ? 'user' : 'ai';
            htmlContent += `
    <div class="message ${className}">
        <div class="role">${msg.role}</div>
        <div class="content">${msg.content.replace(/\n/g, '<br>')}</div>
        <div class="timestamp">${msg.timestamp}</div>
    </div>
`;
        });

        htmlContent += `
    <script src="/js/mobile-menu-handler.js"><\/script>
<\/body>
<\/html>
`;

        // Create blob and download
        const blob = new Blob([htmlContent], { type: 'application/msword' });
        const filename = `lydian-hukuk-${new Date().getTime()}.doc`;
        saveAs(blob, filename);

        // Close dropdown
        document.getElementById('exportDropdown').classList.remove('active');

        // Show success message
        showNotification('Word belgesi ba≈üarƒ±yla kaydedildi!', 'success');
    } catch (error) {
        console.error('DOCX export error:', error);
        showNotification('Word belgesi olu≈üturulurken hata olu≈ütu', 'error');
    }
}

// Export as TXT
function exportToTXT() {
    try {
        const messages = getConversationData();

        let txtContent = `LyDian Hukuk AI - G√∂r√º≈üme Kaydƒ±\n`;
        txtContent += `Tarih: ${new Date().toLocaleString('tr-TR')}\n`;
        txtContent += `${'='.repeat(60)}\n\n`;

        messages.forEach((msg, index) => {
            txtContent += `${msg.role}:\n`;
            txtContent += `${msg.content}\n`;
            txtContent += `[${msg.timestamp}]\n`;
            txtContent += `${'-'.repeat(60)}\n\n`;
        });

        // Create blob and download
        const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
        const filename = `lydian-hukuk-${new Date().getTime()}.txt`;
        saveAs(blob, filename);

        // Close dropdown
        document.getElementById('exportDropdown').classList.remove('active');

        // Show success message
        showNotification('Metin dosyasƒ± ba≈üarƒ±yla kaydedildi!', 'success');
    } catch (error) {
        console.error('TXT export error:', error);
        showNotification('Metin dosyasƒ± olu≈üturulurken hata olu≈ütu', 'error');
    }
}

// Copy share link
function copyShareLink() {
    try {
        // Generate a unique conversation ID (in production, this would be saved to database)
        const conversationId = btoa(Date.now().toString()).substr(0, 12);
        const shareUrl = `${window.location.origin}${window.location.pathname}?conversation=${conversationId}`;

        // Copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            // Close dropdown
            document.getElementById('exportDropdown').classList.remove('active');

            // Show success message
            showNotification('Link panoya kopyalandƒ±!', 'success');
        }).catch(err => {
            console.error('Clipboard error:', err);
            showNotification('Link kopyalanamadƒ±', 'error');
        });
    } catch (error) {
        console.error('Copy link error:', error);
        showNotification('Link olu≈üturulurken hata olu≈ütu', 'error');
    }
}

// Share conversation using native share API
async function shareConversation() {
    try {
        const messages = getConversationData();
        const summary = messages.length > 0 ? messages[0].content.substring(0, 100) + '...' : 'Hukuki g√∂r√º≈üme';

        const shareData = {
            title: 'LyDian Hukuk AI - G√∂r√º≈üme',
            text: `${summary}\n\nLyDian Hukuk AI ile ger√ßekle≈ütirilen g√∂r√º≈üme kaydƒ±`,
            url: window.location.href
        };

        if (navigator.share) {
            await navigator.share(shareData);

            // Close dropdown
            document.getElementById('exportDropdown').classList.remove('active');

            showNotification('G√∂r√º≈üme payla≈üƒ±ldƒ±!', 'success');
        } else {
            // Fallback: copy link
            copyShareLink();
        }
    } catch (error) {
        if (error.name !== 'AbortError') {
            console.error('Share error:', error);
            showNotification('Payla≈üƒ±m sƒ±rasƒ±nda hata olu≈ütu', 'error');
        }
    }
}

// Show notification (simple toast message)
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#C4A962' : type === 'error' ? '#8B1538' : '#1C2536'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
        font-weight: 500;
    `;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add animation keyframes
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}
`;
document.head.appendChild(style);


    </script>
    <script src="/js/mobile-menu-handler.js"></script>

    <!-- üåç LyDian i18n System - Auto-integrated -->
    <script src="/js/feature-flags.js"></script>
    <script src="/js/locale-engine.js"></script>
    <script src="/js/locale-switcher.js"></script>
    <script>
        (async function() {
            try {
                // 1. Initialize feature flags
                const flags = new FeatureFlags();
                await flags.init();

                // 2. Check if i18n is enabled
                if (flags.isEnabled('i18n_system_enabled')) {
                    // 3. Initialize locale engine
                    const i18n = new LocaleEngine({ defaultLocale: 'tr' });
                    await i18n.init();

                    // 4. Make available globally
                    window.i18n = i18n;

                    console.log('‚úÖ i18n system initialized:', i18n.getCurrentLocale());
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è i18n initialization failed:', error);
            }
        })();
    </script>

    <!-- üîí CSRF Protection -->
    <script src="/js/csrf-token.js"></script>
</body>
</html>
