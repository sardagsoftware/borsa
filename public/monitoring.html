<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="monitoring.page_title">Sistem İzleme Paneli - LyDian AI</title>
    <link rel="icon" type="image/png" href="/lydian-favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #10A37F 0%, #0D8F6E 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
        }

        .connection-status .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected .dot {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .metric {
            margin: 15px 0;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
        }

        .metric-unit {
            font-size: 1rem;
            color: #9ca3af;
            margin-left: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10A37F 0%, #0D8F6E 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #ef4444 100%);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }

        .endpoints-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .endpoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .endpoint-item:last-child {
            border-bottom: none;
        }

        .endpoint-path {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #10A37F;
        }

        .endpoint-stats {
            display: flex;
            gap: 15px;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .refresh-time {
            text-align: center;
            color: white;
            font-size: 0.875rem;
            margin-top: 20px;
            opacity: 0.8;
        }

        .wide-card {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.75rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 data-i18n="monitoring.header_title">📊 Sistem İzleme Paneli</h1>
            <p data-i18n="monitoring.header_subtitle">Gerçek Zamanlı Platform Metrikleri & Analizler</p>
            <div class="connection-status" id="connectionStatus">
                <div class="dot"></div>
                <span data-i18n="monitoring.connection_status">Gerçek Zamanlı Akışa Bağlandı</span>
            </div>
        </header>

        <div class="grid">
            <!-- Sistem Sağlığı -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.system_health">Sistem Sağlığı</h3>
                    <span class="card-icon">💚</span>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.status">Durum</div>
                    <div id="systemStatus" class="status-badge success" data-i18n="monitoring.healthy">Sağlıklı</div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.uptime">Çalışma Süresi</div>
                    <div class="metric-value" id="uptime">0<span class="metric-unit" data-i18n="monitoring.hours">saat</span></div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.platform">Platform</div>
                    <div class="metric-value" id="platform" style="font-size: 1.2rem;">-</div>
                </div>
            </div>

            <!-- CPU Kullanımı -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.cpu_usage">CPU Kullanımı</h3>
                    <span class="card-icon">⚡</span>
                </div>
                <div class="metric">
                    <div class="metric-value" id="cpuUsage">0<span class="metric-unit">%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cpuProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.cpu_cores">CPU Çekirdekleri</div>
                    <div class="metric-value" id="cpuCores" style="font-size: 1.5rem;">-</div>
                </div>
            </div>

            <!-- Bellek Kullanımı -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.memory_usage">Bellek Kullanımı</h3>
                    <span class="card-icon">🧠</span>
                </div>
                <div class="metric">
                    <div class="metric-value" id="memoryUsed">0<span class="metric-unit">MB</span></div>
                    <div class="metric-label"><span data-i18n="monitoring.of">toplam</span> <span id="memoryTotal">0</span> MB</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="memoryProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.percentage">Yüzde</div>
                    <div class="metric-value" id="memoryPercent" style="font-size: 1.5rem;">0%</div>
                </div>
            </div>

            <!-- İstek İstatistikleri -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.request_statistics">İstek İstatistikleri</h3>
                    <span class="card-icon">📈</span>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.total_requests">Toplam İstekler</div>
                    <div class="metric-value" id="requestsTotal">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.successful">Başarılı</div>
                    <div class="metric-value" id="requestsSuccess" style="font-size: 1.3rem; color: #10b981;">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.failed">Başarısız</div>
                    <div class="metric-value" id="requestsFailed" style="font-size: 1.3rem; color: #ef4444;">0</div>
                </div>
            </div>

            <!-- Performans Metrikleri -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.performance">Performans</h3>
                    <span class="card-icon">⚡</span>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.avg_response_time">Ortalama Yanıt Süresi</div>
                    <div class="metric-value" id="avgResponseTime">0<span class="metric-unit">ms</span></div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.error_rate">Hata Oranı</div>
                    <div class="metric-value" id="errorRate">0<span class="metric-unit">%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="errorProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- AI Model Kullanımı -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.ai_model_usage">AI Model Kullanımı</h3>
                    <span class="card-icon">🤖</span>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.total_requests">Toplam İstekler</div>
                    <div class="metric-value" id="aiRequests">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.avg_tokens_request">Ort. Token/İstek</div>
                    <div class="metric-value" id="aiTokens" style="font-size: 1.3rem;">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.total_cost">Toplam Maliyet</div>
                    <div class="metric-value" id="aiCost" style="font-size: 1.3rem;">$0.00</div>
                </div>
            </div>

            <!-- Önbellek Performansı -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.cache_performance">Önbellek Performansı</h3>
                    <span class="card-icon">💾</span>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.hit_rate">İsabet Oranı</div>
                    <div class="metric-value" id="cacheHitRate">0<span class="metric-unit">%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cacheProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.cache_hits">Önbellek İsabetleri</div>
                    <div class="metric-value" id="cacheHits" style="font-size: 1.3rem; color: #10b981;">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.cache_misses">Önbellek Kaçırmaları</div>
                    <div class="metric-value" id="cacheMisses" style="font-size: 1.3rem; color: #f59e0b;">0</div>
                </div>
            </div>

            <!-- Canlı Bağlantılar (Gerçek Zamanlı) -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.live_metrics">Canlı Metrikler</h3>
                    <span class="card-icon">📡</span>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.current_memory_live">Anlık Bellek (Canlı)</div>
                    <div class="metric-value" id="liveMemory">0<span class="metric-unit">MB</span></div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.total_requests_live">Toplam İstek (Canlı)</div>
                    <div class="metric-value" id="liveRequests">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label" data-i18n="monitoring.error_rate_live">Hata Oranı (Canlı)</div>
                    <div class="metric-value" id="liveErrorRate" style="font-size: 1.3rem;">0%</div>
                </div>
            </div>

            <!-- En Çok Kullanılan Uç Noktalar -->
            <div class="card wide-card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="monitoring.top_endpoints">En Çok Kullanılan Uç Noktalar</h3>
                    <span class="card-icon">🔝</span>
                </div>
                <div class="endpoints-list" id="endpointsList">
                    <div class="endpoint-item">
                        <span class="endpoint-path" data-i18n="monitoring.loading_endpoints">Uç noktalar yükleniyor...</span>
                        <div class="endpoint-stats">
                            <span>-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="refresh-time">
            <span data-i18n="monitoring.last_updated">Son güncelleme</span>: <span id="lastUpdate">-</span> | <span data-i18n="monitoring.auto_refresh">Her 5 saniyede bir otomatik yenilenir</span>
        </div>
    </div>

    <script>
        // Durum yönetimi
        let eventSource = null;
        let isConnected = false;

        // Gerçek zamanlı bağlantıyı başlat
        function initRealtimeConnection() {
            try {
                eventSource = new EventSource('/api/metrics/realtime');

                eventSource.onopen = () => {
                    isConnected = true;
                    updateConnectionStatus(true);
                };

                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    updateRealtimeMetrics(data);
                };

                eventSource.onerror = () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                    // 5 saniye sonra yeniden bağlan
                    setTimeout(() => {
                        if (eventSource) {
                            eventSource.close();
                        }
                        initRealtimeConnection();
                    }, 5000);
                };
            } catch (error) {
                console.error('Gerçek zamanlı bağlantı başlatılamadı:', error);
                updateConnectionStatus(false);
            }
        }

        // Bağlantı durumu göstergesini güncelle
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.classList.remove('disconnected');
                statusEl.querySelector('span').textContent = 'Gerçek Zamanlı Akışa Bağlandı';
            } else {
                statusEl.classList.add('disconnected');
                statusEl.querySelector('span').textContent = 'Bağlantı Kesildi - Yeniden Bağlanıyor...';
            }
        }

        // SSE'den gerçek zamanlı metrikleri güncelle
        function updateRealtimeMetrics(data) {
            document.getElementById('liveMemory').innerHTML = `${data.memory}<span class="metric-unit">MB</span>`;
            document.getElementById('liveRequests').textContent = data.requests;
            document.getElementById('liveErrorRate').textContent = `${data.errorRate}%`;
        }

        // Dashboard metriklerini getir
        async function fetchDashboardMetrics() {
            try {
                const response = await fetch('/api/metrics/dashboard');
                const data = await response.json();
                updateDashboard(data);
                updateLastRefreshTime();
            } catch (error) {
                console.error('Dashboard metrikleri getirilemedi:', error);
            }
        }

        // Dashboard'u metriklerle güncelle
        function updateDashboard(data) {
            // Sistem Sağlığı
            const uptimeHours = (data.system.uptime / 3600).toFixed(1);
            document.getElementById('uptime').innerHTML = `${uptimeHours}<span class="metric-unit">saat</span>`;
            document.getElementById('platform').textContent = data.system.platform;

            // CPU
            const cpuUsage = data.performance.cpuPercent || 0;
            document.getElementById('cpuUsage').innerHTML = `${cpuUsage}<span class="metric-unit">%</span>`;
            document.getElementById('cpuCores').textContent = navigator.hardwareConcurrency || '-';
            updateProgressBar('cpuProgress', cpuUsage);

            // Bellek
            const memoryUsed = data.performance.memoryMB;
            const memoryTotal = data.performance.memoryTotal;
            const memoryPercent = ((memoryUsed / memoryTotal) * 100).toFixed(1);
            document.getElementById('memoryUsed').innerHTML = `${memoryUsed}<span class="metric-unit">MB</span>`;
            document.getElementById('memoryTotal').textContent = memoryTotal;
            document.getElementById('memoryPercent').textContent = `${memoryPercent}%`;
            updateProgressBar('memoryProgress', memoryPercent);

            // İstekler
            document.getElementById('requestsTotal').textContent = data.requests.total;
            document.getElementById('requestsSuccess').textContent = data.requests.successful;
            document.getElementById('requestsFailed').textContent = data.requests.failed;

            // Performans
            document.getElementById('avgResponseTime').innerHTML = `${data.requests.avgResponseTime}<span class="metric-unit">ms</span>`;
            document.getElementById('errorRate').innerHTML = `${data.requests.errorRate}<span class="metric-unit">%</span>`;
            updateProgressBar('errorProgress', parseFloat(data.requests.errorRate));

            // AI Modelleri
            document.getElementById('aiRequests').textContent = data.aiModels.requests;
            document.getElementById('aiTokens').textContent = data.aiModels.avgTokens;
            document.getElementById('aiCost').textContent = `$${data.aiModels.totalCost}`;

            // Önbellek
            document.getElementById('cacheHitRate').innerHTML = `${data.cache.hitRate}<span class="metric-unit">%</span>`;
            document.getElementById('cacheHits').textContent = data.cache.hits;
            document.getElementById('cacheMisses').textContent = data.cache.misses;
            updateProgressBar('cacheProgress', parseFloat(data.cache.hitRate));

            // Uç Noktalar
            updateEndpointsList(data.endpoints);
        }

        // Progress bar'ı güncelle
        function updateProgressBar(id, percentage) {
            const bar = document.getElementById(id);
            bar.style.width = `${Math.min(percentage, 100)}%`;

            // Yüzdeye göre rengi güncelle
            bar.classList.remove('warning', 'danger');
            if (percentage > 80) {
                bar.classList.add('danger');
            } else if (percentage > 60) {
                bar.classList.add('warning');
            }
        }

        // Uç noktalar listesini güncelle
        function updateEndpointsList(endpoints) {
            const container = document.getElementById('endpointsList');

            if (!endpoints || endpoints.length === 0) {
                container.innerHTML = '<div class="endpoint-item"><span class="endpoint-path">Uç nokta verisi mevcut değil</span></div>';
                return;
            }

            // İstek sayısına göre sırala ve ilk 10'u al
            const topEndpoints = endpoints
                .sort((a, b) => b.requests - a.requests)
                .slice(0, 10);

            container.innerHTML = topEndpoints.map(endpoint => `
                <div class="endpoint-item">
                    <span class="endpoint-path">${endpoint.path}</span>
                    <div class="endpoint-stats">
                        <span title="Toplam İstek">${endpoint.requests} istek</span>
                        <span title="Ortalama Yanıt Süresi">${endpoint.avgResponseTime}ms</span>
                    </div>
                </div>
            `).join('');
        }

        // Son yenileme zamanını güncelle
        function updateLastRefreshTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('tr-TR');
        }

        // Sayfa yüklendiğinde başlat
        window.addEventListener('DOMContentLoaded', () => {
            // İlk veriyi getir
            fetchDashboardMetrics();

            // Her 5 saniyede bir otomatik yenileme
            setInterval(fetchDashboardMetrics, 5000);

            // Gerçek zamanlı bağlantıyı başlat
            initRealtimeConnection();
        });

        // Sayfa kapanırken temizlik
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>

    <!-- 🌍 LyDian i18n System - Auto-integrated -->
    <script src="/js/feature-flags.js"></script>
    <script src="/js/locale-engine.js"></script>
    <script src="/js/locale-switcher.js"></script>
    <script>
        (async function() {
            try {
                // 1. Initialize feature flags
                const flags = new FeatureFlags();
                await flags.init();

                // 2. Check if i18n is enabled
                if (flags.isEnabled('i18n_system_enabled')) {
                    // 3. Initialize locale engine
                    const i18n = new LocaleEngine({ defaultLocale: 'tr' });
                    await i18n.init();

                    // 4. Make available globally
                    window.i18n = i18n;

                    console.log('✅ i18n system initialized:', i18n.getCurrentLocale());
                }
            } catch (error) {
                console.warn('⚠️ i18n initialization failed:', error);
            }
        })();
    </script>

</body>
</html>
