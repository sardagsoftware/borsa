<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring Dashboard - LyDian AI</title>
    <link rel="icon" type="image/png" href="/lydian-favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: radial-gradient(1400px 900px at 70% 15%, rgba(184,107,255,.10), transparent 60%),
                        radial-gradient(1200px 700px at 20% 80%, rgba(110,132,255,.10), transparent 65%),
                        #0A0B0D;
            min-height: 100vh;
            padding: 20px;
            color: #FFFFFF;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
        }

        .connection-status .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected .dot {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #FFFFFF;
            text-shadow: 0 0 8px rgba(0,224,174,0.3);
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .metric {
            margin: 15px 0;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #00E0AE;
            text-shadow: 0 0 10px rgba(0,224,174,0.4);
        }

        .metric-unit {
            font-size: 1rem;
            color: #9ca3af;
            margin-left: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #ef4444 100%);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }

        .endpoints-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .endpoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .endpoint-item:last-child {
            border-bottom: none;
        }

        .endpoint-path {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #6366f1;
        }

        .endpoint-stats {
            display: flex;
            gap: 15px;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .refresh-time {
            text-align: center;
            color: white;
            font-size: 0.875rem;
            margin-top: 20px;
            opacity: 0.8;
        }

        .wide-card {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.75rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä System Monitoring Dashboard</h1>
            <p>Real-time Platform Metrics & Analytics</p>
            <div class="connection-status" id="connectionStatus">
                <div class="dot"></div>
                <span>Connected to Real-time Stream</span>
            </div>
        </header>

        <div class="grid">
            <!-- System Health -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">System Health</h3>
                    <span class="card-icon">üíö</span>
                </div>
                <div class="metric">
                    <div class="metric-label">Status</div>
                    <div id="systemStatus" class="status-badge success">Healthy</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Uptime</div>
                    <div class="metric-value" id="uptime">0<span class="metric-unit">hours</span></div>
                </div>
                <div class="metric">
                    <div class="metric-label">Platform</div>
                    <div class="metric-value" id="platform" style="font-size: 1.2rem;">-</div>
                </div>
            </div>

            <!-- CPU Usage -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">CPU Usage</h3>
                    <span class="card-icon">‚ö°</span>
                </div>
                <div class="metric">
                    <div class="metric-value" id="cpuUsage">0<span class="metric-unit">%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cpuProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">CPU Cores</div>
                    <div class="metric-value" id="cpuCores" style="font-size: 1.5rem;">-</div>
                </div>
            </div>

            <!-- Memory Usage -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Memory Usage</h3>
                    <span class="card-icon">üß†</span>
                </div>
                <div class="metric">
                    <div class="metric-value" id="memoryUsed">0<span class="metric-unit">MB</span></div>
                    <div class="metric-label">of <span id="memoryTotal">0</span> MB total</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="memoryProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Percentage</div>
                    <div class="metric-value" id="memoryPercent" style="font-size: 1.5rem;">0%</div>
                </div>
            </div>

            <!-- Request Statistics -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Request Statistics</h3>
                    <span class="card-icon">üìà</span>
                </div>
                <div class="metric">
                    <div class="metric-label">Total Requests</div>
                    <div class="metric-value" id="requestsTotal">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Successful</div>
                    <div class="metric-value" id="requestsSuccess" style="font-size: 1.3rem; color: #10b981;">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Failed</div>
                    <div class="metric-value" id="requestsFailed" style="font-size: 1.3rem; color: #ef4444;">0</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance</h3>
                    <span class="card-icon">‚ö°</span>
                </div>
                <div class="metric">
                    <div class="metric-label">Avg Response Time</div>
                    <div class="metric-value" id="avgResponseTime">0<span class="metric-unit">ms</span></div>
                </div>
                <div class="metric">
                    <div class="metric-label">Error Rate</div>
                    <div class="metric-value" id="errorRate">0<span class="metric-unit">%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="errorProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- AI Model Usage -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">AI Model Usage</h3>
                    <span class="card-icon">ü§ñ</span>
                </div>
                <div class="metric">
                    <div class="metric-label">Total Requests</div>
                    <div class="metric-value" id="aiRequests">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Avg Tokens/Request</div>
                    <div class="metric-value" id="aiTokens" style="font-size: 1.3rem;">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total Cost</div>
                    <div class="metric-value" id="aiCost" style="font-size: 1.3rem;">$0.00</div>
                </div>
            </div>

            <!-- Cache Performance -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Cache Performance</h3>
                    <span class="card-icon">üíæ</span>
                </div>
                <div class="metric">
                    <div class="metric-label">Hit Rate</div>
                    <div class="metric-value" id="cacheHitRate">0<span class="metric-unit">%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cacheProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Cache Hits</div>
                    <div class="metric-value" id="cacheHits" style="font-size: 1.3rem; color: #10b981;">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Cache Misses</div>
                    <div class="metric-value" id="cacheMisses" style="font-size: 1.3rem; color: #f59e0b;">0</div>
                </div>
            </div>

            <!-- Active Connections (Realtime) -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Live Metrics</h3>
                    <span class="card-icon">üì°</span>
                </div>
                <div class="metric">
                    <div class="metric-label">Current Memory (Live)</div>
                    <div class="metric-value" id="liveMemory">0<span class="metric-unit">MB</span></div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total Requests (Live)</div>
                    <div class="metric-value" id="liveRequests">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Error Rate (Live)</div>
                    <div class="metric-value" id="liveErrorRate" style="font-size: 1.3rem;">0%</div>
                </div>
            </div>

            <!-- Top Endpoints -->
            <div class="card wide-card">
                <div class="card-header">
                    <h3 class="card-title">Top Endpoints</h3>
                    <span class="card-icon">üîù</span>
                </div>
                <div class="endpoints-list" id="endpointsList">
                    <div class="endpoint-item">
                        <span class="endpoint-path">Loading endpoints...</span>
                        <div class="endpoint-stats">
                            <span>-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="refresh-time">
            Last updated: <span id="lastUpdate">-</span> | Auto-refreshes every 5 seconds
        </div>
    </div>

    <script>
        // State management
        let eventSource = null;
        let isConnected = false;

        // Initialize real-time connection
        function initRealtimeConnection() {
            try {
                eventSource = new EventSource('/api/metrics/realtime');

                eventSource.onopen = () => {
                    isConnected = true;
                    updateConnectionStatus(true);
                };

                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    updateRealtimeMetrics(data);
                };

                eventSource.onerror = () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                    // Reconnect after 5 seconds
                    setTimeout(() => {
                        if (eventSource) {
                            eventSource.close();
                        }
                        initRealtimeConnection();
                    }, 5000);
                };
            } catch (error) {
                console.error('Failed to initialize realtime connection:', error);
                updateConnectionStatus(false);
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.classList.remove('disconnected');
                statusEl.querySelector('span').textContent = 'Connected to Real-time Stream';
            } else {
                statusEl.classList.add('disconnected');
                statusEl.querySelector('span').textContent = 'Disconnected - Reconnecting...';
            }
        }

        // Update realtime metrics from SSE
        function updateRealtimeMetrics(data) {
            document.getElementById('liveMemory').innerHTML = `${data.memory}<span class="metric-unit">MB</span>`;
            document.getElementById('liveRequests').textContent = data.requests;
            document.getElementById('liveErrorRate').textContent = `${data.errorRate}%`;
        }

        // Fetch dashboard metrics
        async function fetchDashboardMetrics() {
            try {
                const response = await fetch('/api/metrics/dashboard');
                const data = await response.json();
                updateDashboard(data);
                updateLastRefreshTime();
            } catch (error) {
                console.error('Failed to fetch dashboard metrics:', error);
            }
        }

        // Update dashboard with metrics
        function updateDashboard(data) {
            // System Health
            const uptimeHours = (data.system.uptime / 3600).toFixed(1);
            document.getElementById('uptime').innerHTML = `${uptimeHours}<span class="metric-unit">hours</span>`;
            document.getElementById('platform').textContent = data.system.platform;

            // CPU
            const cpuUsage = data.performance.cpuPercent || 0;
            document.getElementById('cpuUsage').innerHTML = `${cpuUsage}<span class="metric-unit">%</span>`;
            document.getElementById('cpuCores').textContent = navigator.hardwareConcurrency || '-';
            updateProgressBar('cpuProgress', cpuUsage);

            // Memory
            const memoryUsed = data.performance.memoryMB;
            const memoryTotal = data.performance.memoryTotal;
            const memoryPercent = ((memoryUsed / memoryTotal) * 100).toFixed(1);
            document.getElementById('memoryUsed').innerHTML = `${memoryUsed}<span class="metric-unit">MB</span>`;
            document.getElementById('memoryTotal').textContent = memoryTotal;
            document.getElementById('memoryPercent').textContent = `${memoryPercent}%`;
            updateProgressBar('memoryProgress', memoryPercent);

            // Requests
            document.getElementById('requestsTotal').textContent = data.requests.total;
            document.getElementById('requestsSuccess').textContent = data.requests.successful;
            document.getElementById('requestsFailed').textContent = data.requests.failed;

            // Performance
            document.getElementById('avgResponseTime').innerHTML = `${data.requests.avgResponseTime}<span class="metric-unit">ms</span>`;
            document.getElementById('errorRate').innerHTML = `${data.requests.errorRate}<span class="metric-unit">%</span>`;
            updateProgressBar('errorProgress', parseFloat(data.requests.errorRate));

            // AI Models
            document.getElementById('aiRequests').textContent = data.aiModels.requests;
            document.getElementById('aiTokens').textContent = data.aiModels.avgTokens;
            document.getElementById('aiCost').textContent = `$${data.aiModels.totalCost}`;

            // Cache
            document.getElementById('cacheHitRate').innerHTML = `${data.cache.hitRate}<span class="metric-unit">%</span>`;
            document.getElementById('cacheHits').textContent = data.cache.hits;
            document.getElementById('cacheMisses').textContent = data.cache.misses;
            updateProgressBar('cacheProgress', parseFloat(data.cache.hitRate));

            // Endpoints
            updateEndpointsList(data.endpoints);
        }

        // Update progress bar
        function updateProgressBar(id, percentage) {
            const bar = document.getElementById(id);
            bar.style.width = `${Math.min(percentage, 100)}%`;

            // Update color based on percentage
            bar.classList.remove('warning', 'danger');
            if (percentage > 80) {
                bar.classList.add('danger');
            } else if (percentage > 60) {
                bar.classList.add('warning');
            }
        }

        // Update endpoints list
        function updateEndpointsList(endpoints) {
            const container = document.getElementById('endpointsList');

            if (!endpoints || endpoints.length === 0) {
                container.innerHTML = '<div class="endpoint-item"><span class="endpoint-path">No endpoint data available</span></div>';
                return;
            }

            // Sort by request count and take top 10
            const topEndpoints = endpoints
                .sort((a, b) => b.requests - a.requests)
                .slice(0, 10);

            container.innerHTML = topEndpoints.map(endpoint => `
                <div class="endpoint-item">
                    <span class="endpoint-path">${endpoint.path}</span>
                    <div class="endpoint-stats">
                        <span title="Total Requests">${endpoint.requests} req</span>
                        <span title="Avg Response Time">${endpoint.avgResponseTime}ms</span>
                    </div>
                </div>
            `).join('');
        }

        // Update last refresh time
        function updateLastRefreshTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Fetch initial data
            fetchDashboardMetrics();

            // Setup auto-refresh every 5 seconds
            setInterval(fetchDashboardMetrics, 5000);

            // Initialize real-time connection
            initRealtimeConnection();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
