name: üîê Automated Encrypted Backup

on:
  # Her commit sonrasƒ±
  push:
    branches:
      - main

  # G√ºnl√ºk otomatik yedekleme (03:00 UTC)
  schedule:
    - cron: '0 3 * * *'

  # Manuel tetikleme
  workflow_dispatch:

jobs:
  backup:
    name: Create Encrypted Backup
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full git history

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Create backup timestamp
        id: timestamp
        run: |
          echo "TIMESTAMP=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
          echo "DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: üóÇÔ∏è Prepare backup structure
        run: |
          mkdir -p backup/{source,git,configs,metadata}

      - name: üìã Backup source code
        run: |
          tar -czf backup/source/source_code.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='*.backup*' \
            --exclude='.vercel' \
            --exclude='dist' \
            --exclude='build' \
            .

      - name: üîÄ Backup Git repository
        run: |
          git clone --bare . backup/git/repository.git
          git log --all --pretty=format:"%H|%an|%ae|%ad|%s" > backup/git/commit_history.txt
          git branch -a > backup/git/branches.txt
          git tag -l > backup/git/tags.txt
          git remote -v > backup/git/remotes.txt

      - name: ‚öôÔ∏è Backup configurations
        run: |
          cp package*.json backup/configs/ 2>/dev/null || true
          cp tsconfig.json backup/configs/ 2>/dev/null || true
          cp next.config.js backup/configs/ 2>/dev/null || true
          cp vercel.json backup/configs/ 2>/dev/null || true
          cp README.md backup/configs/ 2>/dev/null || true
          cp -r .github/workflows backup/configs/ 2>/dev/null || true

      - name: üìä Create backup metadata
        run: |
          cat > backup/metadata/BACKUP_INFO.json << EOF
          {
            "backup_timestamp": "${{ steps.timestamp.outputs.DATE }}",
            "backup_type": "github_actions_automated",
            "project_name": "ailydian-ultra-pro",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "triggered_by": "${{ github.event_name }}",
            "git_info": {
              "repository": "${{ github.repository }}",
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "actor": "${{ github.actor }}"
            }
          }
          EOF

      - name: üîê Encrypt backup
        env:
          ENCRYPTION_PASSWORD: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
        run: |
          # Create tar archive
          tar -czf ailydian_backup_${{ steps.timestamp.outputs.TIMESTAMP }}.tar.gz backup/

          # Encrypt with AES-256 (using password from secrets)
          if [ -n "$ENCRYPTION_PASSWORD" ]; then
            openssl enc -aes-256-cbc -salt \
              -in ailydian_backup_${{ steps.timestamp.outputs.TIMESTAMP }}.tar.gz \
              -out ailydian_backup_${{ steps.timestamp.outputs.TIMESTAMP }}.tar.gz.enc \
              -pass pass:"$ENCRYPTION_PASSWORD"

            # Remove unencrypted version
            rm ailydian_backup_${{ steps.timestamp.outputs.TIMESTAMP }}.tar.gz

            echo "‚úÖ Backup encrypted successfully"
          else
            echo "‚ö†Ô∏è No encryption key found in secrets"
            mv ailydian_backup_${{ steps.timestamp.outputs.TIMESTAMP }}.tar.gz \
               ailydian_backup_${{ steps.timestamp.outputs.TIMESTAMP }}.tar.gz.unencrypted
          fi

      - name: üì§ Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: encrypted-backup-${{ steps.timestamp.outputs.TIMESTAMP }}
          path: |
            *.enc
            *.unencrypted
          retention-days: 90  # Keep for 90 days

      - name: üíæ Upload to GitHub Releases (Monthly)
        if: github.event.schedule == '0 3 1 * *'  # First day of month
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ steps.timestamp.outputs.TIMESTAMP }}
          name: Monthly Backup - ${{ steps.timestamp.outputs.TIMESTAMP }}
          body: |
            üîê Automated Monthly Encrypted Backup

            **Backup Info:**
            - Date: ${{ steps.timestamp.outputs.DATE }}
            - Commit: ${{ github.sha }}
            - Triggered by: ${{ github.event_name }}

            **Contents:**
            - ‚úÖ Full source code
            - ‚úÖ Complete Git history
            - ‚úÖ All configurations
            - ‚úÖ Metadata

            **Security:**
            - üîê AES-256 encrypted
            - üóúÔ∏è Gzip compressed

            ‚ö†Ô∏è Decryption requires the backup encryption key from repository secrets.
          files: |
            *.enc
            *.unencrypted
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìù Create backup log
        run: |
          echo "Backup completed: ${{ steps.timestamp.outputs.DATE }}" >> backup_history.log
          echo "Run ID: ${{ github.run_id }}" >> backup_history.log
          echo "SHA: ${{ github.sha }}" >> backup_history.log
          echo "---" >> backup_history.log

      - name: ‚úÖ Backup summary
        run: |
          echo "üéâ BACKUP COMPLETED SUCCESSFULLY"
          echo "================================="
          echo "Timestamp: ${{ steps.timestamp.outputs.TIMESTAMP }}"
          echo "Encrypted: Yes (AES-256)"
          echo "Uploaded to: GitHub Artifacts"
          echo "Retention: 90 days"
          echo ""
          echo "‚ö†Ô∏è Important: Keep your BACKUP_ENCRYPTION_KEY secret safe!"
