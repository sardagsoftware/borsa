# üöÄ AILYDIAN Ultra Pro - Enhanced CI Pipeline
# Optimized for Express + Redis + Winston architecture
# Production-ready quality gates

name: Enhanced CI Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '9.15.9'

jobs:
  # ==========================================
  # Job 1: Express Server Validation
  # ==========================================
  server-validation:
    name: Server Validation & Health Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Test Winston Logger
        run: |
          echo "üß™ Testing production logger..."
          NODE_ENV=test LOG_LEVEL=error node test-logger.js
          echo "‚úÖ Logger validation passed"

      - name: Test Redis Cache Manager
        run: |
          echo "üß™ Testing Redis cache manager..."
          NODE_ENV=test REDIS_HOST=localhost REDIS_PORT=6379 node test-cache.js
          echo "‚úÖ Cache validation passed"
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: Validate Environment Configuration
        run: |
          echo "üîç Validating environment template..."
          node scripts/validate-environment.js || echo "‚ö†Ô∏è Validation warnings (non-critical)"

      - name: Check Claude Agent System
        run: |
          echo "ü§ñ Verifying Claude agent system..."
          [ -f ".clauderc" ] && echo "‚úÖ .clauderc exists"
          [ -f "CLAUDE.EKIP.AGENT.md" ] && echo "‚úÖ Agent constitution exists"
          [ -d ".claude/agents" ] && echo "‚úÖ Agents directory exists"
          AGENT_COUNT=$(find .claude/agents -name "*.md" -type f | wc -l)
          echo "üìä Total agents: $AGENT_COUNT"
          [ $AGENT_COUNT -ge 30 ] && echo "‚úÖ Agent system operational" || echo "‚ö†Ô∏è Missing agents"

      - name: Test Server Startup
        run: |
          echo "üöÄ Testing server startup..."
          timeout 30 node server.js &
          SERVER_PID=$!
          sleep 10

          # Check if server is running
          if ps -p $SERVER_PID > /dev/null; then
            echo "‚úÖ Server started successfully"
            kill $SERVER_PID
          else
            echo "‚ùå Server failed to start"
            exit 1
          fi
        env:
          NODE_ENV: test
          PORT: 3100
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SESSION_SECRET: test-secret-key-for-ci
          JWT_SECRET: test-jwt-secret-key-for-ci

  # ==========================================
  # Job 2: Security & Compliance Audit
  # ==========================================
  security-compliance:
    name: Security & Compliance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: NPM Security Audit
        run: |
          echo "üîí Running npm audit..."
          pnpm audit --audit-level=high || echo "‚ö†Ô∏è Security vulnerabilities found"

      - name: Check for Hardcoded Secrets
        run: |
          echo "üîê Scanning for hardcoded secrets..."

          # Check for API keys
          if grep -r "sk-[a-zA-Z0-9]\{20,\}" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git . 2>/dev/null; then
            echo "‚ùå Potential API keys found!"
            exit 1
          fi

          # Check for passwords in code
          if grep -r "password\s*[:=]\s*['\"][^'\"]\{8,\}['\"]" --include="*.js" --exclude-dir=node_modules --exclude="*.env*" --exclude-dir=.git . 2>/dev/null; then
            echo "‚ö†Ô∏è Hardcoded passwords detected!"
          fi

          echo "‚úÖ No obvious secrets found"

      - name: Verify HIPAA/GDPR Compliance
        run: |
          echo "üè• Checking HIPAA/GDPR compliance..."

          # Check for HIPAA audit logger
          if [ -f "lib/security/hipaa-audit-logger.js" ]; then
            echo "‚úÖ HIPAA audit logger present"
          else
            echo "‚ö†Ô∏è HIPAA audit logger not found"
          fi

          # Check for GDPR compliance middleware
          if [ -f "middleware/gdpr-kvkk-compliance.js" ]; then
            echo "‚úÖ GDPR/KVKK compliance middleware present"
          else
            echo "‚ö†Ô∏è GDPR compliance middleware not found"
          fi

          # Check for PII redaction in logger
          if grep -q "SENSITIVE_FIELDS" lib/logger/production-logger.js; then
            echo "‚úÖ PII redaction configured in logger"
          else
            echo "‚ùå PII redaction missing!"
            exit 1
          fi

      - name: Check Console.log Usage
        run: |
          echo "üîç Checking for console.log statements..."

          # Count console statements in production code
          CONSOLE_COUNT=$(grep -r "console\." server.js lib/ middleware/ api/ --include="*.js" 2>/dev/null | wc -l || echo "0")

          echo "üìä Console statements found: $CONSOLE_COUNT"

          if [ $CONSOLE_COUNT -gt 50 ]; then
            echo "‚ö†Ô∏è High number of console statements - should use logger instead"
          else
            echo "‚úÖ Acceptable console usage"
          fi

  # ==========================================
  # Job 3: API Integration Tests
  # ==========================================
  api-integration-tests:
    name: API Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start Server (Background)
        run: |
          echo "üöÄ Starting server for API tests..."
          node server.js &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://localhost:3500/api/health > /dev/null 2>&1; then
              echo "‚úÖ Server ready on port 3500"
              break
            fi
            echo "‚è≥ Waiting for server... ($i/30)"
            sleep 2
          done
        env:
          NODE_ENV: test
          PORT: 3500
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SESSION_SECRET: test-secret-ci-integration
          JWT_SECRET: test-jwt-ci-integration
          LOG_LEVEL: error

      - name: Run Core API Tests
        run: |
          echo "üß™ Running Core Platform API tests..."
          npm run test:api:core
        env:
          TEST_API_URL: http://localhost:3500
          NODE_ENV: test

      - name: Run Medical API Tests (HIPAA)
        run: |
          echo "üè• Running Medical API tests (HIPAA-compliant)..."
          npm run test:api:medical
        env:
          TEST_API_URL: http://localhost:3500
          NODE_ENV: test

      - name: Run Authentication Tests
        run: |
          echo "üîê Running Authentication & Authorization tests..."
          npm run test:api:auth
        env:
          TEST_API_URL: http://localhost:3500
          NODE_ENV: test

      - name: Generate Coverage Report
        run: |
          echo "üìä Generating test coverage report..."
          npm run test:coverage
        env:
          TEST_API_URL: http://localhost:3500

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: api-integration-tests
          name: api-integration-coverage
          fail_ci_if_error: false

      - name: Stop Server
        if: always()
        run: |
          if [ -n "${{ env.SERVER_PID }}" ]; then
            kill ${{ env.SERVER_PID }} 2>/dev/null || true
            echo "‚úÖ Server stopped"
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: |
            coverage/
            jest-results.json
          retention-days: 7

  # ==========================================
  # Job 4: Performance Benchmarks
  # ==========================================
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Performance Benchmark
        run: |
          echo "‚ö° Running cache performance benchmark..."

          node -e "
            const cacheManager = require('./lib/cache/redis-cache-manager');

            (async () => {
              const iterations = 1000;
              const start = Date.now();

              for (let i = 0; i < iterations; i++) {
                await cacheManager.setAsync('memory', \`bench-\${i}\`, { data: i }, 60);
              }

              for (let i = 0; i < iterations; i++) {
                await cacheManager.getAsync('memory', \`bench-\${i}\`);
              }

              const duration = Date.now() - start;
              const opsPerSec = Math.round((iterations * 2) / (duration / 1000));

              console.log(\`‚úÖ Performance: \${duration}ms for \${iterations * 2} operations\`);
              console.log(\`‚ö° Throughput: \${opsPerSec} ops/sec\`);

              const stats = cacheManager.getStats();
              console.log(\`üìä Hit rate: \${stats.hitRates.memory}%\`);

              // Performance threshold: < 1 second for 2000 operations
              if (duration > 1000) {
                console.log('‚ùå Performance degraded!');
                process.exit(1);
              }

              await cacheManager.shutdown();
              process.exit(0);
            })();
          "
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: Logger Performance Test
        run: |
          echo "üìù Testing logger performance..."

          node -e "
            const logger = require('./lib/logger/production-logger');

            const start = Date.now();

            for (let i = 0; i < 1000; i++) {
              logger.info('Benchmark message', { iteration: i, data: { foo: 'bar' } });
            }

            const duration = Date.now() - start;

            console.log(\`‚úÖ Logger: 1000 log entries in \${duration}ms\`);

            if (duration > 500) {
              console.log('‚ö†Ô∏è Logger performance degraded');
            }
          "
        env:
          NODE_ENV: test
          LOG_LEVEL: error

  # ==========================================
  # Job 4: Dependency Analysis
  # ==========================================
  dependency-analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Analyze Dependencies
        run: |
          echo "üì¶ Analyzing dependencies..."

          node -e "
            const pkg = require('./package.json');

            const deps = Object.keys(pkg.dependencies || {});
            const devDeps = Object.keys(pkg.devDependencies || {});

            console.log('üìä Dependency Report:');
            console.log('  Total dependencies:', deps.length);
            console.log('  Dev dependencies:', devDeps.length);
            console.log('');

            // Critical dependencies
            const critical = [
              'winston',
              'ioredis',
              'express',
              'applicationinsights'
            ];

            console.log('‚úÖ Critical dependencies:');
            critical.forEach(dep => {
              if (deps.includes(dep)) {
                console.log(\`  ‚úÖ \${dep}: \${pkg.dependencies[dep]}\`);
              } else {
                console.log(\`  ‚ùå \${dep}: MISSING\`);
              }
            });
          "

      - name: Check for Unused Dependencies
        run: |
          echo "üîç Checking for potentially unused dependencies..."
          # This would require depcheck or similar tool
          echo "‚ö†Ô∏è Manual review recommended"

  # ==========================================
  # Job 5: Documentation Validation
  # ==========================================
  documentation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Critical Documentation
        run: |
          echo "üìö Validating documentation..."

          # Check for critical docs
          DOCS=(
            "README.md"
            "CLAUDE.EKIP.AGENT.md"
            "IMPLEMENTATION-LOG.md"
            "lib/logger/README.md"
            "lib/cache/README.md"
          )

          MISSING=0
          for doc in "${DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "‚úÖ $doc exists"
            else
              echo "‚ùå $doc missing"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "‚ö†Ô∏è $MISSING documentation files missing"
          else
            echo "‚úÖ All critical documentation present"
          fi

  # ==========================================
  # Job 6: CI Summary
  # ==========================================
  ci-summary:
    name: CI Pipeline Summary
    runs-on: ubuntu-latest
    needs: [server-validation, security-compliance, api-integration-tests, performance-benchmarks, dependency-analysis, documentation]
    if: always()

    steps:
      - name: Generate Summary Report
        run: |
          echo "========================================"
          echo "üéØ AILYDIAN Ultra Pro - CI Summary"
          echo "========================================"
          echo ""
          echo "Server Validation: ${{ needs.server-validation.result }}"
          echo "Security/Compliance: ${{ needs.security-compliance.result }}"
          echo "API Integration Tests: ${{ needs.api-integration-tests.result }}"
          echo "Performance: ${{ needs.performance-benchmarks.result }}"
          echo "Dependencies: ${{ needs.dependency-analysis.result }}"
          echo "Documentation: ${{ needs.documentation.result }}"
          echo ""
          echo "========================================"

          # Fail if critical jobs failed
          if [ "${{ needs.server-validation.result }}" == "failure" ]; then
            echo "‚ùå Server validation failed"
            exit 1
          fi

          if [ "${{ needs.security-compliance.result }}" == "failure" ]; then
            echo "‚ùå Security compliance failed"
            exit 1
          fi

          if [ "${{ needs.api-integration-tests.result }}" == "failure" ]; then
            echo "‚ùå API integration tests failed"
            exit 1
          fi

          if [ "${{ needs.performance-benchmarks.result }}" == "failure" ]; then
            echo "‚ùå Performance benchmarks failed"
            exit 1
          fi

          echo "‚úÖ All critical checks passed!"
