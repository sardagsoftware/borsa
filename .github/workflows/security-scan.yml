name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly (every Monday at 9 AM UTC)
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  string-guard:
    name: String Guard - AI Provider Name Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd ops/tools
          npm install || echo "No package.json in ops/tools, skipping"

      - name: Run String Guard
        id: string_guard
        run: |
          node ops/tools/string-guard.js --report=json --output=ops/reports/violations.json
        continue-on-error: true

      - name: Check violations
        run: |
          if [ -f ops/reports/violations.json ]; then
            CRITICAL=$(jq '.summary.critical' ops/reports/violations.json)
            echo "Critical violations found: $CRITICAL"

            if [ "$CRITICAL" -gt 0 ]; then
              echo "âŒ FAIL: $CRITICAL critical violations found"
              echo "Review ops/reports/violations.json for details"
              exit 1
            else
              echo "âœ… PASS: No critical violations"
            fi
          else
            echo "âš ï¸ WARNING: violations.json not found"
            exit 1
          fi

      - name: Upload violations report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: security-violations
          path: ops/reports/violations.json
          retention-days: 30

  secret-scan:
    name: Secret Fallback Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Scan for secret fallbacks
        run: |
          echo "Scanning for hardcoded secret fallbacks..."
          COUNT=$(grep -r "process.env.*||" --include="*.js" 2>/dev/null | wc -l || echo "0")
          echo "Found $COUNT instances of secret fallbacks"

          if [ "$COUNT" -gt 0 ]; then
            echo "âŒ WARNING: $COUNT secret fallback patterns found"
            echo "These should be removed in Week 2"
            # Don't fail the build yet, just warn
            exit 0
          else
            echo "âœ… PASS: No secret fallbacks found"
          fi

  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --production --audit-level=high || true

      - name: Check for critical vulnerabilities
        run: |
          CRITICAL=$(npm audit --json --production 2>/dev/null | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(npm audit --json --production 2>/dev/null | jq '.metadata.vulnerabilities.high // 0')

          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ FAIL: $CRITICAL critical vulnerabilities found"
            exit 1
          elif [ "$HIGH" -gt 5 ]; then
            echo "âš ï¸ WARNING: $HIGH high vulnerabilities found"
            # Don't fail, just warn
            exit 0
          else
            echo "âœ… PASS: No critical vulnerabilities"
          fi

  # ===========================================================================
  # Phase 5.4: Automated Security Audit
  # ===========================================================================
  security-audit:
    name: Comprehensive Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit script
        id: security-audit
        run: |
          echo "ðŸ”’ Running comprehensive security audit..."
          node scripts/security-audit.js --json > security-audit-report.json || echo "AUDIT_FAILED=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: Check audit results
        run: |
          if [ "$AUDIT_FAILED" == "true" ]; then
            echo "âŒ Security audit detected issues!"
            cat security-audit-report.json
            exit 1
          else
            echo "âœ… Security audit passed"
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-audit-report.json
          retention-days: 90

  # ===========================================================================
  # Phase 5.4: Security Headers Validation
  # ===========================================================================
  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate security headers
        run: |
          echo "ðŸ” Validating security headers configuration..."

          # Check if security-headers middleware exists
          if [ ! -f "middleware/security-headers.js" ]; then
            echo "âŒ Security headers middleware not found!"
            exit 1
          fi

          # Check for required headers
          HEADERS=(
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Strict-Transport-Security"
            "Content-Security-Policy"
            "Permissions-Policy"
          )

          for header in "${HEADERS[@]}"; do
            if grep -q "$header" middleware/security-headers.js; then
              echo "âœ… $header configured"
            else
              echo "âŒ $header missing!"
              exit 1
            fi
          done

          # Check for unsafe CSP directives
          if grep -q "unsafe-eval" middleware/security*.js; then
            echo "âš ï¸  WARNING: 'unsafe-eval' found in CSP (review if necessary)"
          fi

  # ===========================================================================
  # Phase 5.4: OWASP Compliance Check
  # ===========================================================================
  owasp-compliance:
    name: OWASP Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check OWASP Top 10 compliance
        run: |
          echo "ðŸ” Checking OWASP Top 10 compliance..."

          # A01: Broken Access Control
          if [ -f "middleware/rbac.js" ] || [ -f "middleware/auth-governance.js" ]; then
            echo "âœ… A01: Access control middleware detected"
          else
            echo "âš ï¸  A01: Missing access control middleware"
          fi

          # A02: Cryptographic Failures
          if [ -f "middleware/encryption.js" ] || [ -f "middleware/enforce-https.js" ]; then
            echo "âœ… A02: Encryption middleware detected"
          else
            echo "âš ï¸  A02: Missing encryption middleware"
          fi

          # A03: Injection
          if [ -f "middleware/input-validation.js" ]; then
            echo "âœ… A03: Input validation middleware detected"
          else
            echo "âŒ A03: Missing input validation middleware"
            exit 1
          fi

          # A05: Security Misconfiguration
          if [ -f "middleware/security-headers.js" ]; then
            echo "âœ… A05: Security headers middleware detected"
          else
            echo "âŒ A05: Missing security headers middleware"
            exit 1
          fi

          # A09: Security Logging Failures
          if [ -f "middleware/audit-logger.js" ] || [ -f "services/monitoring-telemetry-service.js" ]; then
            echo "âœ… A09: Logging and monitoring detected"
          else
            echo "âš ï¸  A09: Missing logging and monitoring"
          fi

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        string-guard,
        secret-scan,
        dependency-check,
        security-audit,
        security-headers,
        owasp-compliance,
      ]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ›¡ï¸ Security Scan Summary - Phase 5.4" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| String Guard | ${{ needs.string-guard.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Security Audit (Phase 5.4)** | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Security Headers (Phase 5.4)** | ${{ needs.security-headers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **OWASP Compliance (Phase 5.4)** | ${{ needs.owasp-compliance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.security-audit.result }}" == "failure" ] || \
             [ "${{ needs.dependency-check.result }}" == "failure" ] || \
             [ "${{ needs.security-headers.result }}" == "failure" ] || \
             [ "${{ needs.owasp-compliance.result }}" == "failure" ]; then
            echo "âŒ **CRITICAL SECURITY ISSUES DETECTED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review failed jobs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **All security checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Phase 5.4 Complete** - Production-grade security hardening active" >> $GITHUB_STEP_SUMMARY
          fi
