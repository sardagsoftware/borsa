# ===========================================================================
# AILYDIAN PRODUCTION DOCKER COMPOSE
# ===========================================================================
# Production deployment configuration for AILYDIAN Ultra Pro
# Includes: Main server with all 6 microservices integrated
# ===========================================================================

version: '3.9'

services:
  # ===========================================================================
  # AILYDIAN MAIN SERVER (Integrated Mode)
  # All 6 microservices running in single container
  # ===========================================================================
  ailydian-server:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        NODE_ENV: production
    image: ailydian/server:latest
    container_name: ailydian-server
    restart: unless-stopped
    ports:
      - "3100:3100"
    environment:
      # Server Configuration
      - NODE_ENV=production
      - PORT=3100

      # Security Secrets
      - JWT_SECRET=${JWT_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}

      # Database (if using infrastructure services)
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}

      # Microservices Ports (if standalone mode)
      - MONITORING_PORT=3101
      - AUTH_PORT=3102
      - AZURE_AI_PORT=3103
      - AI_CHAT_PORT=3104
      - FILE_STORAGE_PORT=3105
      - PAYMENT_PORT=3106

      # Azure Services
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME:-gpt-4}
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
      - AZURE_CONTAINER_NAME=${AZURE_CONTAINER_NAME:-uploads}
      - AZURE_SEARCH_ENDPOINT=${AZURE_SEARCH_ENDPOINT}
      - AZURE_SEARCH_ADMIN_KEY=${AZURE_SEARCH_ADMIN_KEY}

      # Payment (Stripe)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}

      # Email (SendGrid)
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL}
      - SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME:-AILYDIAN}

      # Other AI Providers
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}

      # Application URLs
      - APP_URL=${APP_URL:-https://www.ailydian.com}

    volumes:
      # Persistent storage
      - ailydian_uploads:/app/uploads
      - ailydian_logs:/app/logs
      - ailydian_cache:/app/.cache

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3100/api/services/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

    networks:
      - ailydian-network

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ===========================================================================
# VOLUMES
# ===========================================================================
volumes:
  ailydian_uploads:
    driver: local
  ailydian_logs:
    driver: local
  ailydian_cache:
    driver: local

# ===========================================================================
# NETWORKS
# ===========================================================================
networks:
  ailydian-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
