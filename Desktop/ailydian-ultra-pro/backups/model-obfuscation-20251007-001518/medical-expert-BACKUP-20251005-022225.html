<!-- Cache-Buster: 1759577324 -->
<!DOCTYPE html>
<html lang="tr" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyDian Medical AI - Healthcare Intelligence Expert</title>
    <link rel="icon" type="image/png" href="/lydian-logo.png">

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fonts - Inline critical fonts for instant load -->
    <style>
        /* Righteous font for Logo - Inline for instant load */
        @font-face {
            font-family: 'Righteous';
            font-style: normal;
            font-weight: 400;
            font-display: block;
            src: url(https://fonts.gstatic.com/s/righteous/v14/1cXxaUPXBpj2rGoU7C9WhnGFucE.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Righteous&display=swap" rel="stylesheet">

    <style>
/* ============================================================
   LYDIAN MEDICAL AI - ENTERPRISE HEALTHCARE SYSTEM 2025
   ============================================================ */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* Medical Blue Color System */
    --medical-primary: #0066CC;
    --medical-primary-hover: #0052A3;
    --medical-secondary: #00A3E0;
    --medical-accent: #4FC3F7;
    --medical-success: #10B981;
    --medical-warning: #F59E0B;
    --medical-error: #EF4444;
    --medical-info: #3B82F6;

    /* Clean Gradients */
    --gradient-medical: linear-gradient(135deg, #0066CC 0%, #00A3E0 100%);
    --gradient-success: linear-gradient(135deg, #10B981 0%, #34D399 100%);
    --gradient-header: linear-gradient(180deg, #FFFFFF 0%, #F9FAFB 100%);

    /* White Background System */
    --bg-primary: #FFFFFF;
    --bg-secondary: #F9FAFB;
    --bg-tertiary: #F3F4F6;
    --bg-hover: #FFFFFF;
    --bg-sidebar: #1E3A8A;
    --bg-sidebar-hover: #1E40AF;

    /* Text Colors */
    --text-primary: #1F2937;
    --text-secondary: #4B5563;
    --text-tertiary: #6B7280;
    --text-muted: #9CA3AF;
    --text-inverse: #ffffff;

    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-medical: 0 4px 12px rgba(0, 102, 204, 0.15);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.12);

    /* Borders */
    --border-light: 1px solid #E5E7EB;
    --border-medium: 1px solid #D1D5DB;
    --border-medical: 1px solid #0066CC;
    --border-dark: 1px solid rgba(255, 255, 255, 0.1);
}

/* ============================================================
   PREMIUM KEYFRAME ANIMATIONS
   ============================================================ */

@keyframes gradientFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes typingDot {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
    }
    30% {
        transform: translateY(-12px);
        opacity: 1;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    10%, 30% { transform: scale(0.9); }
    20%, 40% { transform: scale(1.1); }
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    display: flex;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ============================================================
   SIDEBAR - Medical Navigation
   ============================================================ */

.sidebar {
    width: 280px;
    background: var(--bg-sidebar);
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    border-right: var(--border-dark);
}

.sidebar.collapsed {
    transform: translateX(-300px);
}

.sidebar-header {
    padding: 1.5rem 1rem;
    border-bottom: var(--border-dark);
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-inverse);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    letter-spacing: 0.5px;
}

.logo-icon {
    width: 36px;
    height: 36px;
    background: var(--gradient-medical);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: heartbeat 2s infinite;
}

.new-consultation-btn {
    margin: 0.75rem;
    padding: 1rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: var(--text-inverse);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
}

.new-consultation-btn:hover {
    background: var(--bg-sidebar-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medical);
}

.specializations-list {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.specialization-item {
    padding: 0.875rem 1rem;
    background: transparent;
    border-radius: 10px;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9375rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.specialization-item:hover {
    background: var(--bg-sidebar-hover);
    color: var(--text-inverse);
    transform: translateX(4px);
}

.specialization-item.active {
    background: var(--bg-sidebar-hover);
    color: var(--text-inverse);
    border-left: 3px solid var(--medical-secondary);
}

.specialization-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

.sidebar-footer {
    margin-top: auto;
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.emergency-btn {
    width: 100%;
    padding: 1rem;
    background: var(--medical-error);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
}

.emergency-btn:hover {
    background: #DC2626;
    transform: scale(1.02);
}

/* ============================================================
   MAIN CHAT AREA
   ============================================================ */

.main-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}

.chat-header {
    padding: 1.25rem 2rem;
    background: var(--bg-primary);
    border-bottom: var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sidebar-toggle {
    width: 40px;
    height: 40px;
    background: transparent;
    border: var(--border-light);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: var(--text-secondary);
}

.sidebar-toggle:hover {
    background: var(--bg-secondary);
    border-color: var(--medical-primary);
    color: var(--medical-primary);
}

.chat-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.header-right {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.header-btn {
    padding: 0.625rem 1rem;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-primary);
}

.header-btn:hover {
    background: var(--medical-primary);
    border-color: var(--medical-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-medical);
}

.language-selector {
    padding: 0.625rem 1rem;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    color: var(--text-primary);
}

/* Medical Disclaimer Banner */
.medical-disclaimer-banner {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
    border-left: 4px solid var(--medical-error);
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.disclaimer-icon-banner {
    width: 40px;
    height: 40px;
    background: var(--medical-error);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.disclaimer-text {
    flex: 1;
    font-size: 0.9375rem;
    color: var(--text-primary);
    line-height: 1.6;
}

/* Messages Container */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    background: var(--bg-secondary);
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 2rem;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: var(--gradient-medical);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    animation: fadeInScale 0.5s ease;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

.empty-subtitle {
    font-size: 1.0625rem;
    color: var(--text-tertiary);
    margin-bottom: 2rem;
    max-width: 500px;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
    max-width: 900px;
}

.quick-action-card {
    padding: 1.5rem;
    background: var(--bg-primary);
    border: var(--border-light);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.quick-action-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-medical);
    border-color: var(--medical-primary);
}

.quick-action-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 163, 224, 0.1));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: var(--medical-primary);
}

.quick-action-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.quick-action-desc {
    font-size: 0.875rem;
    color: var(--text-tertiary);
    line-height: 1.5;
}

/* Message Styles */
.message {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    animation: messageAppear 0.3s ease;
}

.message.user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: var(--shadow-base);
}

.message.user .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.message.ai .message-avatar {
    background: var(--gradient-medical);
}

.message-content {
    flex: 1;
    max-width: 70%;
}

.message-bubble {
    padding: 1rem 1.25rem;
    border-radius: 16px;
    line-height: 1.6;
    font-size: 0.9375rem;
}

.message.user .message-bubble {
    background: var(--medical-primary);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.ai .message-bubble {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: var(--border-light);
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
    padding-left: 0.25rem;
}

.typing-indicator {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: var(--medical-primary);
    border-radius: 50%;
    animation: typingDot 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

/* Input Area */
.input-area {
    background: var(--bg-primary);
    border-top: var(--border-light);
    padding: 1.5rem 2rem;
}

.medical-upload-zone {
    margin-bottom: 1rem;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 2px dashed #D1D5DB;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.medical-upload-zone:hover {
    border-color: var(--medical-primary);
    background: rgba(0, 102, 204, 0.05);
}

.upload-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 0.75rem;
    background: var(--gradient-medical);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.upload-text {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.upload-subtext {
    font-size: 0.8125rem;
    color: var(--text-tertiary);
}

.input-wrapper {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.message-input {
    flex: 1;
    padding: 1rem 1.25rem;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 12px;
    font-size: 0.9375rem;
    font-family: 'Inter', sans-serif;
    resize: none;
    min-height: 56px;
    max-height: 200px;
    transition: all 0.3s ease;
}

.message-input:focus {
    outline: none;
    border-color: var(--medical-primary);
    box-shadow: var(--shadow-medical);
}

.input-actions {
    display: flex;
    gap: 0.75rem;
}

.input-btn {
    width: 56px;
    height: 56px;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: var(--text-secondary);
}

.input-btn:hover {
    background: var(--medical-primary);
    border-color: var(--medical-primary);
    color: white;
    transform: translateY(-2px);
}

.send-btn {
    background: var(--gradient-medical);
    border: none;
    color: white;
    padding: 0 1.5rem;
    width: auto;
    font-weight: 700;
}

.send-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medical);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--bg-primary);
    border-radius: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    animation: fadeInScale 0.3s ease;
}

.modal-header {
    padding: 1.5rem 2rem;
    border-bottom: var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-close {
    width: 36px;
    height: 36px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
    color: var(--text-secondary);
}

.modal-close:hover {
    background: var(--bg-secondary);
    color: var(--medical-error);
}

.modal-body {
    padding: 2rem;
}

.emergency-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.emergency-card {
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.emergency-card:hover {
    transform: translateY(-4px);
    border-color: var(--medical-error);
    box-shadow: var(--shadow-lg);
}

.emergency-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--medical-error);
    margin-bottom: 0.5rem;
}

.emergency-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
}

/* Responsive Design */
@media (max-width: 768px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        transform: translateX(-300px);
    }

    .sidebar.active {
        transform: translateX(0);
    }

    .quick-actions {
        grid-template-columns: 1fr;
    }

    .message-content {
        max-width: 85%;
    }

    .input-wrapper {
        flex-wrap: wrap;
    }

    .emergency-grid {
        grid-template-columns: 1fr;
    }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
    background: #D1D5DB;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--medical-primary);
}
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                        <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                        <circle cx="20" cy="10" r="2"/>
                    </svg>
                </div>
                <span>LyDian Medical</span>
            </div>
        </div>

        <button class="new-consultation-btn" onclick="newConsultation()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New Consultation
        </button>

        <div class="specializations-list" id="specializationsList">
            <div class="specialization-item active" data-specialty="general">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                    </svg>
                </div>
                <span>General Medicine</span>
            </div>

            <div class="specialization-item" data-specialty="cardiology">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"/>
                    </svg>
                </div>
                <span>Cardiology</span>
            </div>

            <div class="specialization-item" data-specialty="neurology">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                        <path d="M12 15v7"/>
                        <path d="M8 19h8"/>
                    </svg>
                </div>
                <span>Neurology</span>
            </div>

            <div class="specialization-item" data-specialty="radiology">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                </div>
                <span>Radiology</span>
            </div>

            <div class="specialization-item" data-specialty="oncology">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </div>
                <span>Oncology</span>
            </div>

            <div class="specialization-item" data-specialty="pediatrics">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v4a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                        <path d="M12 9v13"/>
                        <path d="M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2"/>
                    </svg>
                </div>
                <span>Pediatrics</span>
            </div>

            <div class="specialization-item" data-specialty="psychiatry">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <span>Psychiatry</span>
            </div>

            <div class="specialization-item" data-specialty="orthopedics">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
                    </svg>
                </div>
                <span>Orthopedics</span>
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="emergency-btn" onclick="showEmergencyModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M10 3h4l2 6h6l-5 4 2 6-6-4-6 4 2-6-5-4h6l2-6z"/>
                </svg>
                Emergency Numbers
            </button>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <h1 class="chat-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                        <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                        <circle cx="20" cy="10" r="2"/>
                    </svg>
                    <span id="chatTitle">Medical AI Expert</span>
                </h1>
            </div>

            <div class="header-right">
                <div id="aiStatusBadge" style="padding: 0.625rem 1rem; background: linear-gradient(135deg, #10B981, #34D399); border-radius: 10px; color: white; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <span>AI Ready</span>
                </div>
                <select class="language-selector" id="languageSelector" onchange="changeLanguage()">
                    <option value="tr">Turkish</option>
                    <option value="en">English</option>
                    <option value="de">German</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="ar">Arabic</option>
                    <option value="ru">Russian</option>
                    <option value="zh">Chinese</option>
                </select>
                <button class="header-btn" onclick="exportConsultation()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <!-- Medical Disclaimer Banner -->
        <div class="medical-disclaimer-banner">
            <div class="disclaimer-icon-banner">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
            </div>
            <div class="disclaimer-text">
                <strong>Important Medical Disclaimer:</strong> This AI assistant provides general health information only and does not replace professional medical diagnosis, treatment, or advice. Always consult a healthcare provider for medical concerns. For emergencies, call 112.
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                        <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                        <circle cx="20" cy="10" r="2"/>
                    </svg>
                </div>
                <h2 class="empty-title">Welcome to LyDian Medical AI</h2>
                <p class="empty-subtitle">Your AI-powered healthcare assistant. Ask medical questions, analyze symptoms, or upload medical images for analysis.</p>

                <div class="quick-actions">
                    <div class="quick-action-card" onclick="handleQuickAction('symptom-analysis')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Symptom Analysis</div>
                        <div class="quick-action-desc">Describe your symptoms for AI-powered differential diagnosis</div>
                    </div>

                    <div class="quick-action-card" onclick="handleQuickAction('drug-interaction')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <path d="M12 8v8"/>
                                <path d="M8 12h8"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Drug Interaction</div>
                        <div class="quick-action-desc">Check medication interactions and side effects</div>
                    </div>

                    <div class="quick-action-card" onclick="handleQuickAction('image-analysis')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Medical Image Analysis</div>
                        <div class="quick-action-desc">Upload X-rays, CT scans, or MRI for AI analysis</div>
                    </div>

                    <div class="quick-action-card" onclick="handleQuickAction('medical-literature')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Medical Literature</div>
                        <div class="quick-action-desc">Search PubMed and medical journals</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="medical-upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*,.pdf,.dcm" style="display: none;" onchange="handleFileUpload(event)">
                <div class="upload-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <div class="upload-text">Upload Medical Documents</div>
                <div class="upload-subtext">X-Ray, CT Scan, MRI, Lab Results, Medical Records (PDF, DICOM, JPG, PNG)</div>
            </div>

            <div class="input-wrapper">
                <textarea
                    class="message-input"
                    id="messageInput"
                    placeholder="Describe your symptoms, ask medical questions, or upload medical images..."
                    maxlength="5000"
                    rows="1"
                ></textarea>
                <div class="input-actions">
                    <button class="input-btn" id="voiceBtn" onclick="handleVoiceInput()" title="Voice Input">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </button>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Numbers Modal -->
    <div class="modal" id="emergencyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    Emergency Medical Numbers
                </div>
                <button class="modal-close" onclick="closeEmergencyModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="emergency-grid">
                    <div class="emergency-card">
                        <div class="emergency-number">112</div>
                        <div class="emergency-label">Emergency Medical Services</div>
                    </div>
                    <div class="emergency-card">
                        <div class="emergency-number">184</div>
                        <div class="emergency-label">Poison Control</div>
                    </div>
                    <div class="emergency-card">
                        <div class="emergency-number">182</div>
                        <div class="emergency-label">Psychiatric Hotline</div>
                    </div>
                    <div class="emergency-card">
                        <div class="emergency-number">155</div>
                        <div class="emergency-label">Police Emergency</div>
                    </div>
                    <div class="emergency-card">
                        <div class="emergency-number">110</div>
                        <div class="emergency-label">Fire Department</div>
                    </div>
                    <div class="emergency-card">
                        <div class="emergency-number">183</div>
                        <div class="emergency-label">ALO 183 Healthcare</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
/* ============================================================
   LYDIAN MEDICAL AI - MAIN APPLICATION LOGIC
   ============================================================ */

// State Management
const state = {
    messages: [],
    currentSpecialty: 'general',
    currentLanguage: 'tr',
    conversations: [],
    currentConversationId: null,
    isRecording: false,
    mediaRecorder: null,
    audioChunks: []
};

// DOM Elements
const sidebar = document.getElementById('sidebar');
const messagesContainer = document.getElementById('messagesContainer');
const emptyState = document.getElementById('emptyState');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const chatTitle = document.getElementById('chatTitle');
const languageSelector = document.getElementById('languageSelector');

// Update AI Status Badge
function updateAIStatus(status, modelName = '') {
    const badge = document.getElementById('aiStatusBadge');
    if (!badge) return;

    const statusConfig = {
        ready: {
            bg: 'linear-gradient(135deg, #10B981, #34D399)',
            text: 'AI Ready',
            icon: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>'
        },
        thinking: {
            bg: 'linear-gradient(135deg, #0066CC, #00A3E0)',
            text: modelName || 'AI Thinking...',
            icon: '<circle cx="12" cy="12" r="10" opacity="0.5"/><path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>'
        },
        error: {
            bg: 'linear-gradient(135deg, #EF4444, #DC2626)',
            text: 'AI Error',
            icon: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'
        }
    };

    const config = statusConfig[status] || statusConfig.ready;
    badge.style.background = config.bg;
    badge.innerHTML = `
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            ${config.icon}
        </svg>
        <span>${config.text}</span>
    `;
}

// Detect Symptoms in Message
function detectSymptoms(text) {
    const symptomKeywords = ['pain', 'ache', 'fever', 'cough', 'headache', 'nausea', 'dizzy', 'tired', 'fatigue',
                             'aÄŸrÄ±', 'acÄ±', 'ateÅŸ', 'Ã¶ksÃ¼rÃ¼k', 'baÅŸ aÄŸrÄ±sÄ±', 'mide bulantÄ±sÄ±', 'yorgunluk',
                             'symptom', 'semptom', 'feeling', 'hissediyorum'];
    return symptomKeywords.some(keyword => text.toLowerCase().includes(keyword));
}

// Perform RAG-based Diagnosis
async function performRAGDiagnosis(symptoms) {
    try {
        showTypingIndicator();

        const response = await fetch('/api/medical/rag-diagnosis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                symptoms: symptoms,
                language: state.currentLanguage,
                specialty: state.currentSpecialty
            })
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success && data.diagnosis) {
            const ragMessage = `\n\nðŸ“š **RAG-Enhanced Diagnosis** (PubMed + SNOMED + ICD-11):\n\n${data.diagnosis}`;
            addMessage(ragMessage, false);
        }
    } catch (error) {
        console.error('RAG diagnosis error:', error);
        hideTypingIndicator();
    }
}

// Load Emergency Numbers from API
async function loadEmergencyNumbers() {
    try {
        const response = await fetch(`/api/medical/emergency-numbers?language=${state.currentLanguage}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success && data.numbers) {
            displayEmergencyNumbers(data.numbers);
        }
    } catch (error) {
        console.error('Emergency numbers error:', error);
        // Fallback to default Turkey numbers
        displayDefaultEmergencyNumbers();
    }
}

// Display Emergency Numbers in Modal
function displayEmergencyNumbers(numbers) {
    const emergencyGrid = document.querySelector('.emergency-grid');
    emergencyGrid.innerHTML = '';

    numbers.forEach(item => {
        const card = document.createElement('div');
        card.className = 'emergency-card';
        card.innerHTML = `
            <div class="emergency-number">${item.number}</div>
            <div class="emergency-label">${item.label}</div>
        `;
        emergencyGrid.appendChild(card);
    });
}

// Fallback Emergency Numbers
function displayDefaultEmergencyNumbers() {
    const defaultNumbers = [
        { number: '112', label: 'Emergency Medical Services' },
        { number: '184', label: 'Poison Control' },
        { number: '182', label: 'Psychiatric Hotline' },
        { number: '155', label: 'Police Emergency' },
        { number: '110', label: 'Fire Department' },
        { number: '183', label: 'ALO 183 Healthcare' }
    ];
    displayEmergencyNumbers(defaultNumbers);
}

// Initialize Application
function init() {
    loadConversations();
    loadCurrentLanguage();
    setupEventListeners();
    initializeSpecialtySelection();
    loadEmergencyNumbers();

    // Welcome message
    setTimeout(() => {
        if (state.messages.length === 0) {
            addWelcomeMessage();
        }
    }, 500);
}

// Setup Event Listeners
function setupEventListeners() {
    messageInput.addEventListener('input', autoResizeTextarea);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// Auto-resize Textarea
function autoResizeTextarea() {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
}

// Toggle Sidebar
function toggleSidebar() {
    sidebar.classList.toggle('collapsed');
}

// New Consultation
function newConsultation() {
    state.messages = [];
    state.currentConversationId = Date.now().toString();
    emptyState.style.display = 'flex';
    addWelcomeMessage();
}

// Specialty Selection
function initializeSpecialtySelection() {
    const specialtyItems = document.querySelectorAll('.specialization-item');
    specialtyItems.forEach(item => {
        item.addEventListener('click', () => {
            specialtyItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            state.currentSpecialty = item.dataset.specialty;
            updateChatTitle();
        });
    });
}

function updateChatTitle() {
    const specialtyNames = {
        general: 'General Medicine',
        cardiology: 'Cardiology',
        neurology: 'Neurology',
        radiology: 'Radiology',
        oncology: 'Oncology',
        pediatrics: 'Pediatrics',
        psychiatry: 'Psychiatry',
        orthopedics: 'Orthopedics'
    };
    chatTitle.querySelector('span').textContent = specialtyNames[state.currentSpecialty] || 'Medical AI Expert';
}

// Language Management
function changeLanguage() {
    state.currentLanguage = languageSelector.value;
    localStorage.setItem('medical_ai_language', state.currentLanguage);
    addSystemMessage(`Language changed to ${languageSelector.options[languageSelector.selectedIndex].text}`);
}

function loadCurrentLanguage() {
    const savedLang = localStorage.getItem('medical_ai_language');
    if (savedLang) {
        state.currentLanguage = savedLang;
        languageSelector.value = savedLang;
    }
}

// Welcome Message
function addWelcomeMessage() {
    const welcomeMessages = {
        tr: `Merhaba! Ben LyDian TÄ±p UzmanÄ± AI'Ä±yÄ±m.\n\nSize yardÄ±mcÄ± olabileceÄŸim konular:\n- Semptom analizi ve Ã¶n deÄŸerlendirme\n- Ä°laÃ§ etkileÅŸimleri kontrolÃ¼\n- TÄ±bbi gÃ¶rÃ¼ntÃ¼ analizi (X-ray, CT, MRI)\n- Laboratuvar sonuÃ§larÄ± yorumlama\n- Genel saÄŸlÄ±k bilgilendirmesi\n\nâš ï¸ Ã–nemli: Bu bilgiler genel amaÃ§lÄ±dÄ±r. Acil durumlar iÃ§in 112'yi arayÄ±n.`,
        en: `Hello! I'm LyDian Medical AI Expert.\n\nI can help you with:\n- Symptom analysis and preliminary assessment\n- Drug interaction checking\n- Medical image analysis (X-ray, CT, MRI)\n- Lab results interpretation\n- General health information\n\nâš ï¸ Important: This is for informational purposes only. For emergencies, call 112.`,
        de: `Hallo! Ich bin LyDian Medical AI Experte.\n\nIch kann Ihnen helfen mit:\n- Symptomanalyse und VorabprÃ¼fung\n- Arzneimittelwechselwirkungen\n- Medizinische Bildanalyse (RÃ¶ntgen, CT, MRT)\n- Laborergebnisse Interpretation\n- Allgemeine Gesundheitsinformationen`,
        fr: `Bonjour! Je suis LyDian Medical AI Expert.\n\nJe peux vous aider avec:\n- Analyse des symptÃ´mes\n- Interactions mÃ©dicamenteuses\n- Analyse d'images mÃ©dicales\n- InterprÃ©tation des rÃ©sultats de laboratoire\n- Informations gÃ©nÃ©rales sur la santÃ©`,
        es: `Â¡Hola! Soy LyDian Medical AI Expert.\n\nPuedo ayudarte con:\n- AnÃ¡lisis de sÃ­ntomas\n- Interacciones medicamentosas\n- AnÃ¡lisis de imÃ¡genes mÃ©dicas\n- InterpretaciÃ³n de resultados de laboratorio\n- InformaciÃ³n general de salud`,
        ar: 'Ù…Ø±Ø­Ø¨Ø§! Ø£Ù†Ø§ Ø®Ø¨ÙŠØ± LyDian Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ.\n\nÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:\n- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶\n- Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ©\n- ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø·Ø¨ÙŠØ©\n- ØªÙØ³ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø®ØªØ¨Ø±\n- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ­ÙŠØ© Ø¹Ø§Ù…Ø©',
        ru: `Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð¯ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ð¹ ÑÐºÑÐ¿ÐµÑ€Ñ‚ LyDian AI.\n\nÐ¯ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð²Ð°Ð¼ Ñ:\n- ÐÐ½Ð°Ð»Ð¸Ð·Ð¾Ð¼ ÑÐ¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ð¾Ð²\n- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹\n- ÐÐ½Ð°Ð»Ð¸Ð·Ð¾Ð¼ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ñ… Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹\n- Ð˜Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð°Ñ†Ð¸ÐµÐ¹ Ð»Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð½Ñ‹Ñ… Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²\n- ÐžÐ±Ñ‰ÐµÐ¹ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹`,
        zh: `æ‚¨å¥½ï¼æˆ‘æ˜¯ LyDian åŒ»ç–— AI ä¸“å®¶ã€‚\n\næˆ‘å¯ä»¥å¸®åŠ©æ‚¨:\n- ç—‡çŠ¶åˆ†æž\n- è¯ç‰©ç›¸äº’ä½œç”¨æ£€æŸ¥\n- åŒ»å­¦å½±åƒåˆ†æž\n- å®žéªŒå®¤ç»“æžœè§£è¯»\n- ä¸€èˆ¬å¥åº·ä¿¡æ¯`
    };

    const message = welcomeMessages[state.currentLanguage] || welcomeMessages.en;
    addMessage(message, false);
}

// Send Message
async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    // Add user message
    addMessage(text, true);
    messageInput.value = '';
    autoResizeTextarea();

    // Disable send button
    sendBtn.disabled = true;

    // Show typing indicator
    showTypingIndicator();
    updateAIStatus('thinking', 'Medical AI');

    try {
        // Enhanced medical system prompt
        const medicalContext = `You are a specialized AI medical assistant powered by Azure AI and Azure Health Data Services.
Current specialty context: ${state.currentSpecialty}
Language: ${state.currentLanguage}

Your capabilities include:
- Symptom analysis with differential diagnosis
- Medical image interpretation (X-ray, CT, MRI)
- Drug interaction checking via FDA/EMA databases
- Lab results interpretation
- Medical literature search (PubMed integration)
- HIPAA-compliant healthcare guidance

Always remind users that this is for informational purposes only and not a substitute for professional medical advice.
For emergencies, advise calling 112 (emergency services).`;

        // Call REAL Azure-powered medical chat API
        const response = await fetch('/api/medical/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'premium-model-1', // Hidden AI model name
                message: text,
                language: state.currentLanguage,
                systemPrompt: medicalContext,
                specialty: state.currentSpecialty
            })
        });

        const data = await response.json();

        hideTypingIndicator();
        updateAIStatus('ready');

        if (data.success && data.response) {
            // Display model info if available
            if (data.model) {
                updateAIStatus('ready', data.model);
                setTimeout(() => updateAIStatus('ready'), 3000);
            }

            addMessage(data.response, false);

            // If symptoms detected, also call RAG diagnosis API
            if (detectSymptoms(text)) {
                await performRAGDiagnosis(text);
            }

            saveToLocalStorage();
        } else {
            throw new Error(data.error || 'API response error');
        }
    } catch (error) {
        hideTypingIndicator();
        updateAIStatus('error');
        setTimeout(() => updateAIStatus('ready'), 3000);
        console.error('Chat error:', error);
        addMessage('An error occurred. Please check your connection and try again.', false);
    } finally {
        sendBtn.disabled = false;
    }
}

// Add Message to Chat
function addMessage(content, isUser = false) {
    emptyState.style.display = 'none';

    const message = {
        id: Date.now().toString(),
        role: isUser ? 'user' : 'ai',
        content: content,
        timestamp: new Date().toISOString()
    };

    state.messages.push(message);
    renderMessage(message);
    scrollToBottom();
}

// Add System Message
function addSystemMessage(content) {
    const systemMsg = document.createElement('div');
    systemMsg.style.cssText = 'text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.875rem;';
    systemMsg.textContent = content;
    messagesContainer.appendChild(systemMsg);
    scrollToBottom();
}

// Render Single Message
function renderMessage(msg) {
    const isUser = msg.role === 'user';
    const time = new Date(msg.timestamp).toLocaleTimeString(state.currentLanguage, {
        hour: '2-digit',
        minute: '2-digit'
    });

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${msg.role}`;
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${isUser ? `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            ` : `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                    <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                    <circle cx="20" cy="10" r="2"/>
                </svg>
            `}
        </div>
        <div class="message-content">
            <div class="message-bubble">${escapeHtml(msg.content)}</div>
            <div class="message-time">${time}</div>
        </div>
    `;

    messagesContainer.appendChild(messageDiv);
}

// Typing Indicator
function showTypingIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'message ai';
    indicator.innerHTML = `
        <div class="message-avatar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
            </svg>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    `;
    messagesContainer.appendChild(indicator);
    scrollToBottom();
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

// Quick Actions
function handleQuickAction(action) {
    const prompts = {
        'symptom-analysis': 'I would like to describe my symptoms for analysis and preliminary assessment.',
        'drug-interaction': 'I need to check for potential drug interactions between medications.',
        'image-analysis': 'I want to upload medical images (X-ray, CT, or MRI) for AI analysis.',
        'medical-literature': 'I need to search medical literature and research papers on a specific condition.'
    };

    messageInput.value = prompts[action];
    messageInput.focus();
}

// Check if image is radiology-related
function isRadiologyImage(filename) {
    const radiologyKeywords = ['xray', 'x-ray', 'ct', 'mri', 'scan', 'dicom', 'radiolog'];
    return radiologyKeywords.some(keyword => filename.toLowerCase().includes(keyword));
}

// Perform Advanced Radiology Analysis
async function performRadiologyAnalysis(formData) {
    try {
        showTypingIndicator();
        updateAIStatus('thinking', 'Radiology AI');

        const response = await fetch('/api/medical/radiology-analysis', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();
        updateAIStatus('ready');

        if (data.success && data.analysis) {
            const radiologyMessage = `\n\nðŸ”¬ **Advanced Radiology Analysis**:\n\n${data.analysis}`;
            addMessage(radiologyMessage, false);
        }
    } catch (error) {
        console.error('Radiology analysis error:', error);
        hideTypingIndicator();
        updateAIStatus('ready');
    }
}

// File Upload Handler
async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const uploadZone = document.getElementById('uploadZone');
    uploadZone.style.borderColor = 'var(--medical-success)';
    uploadZone.style.background = 'rgba(16, 185, 129, 0.1)';

    addSystemMessage(`Uploading ${file.name}...`);
    showTypingIndicator();

    try {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('specialty', state.currentSpecialty);
        formData.append('language', state.currentLanguage);

        // Azure Computer Vision API for medical image analysis
        const response = await fetch('/api/medical/image-analysis', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success) {
            addMessage(`Medical Image Analysis: ${file.name}\n\n${data.analysis}`, false);

            // If radiology specialty or radiology-related image, also call advanced radiology analysis
            if (state.currentSpecialty === 'radiology' || isRadiologyImage(file.name)) {
                await performRadiologyAnalysis(formData);
            }
        } else {
            throw new Error(data.error || 'Image analysis failed');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('Image upload error:', error);
        addMessage('Image analysis failed. Please try again.', false);
    } finally {
        uploadZone.style.borderColor = '';
        uploadZone.style.background = '';
        event.target.value = '';
    }
}

// Voice Input Handler
async function handleVoiceInput() {
    const voiceBtn = document.getElementById('voiceBtn');

    if (!state.isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            state.mediaRecorder = new MediaRecorder(stream);
            state.audioChunks = [];

            state.mediaRecorder.ondataavailable = (event) => {
                state.audioChunks.push(event.data);
            };

            state.mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
                await transcribeAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };

            state.mediaRecorder.start();
            state.isRecording = true;

            voiceBtn.style.background = 'var(--medical-error)';
            voiceBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                </svg>
            `;
        } catch (error) {
            console.error('Microphone access error:', error);
            alert('Microphone access denied. Please allow microphone access in your browser settings.');
        }
    } else {
        if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
            state.mediaRecorder.stop();
            state.isRecording = false;

            voiceBtn.style.background = '';
            voiceBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
            `;
        }
    }
}

async function transcribeAudio(audioBlob) {
    try {
        showTypingIndicator();

        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        formData.append('language', state.currentLanguage);

        const response = await fetch('/api/speech/transcribe', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success && data.text) {
            messageInput.value = data.text;
            messageInput.focus();
        } else {
            throw new Error(data.error || 'Transcription failed');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('Transcription error:', error);
        alert('Speech transcription failed. Please try again.');
    }
}

// Emergency Modal
function showEmergencyModal() {
    loadEmergencyNumbers();
    document.getElementById('emergencyModal').classList.add('active');
}

function closeEmergencyModal() {
    document.getElementById('emergencyModal').classList.remove('active');
}

// Export Consultation
function exportConsultation() {
    if (state.messages.length === 0) {
        alert('No consultation to export.');
        return;
    }

    const exportData = {
        date: new Date().toISOString(),
        specialty: state.currentSpecialty,
        language: state.currentLanguage,
        messages: state.messages
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `medical-consultation-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Local Storage Management
function saveToLocalStorage() {
    try {
        const data = {
            messages: state.messages,
            specialty: state.currentSpecialty,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('medical_ai_session', JSON.stringify(data));
    } catch (error) {
        console.error('Save error:', error);
    }
}

function loadConversations() {
    try {
        const saved = localStorage.getItem('medical_ai_session');
        if (saved) {
            const data = JSON.parse(saved);
            state.messages = data.messages || [];
            state.currentSpecialty = data.specialty || 'general';

            if (state.messages.length > 0) {
                emptyState.style.display = 'none';
                state.messages.forEach(msg => renderMessage(msg));
            }
        }
    } catch (error) {
        console.error('Load error:', error);
    }
}

// Utilities
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

function scrollToBottom() {
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
}

// Initialize on load
window.addEventListener('load', init);

// Close modal on outside click
window.addEventListener('click', (e) => {
    const modal = document.getElementById('emergencyModal');
    if (e.target === modal) {
        closeEmergencyModal();
    }
});
    </script>
</body>
</html>
