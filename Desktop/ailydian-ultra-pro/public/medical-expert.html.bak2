<!-- Cache-Buster: 1759577324 -->
<!DOCTYPE html>
<html lang="tr" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyDian Medical AI - Healthcare Intelligence Expert</title>
    <link rel="icon" type="image/png" href="/lydian-logo.png">

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Righteous&display=swap" rel="stylesheet">

    <style>
/* ============================================================
   LYDIAN MEDICAL AI - ENTERPRISE HEALTHCARE SYSTEM 2025
   ============================================================ */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* Medical Blue Color System */
    --medical-primary: #0066CC;
    --medical-primary-hover: #0052A3;
    --medical-secondary: #00A3E0;
    --medical-accent: #4FC3F7;
    --medical-success: #10B981;
    --medical-warning: #F59E0B;
    --medical-error: #EF4444;
    --medical-info: #3B82F6;

    /* Clean Gradients */
    --gradient-medical: linear-gradient(135deg, #0066CC 0%, #00A3E0 100%);
    --gradient-success: linear-gradient(135deg, #10B981 0%, #34D399 100%);
    --gradient-header: linear-gradient(180deg, #FFFFFF 0%, #F9FAFB 100%);

    /* White Background System */
    --bg-primary: #FFFFFF;
    --bg-secondary: #F9FAFB;
    --bg-tertiary: #F3F4F6;
    --bg-hover: #FFFFFF;
    --bg-sidebar: #1E3A8A;
    --bg-sidebar-hover: #1E40AF;

    /* Text Colors */
    --text-primary: #1F2937;
    --text-secondary: #4B5563;
    --text-tertiary: #6B7280;
    --text-muted: #9CA3AF;
    --text-inverse: #ffffff;

    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-medical: 0 4px 12px rgba(0, 102, 204, 0.15);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.12);

    /* Borders */
    --border-light: 1px solid #E5E7EB;
    --border-medium: 1px solid #D1D5DB;
    --border-medical: 1px solid #0066CC;
    --border-dark: 1px solid rgba(255, 255, 255, 0.1);
}

/* ============================================================
   PREMIUM KEYFRAME ANIMATIONS
   ============================================================ */

@keyframes gradientFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes typingDot {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
    }
    30% {
        transform: translateY(-12px);
        opacity: 1;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    10%, 30% { transform: scale(0.9); }
    20%, 40% { transform: scale(1.1); }
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    display: flex;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ============================================================
   SIDEBAR - Medical Navigation
   ============================================================ */

.sidebar {
    width: 280px;
    background: var(--bg-sidebar);
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    border-right: var(--border-dark);
}

.sidebar.collapsed {
    transform: translateX(-300px);
}

.sidebar-header {
    padding: 1.5rem 1rem;
    border-bottom: var(--border-dark);
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-inverse);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    letter-spacing: 0.5px;
}

.logo-icon {
    width: 36px;
    height: 36px;
    background: var(--gradient-medical);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: heartbeat 2s infinite;
}

.new-consultation-btn {
    margin: 0.75rem;
    padding: 1rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: var(--text-inverse);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
}

.new-consultation-btn:hover {
    background: var(--bg-sidebar-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medical);
}

.specializations-list {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.specialization-item {
    padding: 0.875rem 1rem;
    background: transparent;
    border-radius: 10px;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9375rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.specialization-item:hover {
    background: var(--bg-sidebar-hover);
    color: var(--text-inverse);
    transform: translateX(4px);
}

.specialization-item.active {
    background: var(--bg-sidebar-hover);
    color: var(--text-inverse);
    border-left: 3px solid var(--medical-secondary);
}

.specialization-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

/* Dropdown Navigation Styles */
.nav-category {
    margin-bottom: 0.5rem;
}

.nav-category-header {
    padding: 0.875rem 1rem;
    background: transparent;
    border-radius: 10px;
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.nav-category-header:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-inverse);
}

.nav-category-header .dropdown-arrow {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.nav-category.open .dropdown-arrow {
    transform: rotate(180deg);
}

.nav-category-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding-left: 1rem;
}

.nav-category.open .nav-category-content {
    max-height: 1000px;
}

.nav-category .specialization-item {
    padding-left: 2.5rem;
}

.sidebar-footer {
    margin-top: auto;
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.emergency-btn {
    width: 100%;
    padding: 1rem;
    background: var(--medical-error);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
}

.emergency-btn:hover {
    background: #DC2626;
    transform: scale(1.02);
}

/* User Menu Dropdown Styles */
.user-menu-wrapper {
    position: relative;
}

.user-dropdown-item {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
}

.user-dropdown-item:hover {
    background: var(--bg-secondary);
}

.user-dropdown-item svg {
    color: var(--primary-accent);
}

/* ============================================================
   MAIN CHAT AREA
   ============================================================ */

.main-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}

.chat-header {
    padding: 1.25rem 2rem;
    background: var(--bg-primary);
    border-bottom: var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sidebar-toggle {
    width: 40px;
    height: 40px;
    background: transparent;
    border: var(--border-light);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: var(--text-secondary);
}

.sidebar-toggle:hover {
    background: var(--bg-secondary);
    border-color: var(--medical-primary);
    color: var(--medical-primary);
}

.chat-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.header-right {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.header-btn {
    padding: 0.625rem 1rem;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-primary);
}

.header-btn:hover {
    background: var(--medical-primary);
    border-color: var(--medical-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-medical);
}

.language-selector {
    padding: 0.625rem 1rem;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    color: var(--text-primary);
}

/* Medical Disclaimer Banner */
.medical-disclaimer-banner {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
    border-left: 4px solid var(--medical-error);
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.disclaimer-icon-banner {
    width: 40px;
    height: 40px;
    background: var(--medical-error);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.disclaimer-text {
    flex: 1;
    font-size: 0.9375rem;
    color: var(--text-primary);
    line-height: 1.6;
}

/* Messages Container */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    background: var(--bg-secondary);
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 2rem;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: var(--gradient-medical);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    animation: fadeInScale 0.5s ease;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

.empty-subtitle {
    font-size: 1.0625rem;
    color: var(--text-tertiary);
    margin-bottom: 2rem;
    max-width: 500px;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
    max-width: 900px;
}

.quick-action-card {
    padding: 1.5rem;
    background: var(--bg-primary);
    border: var(--border-light);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.quick-action-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-medical);
    border-color: var(--medical-primary);
}

.quick-action-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 163, 224, 0.1));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: var(--medical-primary);
}

.quick-action-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.quick-action-desc {
    font-size: 0.875rem;
    color: var(--text-tertiary);
    line-height: 1.5;
}

/* Message Styles */
.message {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    animation: messageAppear 0.3s ease;
}

.message.user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: var(--shadow-base);
}

.message.user .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.message.ai .message-avatar {
    background: var(--gradient-medical);
}

.message-content {
    flex: 1;
    max-width: 70%;
}

.message-bubble {
    padding: 1rem 1.25rem;
    border-radius: 16px;
    line-height: 1.6;
    font-size: 0.9375rem;
}

.message.user .message-bubble {
    background: var(--medical-primary);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.ai .message-bubble {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: var(--border-light);
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
    padding-left: 0.25rem;
}

.typing-indicator {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: var(--medical-primary);
    border-radius: 50%;
    animation: typingDot 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

/* Input Area */
.input-area {
    background: var(--bg-primary);
    border-top: var(--border-light);
    padding: 1.5rem 2rem;
}

.medical-upload-zone {
    margin-bottom: 1rem;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 2px dashed #D1D5DB;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.medical-upload-zone:hover {
    border-color: var(--medical-primary);
    background: rgba(0, 102, 204, 0.05);
}

.upload-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 0.75rem;
    background: var(--gradient-medical);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.upload-text {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.upload-subtext {
    font-size: 0.8125rem;
    color: var(--text-tertiary);
}

.input-wrapper {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.message-input {
    flex: 1;
    padding: 1rem 1.25rem;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 12px;
    font-size: 0.9375rem;
    font-family: 'Inter', sans-serif;
    resize: none;
    min-height: 56px;
    max-height: 200px;
    transition: all 0.3s ease;
}

.message-input:focus {
    outline: none;
    border-color: var(--medical-primary);
    box-shadow: var(--shadow-medical);
}

.input-actions {
    display: flex;
    gap: 0.75rem;
}

.input-btn {
    width: 56px;
    height: 56px;
    background: var(--bg-secondary);
    border: var(--border-light);
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: var(--text-secondary);
}

.input-btn:hover {
    background: var(--medical-primary);
    border-color: var(--medical-primary);
    color: white;
    transform: translateY(-2px);
}

.send-btn {
    background: var(--gradient-medical);
    border: none;
    color: white;
    padding: 0 1.5rem;
    width: auto;
    font-weight: 700;
}

.send-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medical);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--bg-primary);
    border-radius: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    animation: fadeInScale 0.3s ease;
}

.modal-header {
    padding: 1.5rem 2rem;
    border-bottom: var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 5;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-close {
    width: 36px;
    height: 36px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
    color: var(--text-secondary);
    position: relative;
    z-index: 10;
    pointer-events: auto;
}

.modal-close svg {
    pointer-events: none;
}

.modal-close:hover {
    background: var(--bg-secondary);
    color: var(--medical-error);
}

.modal-body {
    padding: 2rem;
}

.emergency-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.emergency-card {
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.emergency-card:hover {
    transform: translateY(-4px);
    border-color: var(--medical-error);
    box-shadow: var(--shadow-lg);
}

.emergency-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--medical-error);
    margin-bottom: 0.5rem;
}

.emergency-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
}

/* Responsive Design */
@media (max-width: 768px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        transform: translateX(-300px);
    }

    .sidebar.active {
        transform: translateX(0);
    }

    .quick-actions {
        grid-template-columns: 1fr;
    }

    .message-content {
        max-width: 85%;
    }

    .input-wrapper {
        flex-wrap: wrap;
    }

    .emergency-grid {
        grid-template-columns: 1fr;
    }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
    background: #D1D5DB;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--medical-primary);
}
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                        <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                        <circle cx="20" cy="10" r="2"/>
                    </svg>
                </div>
                <span>LyDian Medical AI</span>
            </div>
        </div>

        <button class="new-consultation-btn" onclick="newConsultation()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New Consultation
        </button>

        <div class="specializations-list" id="specializationsList">

            <!-- Medical Specialties Dropdown -->
            <div class="nav-category">
                <div class="nav-category-header" onclick="toggleCategory('specialties')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                    </svg>
                    <span>Medical Specialties</span>
                    <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="nav-category-content" id="specialties-content">
                    <div class="specialization-item active" data-specialty="general-medicine" onclick="showPanel('general-medicine')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                            </svg>
                        </div>
                        <span>General Medicine</span>
                    </div>

                    <div class="specialization-item" data-specialty="cardiology" onclick="showPanel('cardiology')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"/>
                            </svg>
                        </div>
                        <span>Cardiology</span>
                    </div>

                    <div class="specialization-item" data-specialty="neurology" onclick="showPanel('neurology')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                                <path d="M12 15v7"/>
                                <path d="M8 19h8"/>
                            </svg>
                        </div>
                        <span>Neurology</span>
                    </div>

                    <div class="specialization-item" data-specialty="radiology" onclick="showPanel('dicom-upload')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                        <span>Radiology</span>
                    </div>

                    <div class="specialization-item" data-specialty="oncology" onclick="showPanel('oncology')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <span>Oncology</span>
                    </div>

                    <div class="specialization-item" data-specialty="pediatrics" onclick="showPanel('pediatrics')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a3 3 0 0 0-3 3v4a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                                <path d="M12 9v13"/>
                                <path d="M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2"/>
                            </svg>
                        </div>
                        <span>Pediatrics</span>
                    </div>

                    <div class="specialization-item" data-specialty="psychiatry" onclick="showPanel('psychiatry')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </div>
                        <span>Psychiatry</span>
                    </div>

                    <div class="specialization-item" data-specialty="orthopedics" onclick="showPanel('orthopedics')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
                            </svg>
                        </div>
                        <span>Orthopedics</span>
                    </div>
                </div>
            </div>

            <!-- Medical Tools Dropdown -->
            <div class="nav-category">
                <div class="nav-category-header" onclick="toggleCategory('tools')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                    </svg>
                    <span>Medical Tools</span>
                    <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="nav-category-content" id="tools-content">

            <div class="specialization-item" onclick="showPanel('rag-search')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                </div>
                <span>RAG Literature Search</span>
            </div>

            <div class="specialization-item" onclick="showPanel('dicom-upload')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                </div>
                <span>DICOM Upload</span>
            </div>

            <div class="specialization-item" onclick="showPanel('fhir-patient')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <span>Patient Records</span>
            </div>

            <div class="specialization-item" onclick="showPanel('speech-transcription')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </div>
                <span>Voice Transcription</span>
            </div>

            <div class="specialization-item" onclick="showPanel('translate')">
                <div class="specialization-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8l6 6"/>
                        <path d="M4 14l6-6 2-3"/>
                        <path d="M2 5h12"/>
                        <path d="M7 2h1"/>
                        <path d="m22 22-5-10-5 10"/>
                        <path d="M14 18h6"/>
                    </svg>
                </div>
                <span>Medical Translate</span>
            </div>
                </div>
            </div>

            <!-- Advanced Medical AI Dropdown -->
            <div class="nav-category">
                <div class="nav-category-header" onclick="toggleCategory('advanced-ai')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6"/>
                        <circle cx="12" cy="16" r="1"/>
                    </svg>
                    <span>Advanced Medical AI</span>
                    <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="nav-category-content" id="advanced-ai-content">
                    <div class="specialization-item" onclick="showPanel('rare-disease')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a10 10 0 0 1 10 10c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2z"/>
                                <path d="M12 6v6"/>
                                <circle cx="12" cy="16" r="1"/>
                                <path d="M9 9l6 6"/>
                            </svg>
                        </div>
                        <span>Rare Disease Diagnosis</span>
                    </div>

                    <div class="specialization-item" onclick="showPanel('mental-health')">
                        <div class="specialization-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                        </div>
                        <span>Mental Health Triage</span>
                    </div>
                    <div class="specialization-item" onclick="showPanel('emergency-triage')">
                        <div class="specialization-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="4" y="4" width="16" height="16" rx="2"/>
                                <path d="M12 8v8"/>
                                <path d="M8 12h8"/>
                            </svg>
                        </div>
                        <span>Emergency Triage</span>
                    </div>
                    <div class="specialization-item" onclick="showPanel('sepsis-warning')">
                        <div class="specialization-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M2 12h20"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </div>
                        <span>Sepsis Early Warning</span>
                    </div>
                    <div class="specialization-item" onclick="showPanel('multimodal-fusion')">
                        <div class="specialization-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                <line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                        </div>
                        <span>Multimodal Data Fusion</span>
                    </div>
                    <div class="specialization-item" onclick="showPanel('maternal-fetal')">
                        <div class="specialization-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                        </div>
                        <span>Maternal-Fetal Health</span>
                    </div>
                </div>
            </div>

            <!-- Neuro Health AI Dropdown -->
            <div class="nav-category">
                <div class="nav-category-header" onclick="toggleCategory('neuro-ai')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <span>Neuro Health AI</span>
                    <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="nav-category-content" id="neuro-ai-content">
                    <div class="specialization-item" onclick="showPanel('neuro-imaging')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                        <path d="M12 15v7"/>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M8 12h8"/>
                    </svg>
                </div>
                <span>Brain Imaging Analysis</span>
            </div>

            <div class="specialization-item" onclick="showPanel('neuro-health-index')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                        <path d="M8 12h8"/>
                    </svg>
                </div>
                <span>Neuro Health Index</span>
            </div>

            <div class="specialization-item" onclick="showPanel('neuro-risk')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 9v4"/>
                        <path d="M12 17h.01"/>
                        <path d="M10 2 L14 2 L21 12 L12 22 L3 12 Z"/>
                    </svg>
                </div>
                <span>Risk Assessment</span>
            </div>

            <div class="specialization-item" onclick="showPanel('neuro-twin')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="7" r="4"/>
                        <circle cx="15" cy="7" r="4"/>
                        <path d="M9 11v10"/>
                        <path d="M15 11v10"/>
                        <path d="M5 21h8"/>
                        <path d="M11 21h8"/>
                    </svg>
                </div>
                <span>Digital Neuro-Twin</span>
            </div>

            <div class="specialization-item" onclick="showPanel('neuro-clinician')">
                <div class="specialization-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M16 11l2 2 4-4"/>
                    </svg>
                </div>
                <span>Clinician Portal</span>
            </div>
                </div>
            </div>

        </div>

        <div class="sidebar-footer">
            <button class="emergency-btn" onclick="showEmergencyModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M10 3h4l2 6h6l-5 4 2 6-6-4-6 4 2-6-5-4h6l2-6z"/>
                </svg>
                Emergency Numbers
            </button>

            <!-- Hospital Management Panel -->
            <div class="user-menu-wrapper" style="margin-top: 12px; position: relative;">
                <button class="user-menu-btn" onclick="toggleUserDropdown(event)" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>Hospital Account</span>
                    </div>
                    <svg id="dropdownArrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </button>

                <!-- User Dropdown Menu -->
                <div class="user-dropdown" id="userDropdown" style="display: none; position: absolute; bottom: 100%; left: 0; right: 0; background: var(--bg-primary); border-radius: 12px; box-shadow: 0 -4px 12px rgba(0,0,0,0.15); margin-bottom: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); z-index: 1000;">
                    <div class="user-dropdown-item" onclick="showPatientHistory(); document.getElementById('userDropdown').style.display='none';" style="padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="21 8 21 21 3 21 3 8"/>
                            <rect x="1" y="3" width="22" height="5"/>
                            <line x1="10" y1="12" x2="14" y2="12"/>
                        </svg>
                        <span>Patient History</span>
                    </div>
                    <div class="user-dropdown-item" onclick="showHospitalSettings(); document.getElementById('userDropdown').style.display='none';" style="padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
                        </svg>
                        <span>Hospital Settings</span>
                    </div>
                    <div class="user-dropdown-item" onclick="logoutHospital(); document.getElementById('userDropdown').style.display='none';" style="padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; color: #EF4444;" onmouseover="this.style.background='rgba(239,68,68,0.1)'" onmouseout="this.style.background='transparent'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Sign Out</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <h1 class="chat-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                        <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                        <circle cx="20" cy="10" r="2"/>
                    </svg>
                    <span id="chatTitle">Medical AI Expert</span>
                </h1>
            </div>

            <div class="header-right">
                <div id="aiStatusBadge" style="padding: 0.625rem 1rem; background: linear-gradient(135deg, #10B981, #34D399); border-radius: 10px; color: white; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <span>AI Ready</span>
                </div>
                <select class="language-selector" id="languageSelector" onchange="changeLanguage()">
                    <option value="tr">Turkish</option>
                    <option value="en">English</option>
                    <option value="de">German</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="ar">Arabic</option>
                    <option value="ru">Russian</option>
                    <option value="zh">Chinese</option>
                </select>
                <button class="header-btn" onclick="exportConsultation()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <!-- Medical Disclaimer Banner -->
        <div class="medical-disclaimer-banner">
            <div class="disclaimer-icon-banner">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
            </div>
            <div class="disclaimer-text">
                <strong>Important Medical Disclaimer:</strong> This AI assistant provides general health information only and does not replace professional medical diagnosis, treatment, or advice. Always consult a healthcare provider for medical concerns. For emergencies, call 911 (US) or your local emergency number.
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                        <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                        <circle cx="20" cy="10" r="2"/>
                    </svg>
                </div>
                <h2 class="empty-title">Welcome to LyDian Medical AI</h2>
                <p class="empty-subtitle">Your AI-powered healthcare assistant. Ask medical questions, analyze symptoms, or upload medical images for analysis.</p>

                <div class="quick-actions">
                    <div class="quick-action-card" onclick="handleQuickAction('symptom-analysis')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Symptom Analysis</div>
                        <div class="quick-action-desc">Describe your symptoms for AI-powered differential diagnosis</div>
                    </div>

                    <div class="quick-action-card" onclick="handleQuickAction('drug-interaction')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <path d="M12 8v8"/>
                                <path d="M8 12h8"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Drug Interaction</div>
                        <div class="quick-action-desc">Check medication interactions and side effects</div>
                    </div>

                    <div class="quick-action-card" onclick="handleQuickAction('image-analysis')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Medical Image Analysis</div>
                        <div class="quick-action-desc">Upload X-rays, CT scans, or MRI for AI analysis</div>
                    </div>

                    <div class="quick-action-card" onclick="handleQuickAction('medical-literature')">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                        </div>
                        <div class="quick-action-title">Medical Literature</div>
                        <div class="quick-action-desc">Search PubMed and medical journals</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="medical-upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*,.pdf,.dcm" style="display: none;" onchange="handleFileUpload(event)">
                <div class="upload-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <div class="upload-text">Upload Medical Documents</div>
                <div class="upload-subtext">X-Ray, CT Scan, MRI, Lab Results, Medical Records (PDF, DICOM, JPG, PNG)</div>
            </div>

            <div class="input-wrapper">
                <textarea
                    class="message-input"
                    id="messageInput"
                    placeholder="Describe your symptoms, ask medical questions, or upload medical images..."
                    maxlength="5000"
                    rows="1"
                ></textarea>
                <div class="input-actions">
                    <button class="input-btn" id="voiceBtn" onclick="handleVoiceInput()" title="Voice Input">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </button>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RAG Literature Search Modal -->
    <div class="modal" id="ragSearchModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    RAG Literature Search
                </div>
                <button class="modal-close" onclick="closePanel('ragSearchModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="ragSearchInput" placeholder="Search PubMed, WHO Guidelines..." style="width: 100%; padding: 1rem; border: var(--border-light); border-radius: 10px; margin-bottom: 1rem; font-size: 1rem;">
                <button onclick="performRAGSearch()" style="padding: 0.75rem 1.5rem; background: var(--gradient-medical); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">Search Literature</button>
                <div id="ragResults" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- DICOM Upload Modal -->
    <div class="modal" id="dicomUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    DICOM Image Upload
                </div>
                <button class="modal-close" onclick="closePanel('dicomUploadModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="file" id="dicomFileInput" accept=".dcm,.dicom" style="display: none;" onchange="uploadDICOM(event)">
                <div onclick="document.getElementById('dicomFileInput').click()" style="padding: 3rem; border: 2px dashed #D1D5DB; border-radius: 12px; text-align: center; cursor: pointer; margin-bottom: 1rem;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 1rem; color: var(--medical-primary);">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Upload DICOM File</div>
                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">X-Ray, CT, MRI, or other medical images (.dcm)</div>
                </div>
                <div id="dicomResults"></div>
            </div>
        </div>
    </div>

    <!-- FHIR Patient Records Modal -->
    <div class="modal" id="fhirPatientModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    FHIR Patient Records
                </div>
                <button class="modal-close" onclick="closePanel('fhirPatientModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="patientGivenName" placeholder="Given Name" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 10px; margin-bottom: 0.75rem;">
                <input type="text" id="patientFamilyName" placeholder="Family Name" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 10px; margin-bottom: 0.75rem;">
                <select id="patientGender" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 10px; margin-bottom: 0.75rem;">
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
                <input type="date" id="patientBirthDate" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 10px; margin-bottom: 1rem;">
                <button onclick="createFHIRPatient()" style="width: 100%; padding: 0.75rem 1.5rem; background: var(--gradient-medical); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">Create Patient Record</button>
                <div id="fhirResults" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Speech Transcription Modal -->
    <div class="modal" id="speechTranscriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                    Voice Transcription
                </div>
                <button class="modal-close" onclick="closePanel('speechTranscriptionModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="file" id="audioFileInput" accept="audio/*" style="display: none;" onchange="uploadAudio(event)">
                <button id="recordBtn" onclick="toggleRecording()" style="width: 100%; padding: 2rem; background: var(--gradient-medical); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.125rem; cursor: pointer; margin-bottom: 1rem;">
                     Start Recording
                </button>
                <button onclick="document.getElementById('audioFileInput').click()" style="width: 100%; padding: 1rem; background: var(--bg-secondary); border: var(--border-light); border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">
                     Upload Audio File
                </button>
                <div id="transcriptionResults"></div>
            </div>
        </div>
    </div>

    <!-- Medical Translate Modal -->
    <div class="modal" id="translateModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8l6 6"/>
                        <path d="M4 14l6-6 2-3"/>
                        <path d="M2 5h12"/>
                        <path d="M7 2h1"/>
                        <path d="m22 22-5-10-5 10"/>
                        <path d="M14 18h6"/>
                    </svg>
                    Medical Translation
                </div>
                <button class="modal-close" onclick="closePanel('translateModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <textarea id="translateInput" placeholder="Enter medical text to translate..." style="width: 100%; padding: 1rem; border: var(--border-light); border-radius: 10px; min-height: 120px; margin-bottom: 1rem; font-family: 'Inter', sans-serif;"></textarea>
                <select id="targetLanguage" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 10px; margin-bottom: 1rem;">
                    <option value="en">English</option>
                    <option value="tr">Turkish</option>
                    <option value="de">German</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="ar">Arabic</option>
                    <option value="ru">Russian</option>
                    <option value="zh">Chinese</option>
                </select>
                <button onclick="performTranslation()" style="width: 100%; padding: 0.75rem 1.5rem; background: var(--gradient-medical); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">Translate</button>
                <div id="translationResults"></div>
            </div>
        </div>
    </div>

    <!-- Emergency Numbers Modal -->
    <div class="modal" id="emergencyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                     US Emergency Medical Numbers
                </div>
                <button class="modal-close" onclick="closeEmergencyModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="emergency-grid">
                    <div class="emergency-card" style="border-left: 4px solid #DC2626;">
                        <div class="emergency-number" style="color: #DC2626; font-size: 2rem;">911</div>
                        <div class="emergency-label" style="font-weight: 700;">Emergency Services</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">Police  Fire  Medical</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #7C3AED;">
                        <div class="emergency-number" style="color: #7C3AED;">988</div>
                        <div class="emergency-label" style="font-weight: 600;">Suicide & Crisis Lifeline</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">24/7 Crisis Support</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #0891B2;">
                        <div class="emergency-number" style="color: #0891B2;">211</div>
                        <div class="emergency-label">Community Resources</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">Social Services</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #059669;">
                        <div class="emergency-number" style="color: #059669;">1-800-222-1222</div>
                        <div class="emergency-label">Poison Control</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">24/7 Expert Help</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #DC2626;">
                        <div class="emergency-number" style="color: #DC2626; font-size: 0.95rem;">1-800-799-7233</div>
                        <div class="emergency-label">Domestic Violence</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">National Hotline</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #EA580C;">
                        <div class="emergency-number" style="color: #EA580C; font-size: 0.95rem;">1-800-656-4673</div>
                        <div class="emergency-label">Sexual Assault</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">RAINN Hotline</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #2563EB;">
                        <div class="emergency-number" style="color: #2563EB;">311</div>
                        <div class="emergency-label">Non-Emergency Services</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">Government Info</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #7C3AED;">
                        <div class="emergency-number" style="color: #7C3AED; font-size: 0.95rem;">1-800-662-4357</div>
                        <div class="emergency-label">SAMHSA Hotline</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">Drug & Alcohol</div>
                    </div>
                    <div class="emergency-card" style="border-left: 4px solid #DB2777;">
                        <div class="emergency-number" style="color: #DB2777; font-size: 0.95rem;">1-866-488-7386</div>
                        <div class="emergency-label">Trevor Project</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">LGBTQ+ Youth Crisis</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MEDICAL SPECIALTY PANELS -->

    <!-- General Medicine Panel -->
    <div class="modal" id="generalMedicineModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                    </svg>
                    General Medicine Tools
                </div>
                <button class="modal-close" onclick="closePanel('generalMedicineModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Vital Signs Assessment -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Vital Signs Assessment</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="gmSystolic" placeholder="Systolic BP (mmHg)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gmDiastolic" placeholder="Diastolic BP (mmHg)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gmHeartRate" placeholder="Heart Rate (bpm)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gmTemp" placeholder="Temperature (C)" step="0.1" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gmSpO2" placeholder="SpO2 (%)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gmRespRate" placeholder="Resp Rate (/min)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <button onclick="assessVitalSigns()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Assess Vital Signs</button>
                    <div id="vitalSignsResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- BMI Calculator -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">BMI Calculator</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="gmWeight" placeholder="Weight (kg)" step="0.1" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gmHeight" placeholder="Height (m)" step="0.01" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <select id="gmUnit" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="metric">Metric</option>
                            <option value="imperial">Imperial</option>
                        </select>
                    </div>
                    <button onclick="calculateBMI()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate BMI</button>
                    <div id="bmiResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- Prescription Formatter -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Prescription Formatter</h3>
                    <input type="text" id="gmPatientName" placeholder="Patient Name" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px; margin-bottom: 0.75rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <input type="number" id="gmPatientAge" placeholder="Age" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <select id="gmPatientGender" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="">Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <textarea id="gmMedications" placeholder='Medications (JSON format)
Example: [{"name":"Amoxicillin","strength":"500mg","dosage":"1 tablet","frequency":"3 times daily","duration":"7 days","quantity":"21 tablets"}]' style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px; min-height: 120px; font-family: monospace; margin-bottom: 0.75rem;"></textarea>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <input type="text" id="gmPhysicianName" placeholder="Physician Name" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="text" id="gmPhysicianLicense" placeholder="License Number" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <button onclick="formatPrescription()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Generate Prescription</button>
                    <div id="prescriptionResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cardiology Panel -->
    <div class="modal" id="cardiologyModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"/>
                    </svg>
                    Cardiology Tools
                </div>
                <button class="modal-close" onclick="closePanel('cardiologyModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Framingham Risk Score -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Framingham Risk Score (10-Year CVD Risk)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="cardioAge" placeholder="Age" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <select id="cardioGender" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="">Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <input type="number" id="cardioTotalChol" placeholder="Total Cholesterol (mg/dL)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="cardioHDL" placeholder="HDL Cholesterol (mg/dL)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="cardioSystolic" placeholder="Systolic BP (mmHg)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <div style="margin-top: 0.75rem; display: flex; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="cardioSmoker"> Smoker
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="cardioDiabetic"> Diabetic
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="cardioOnBPMeds"> On BP Medications
                        </label>
                    </div>
                    <button onclick="calculateFramingham()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Risk</button>
                    <div id="framinghamResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- CHA2DS2-VASc Score -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">CHA2DS2-VASc Score (AFib Stroke Risk)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="chadsAge" placeholder="Age" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <select id="chadsGender" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="">Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div style="margin-top: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="chadsHF"> Congestive HF
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="chadsHTN"> Hypertension
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="chadsDM"> Diabetes
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="chadsStroke"> Stroke/TIA
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="chadsVascular"> Vascular Disease
                        </label>
                    </div>
                    <button onclick="calculateCHADS2VASc()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Score</button>
                    <div id="chadsResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- HAS-BLED Score -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">HAS-BLED Score (Bleeding Risk)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledHTN"> Hypertension
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledRenal"> Renal Disease
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledLiver"> Liver Disease
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledStroke"> Stroke History
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledBleed"> Prior Bleeding
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledINR"> Labile INR
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledElderly"> Age > 65
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledDrugs"> Drugs/Alcohol
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasbledAntiplatelets"> Antiplatelets
                        </label>
                    </div>
                    <button onclick="calculateHASBLED()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Score</button>
                    <div id="hasbledResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- QTc Calculator -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">QTc Calculator</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="qtInterval" placeholder="QT Interval (ms)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="qtHeartRate" placeholder="Heart Rate (bpm)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <select id="qtFormula" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="bazett">Bazett Formula</option>
                            <option value="fridericia">Fridericia Formula</option>
                        </select>
                    </div>
                    <button onclick="calculateQTc()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate QTc</button>
                    <div id="qtcResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- Cardiac Output -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Cardiac Output Calculator</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="coHeartRate" placeholder="Heart Rate (bpm)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="coStrokeVolume" placeholder="Stroke Volume (mL)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="coWeight" placeholder="Weight (kg)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="coHeight" placeholder="Height (cm)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <button onclick="calculateCardiacOutput()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Cardiac Output</button>
                    <div id="cardiacOutputResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Neurology Panel -->
    <div class="modal" id="neurologyModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                        <path d="M12 15v7"/>
                        <path d="M8 19h8"/>
                    </svg>
                    Neurology Tools
                </div>
                <button class="modal-close" onclick="closePanel('neurologyModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Glasgow Coma Scale -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Glasgow Coma Scale (GCS)</h3>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Eye Opening Response (1-4)</label>
                        <select id="gcsEye" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="4">4 - Spontaneous</option>
                            <option value="3">3 - To speech</option>
                            <option value="2">2 - To pain</option>
                            <option value="1">1 - None</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Verbal Response (1-5)</label>
                        <select id="gcsVerbal" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="5">5 - Oriented</option>
                            <option value="4">4 - Confused</option>
                            <option value="3">3 - Inappropriate words</option>
                            <option value="2">2 - Incomprehensible sounds</option>
                            <option value="1">1 - None</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Motor Response (1-6)</label>
                        <select id="gcsMotor" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="6">6 - Obeys commands</option>
                            <option value="5">5 - Localizes pain</option>
                            <option value="4">4 - Withdraws from pain</option>
                            <option value="3">3 - Flexion to pain (decorticate)</option>
                            <option value="2">2 - Extension to pain (decerebrate)</option>
                            <option value="1">1 - None</option>
                        </select>
                    </div>
                    <button onclick="calculateGCS()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate GCS</button>
                    <div id="gcsResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- NIH Stroke Scale (Simplified) -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">NIH Stroke Scale (NIHSS) - Simplified</h3>
                    <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 1rem;">Enter total score from full NIHSS assessment (0-42)</p>
                    <input type="number" id="nihssTotal" placeholder="Total NIHSS Score (0-42)" min="0" max="42" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    <button onclick="calculateNIHSS()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Interpret NIHSS</button>
                    <div id="nihssResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- ABCD2 Score -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">ABCD2 Score (TIA Stroke Risk)</h3>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Age  60 years</label>
                        <select id="abcd2Age" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="0">No (0 points)</option>
                            <option value="1">Yes (1 point)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Blood Pressure  140/90</label>
                        <select id="abcd2BP" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="0">No (0 points)</option>
                            <option value="1">Yes (1 point)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Clinical Features</label>
                        <select id="abcd2Clinical" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="0">Other (0 points)</option>
                            <option value="1">Speech impairment only (1 point)</option>
                            <option value="2">Unilateral weakness (2 points)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Duration of Symptoms</label>
                        <select id="abcd2Duration" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="0">< 10 minutes (0 points)</option>
                            <option value="1">10-59 minutes (1 point)</option>
                            <option value="2"> 60 minutes (2 points)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Diabetes</label>
                        <select id="abcd2Diabetes" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="0">No (0 points)</option>
                            <option value="1">Yes (1 point)</option>
                        </select>
                    </div>
                    <button onclick="calculateABCD2()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate ABCD2 Score</button>
                    <div id="abcd2Result" style="margin-top: 1rem;"></div>
                </div>

                <!-- Seizure Classification -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Seizure Classification Tool</h3>
                    <select id="seizureType" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px; margin-bottom: 0.75rem;">
                        <option value="">Select Seizure Type</option>
                        <option value="focal-aware">Focal Aware (Simple Partial)</option>
                        <option value="focal-impaired">Focal Impaired Awareness (Complex Partial)</option>
                        <option value="generalized-tonic-clonic">Generalized Tonic-Clonic (Grand Mal)</option>
                        <option value="absence">Absence (Petit Mal)</option>
                        <option value="myoclonic">Myoclonic</option>
                        <option value="atonic">Atonic (Drop Attacks)</option>
                    </select>
                    <button onclick="classifySeizure()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Classify Seizure</button>
                    <div id="seizureResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Oncology Panel -->
    <div class="modal" id="oncologyModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Oncology Tools
                </div>
                <button class="modal-close" onclick="closePanel('oncologyModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- TNM Staging -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">TNM Staging Calculator</h3>
                    <select id="tnmCancerType" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px; margin-bottom: 0.75rem;">
                        <option value="">Select Cancer Type</option>
                        <option value="breast">Breast Cancer</option>
                        <option value="lung">Lung Cancer</option>
                        <option value="colon">Colon Cancer</option>
                        <option value="prostate">Prostate Cancer</option>
                    </select>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                        <select id="tnmT" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="">T Stage</option>
                            <option value="0">T0/Tis</option>
                            <option value="1">T1</option>
                            <option value="2">T2</option>
                            <option value="3">T3</option>
                            <option value="4">T4</option>
                        </select>
                        <select id="tnmN" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="">N Stage</option>
                            <option value="0">N0</option>
                            <option value="1">N1</option>
                            <option value="2">N2</option>
                            <option value="3">N3</option>
                        </select>
                        <select id="tnmM" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="">M Stage</option>
                            <option value="0">M0</option>
                            <option value="1">M1</option>
                        </select>
                    </div>
                    <button onclick="calculateTNM()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Stage</button>
                    <div id="tnmResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- ECOG Performance Status -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">ECOG Performance Status</h3>
                    <select id="ecogScore" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <option value="">Select ECOG Score</option>
                        <option value="0">0 - Fully active, no restrictions</option>
                        <option value="1">1 - Restricted in strenuous activity</option>
                        <option value="2">2 - Ambulatory, unable to work</option>
                        <option value="3">3 - Limited self-care, >50% in bed/chair</option>
                        <option value="4">4 - Completely disabled</option>
                    </select>
                    <button onclick="interpretECOG()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Interpret ECOG</button>
                    <div id="ecogResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- Karnofsky Performance Status -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Karnofsky Performance Status</h3>
                    <select id="karnofskyScore" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <option value="">Select Karnofsky Score</option>
                        <option value="100">100 - Normal, no complaints</option>
                        <option value="90">90 - Minor symptoms</option>
                        <option value="80">80 - Normal activity with effort</option>
                        <option value="70">70 - Cares for self, unable to work</option>
                        <option value="60">60 - Requires occasional assistance</option>
                        <option value="50">50 - Requires considerable assistance</option>
                        <option value="40">40 - Disabled, requires special care</option>
                        <option value="30">30 - Severely disabled</option>
                        <option value="20">20 - Very sick, hospitalization needed</option>
                        <option value="10">10 - Moribund</option>
                    </select>
                    <button onclick="interpretKarnofsky()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Interpret Karnofsky</button>
                    <div id="karnofskyResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- Chemotherapy Dosing (BSA-based) -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Chemotherapy Dose Calculator (BSA-based)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <input type="number" id="chemoWeight" placeholder="Weight (kg)" step="0.1" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="chemoHeight" placeholder="Height (cm)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <input type="number" id="chemoDosePerBSA" placeholder="Dose per m (e.g., 75 for Docetaxel)" step="0.1" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px; margin-bottom: 0.75rem;">
                    <button onclick="calculateChemoDose()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Dose</button>
                    <div id="chemoDoseResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pediatrics Panel -->
    <div class="modal" id="pediatricsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v4a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                        <path d="M12 9v13"/>
                        <path d="M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2"/>
                    </svg>
                    Pediatrics Tools
                </div>
                <button class="modal-close" onclick="closePanel('pediatricsModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Growth Chart -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">WHO/CDC Growth Chart Calculator</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="pedAgeMonths" placeholder="Age (months)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <select id="pedGender" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="">Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <input type="number" id="pedWeight" placeholder="Weight (kg)" step="0.1" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="pedHeight" placeholder="Height (cm)" step="0.1" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <input type="number" id="pedHeadCirc" placeholder="Head Circumference (cm) - Optional" step="0.1" style="width: 100%; margin-top: 0.75rem; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    <button onclick="calculateGrowthChart()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Percentiles</button>
                    <div id="growthChartResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- APGAR Score -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">APGAR Score Calculator</h3>
                    <div style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Time Point</label>
                        <select id="apgarTime" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                            <option value="1-minute">1 Minute</option>
                            <option value="5-minute">5 Minutes</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div>
                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Appearance (Skin Color)</label>
                            <select id="apgarAppearance" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                                <option value="0">0 - Blue/pale</option>
                                <option value="1">1 - Body pink, extremities blue</option>
                                <option value="2">2 - Completely pink</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Pulse (Heart Rate)</label>
                            <select id="apgarPulse" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                                <option value="0">0 - Absent</option>
                                <option value="1">1 - < 100 bpm</option>
                                <option value="2">2 -  100 bpm</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Grimace (Reflex)</label>
                            <select id="apgarGrimace" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                                <option value="0">0 - No response</option>
                                <option value="1">1 - Grimace</option>
                                <option value="2">2 - Cry/active withdrawal</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Activity (Muscle Tone)</label>
                            <select id="apgarActivity" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                                <option value="0">0 - Limp</option>
                                <option value="1">1 - Some flexion</option>
                                <option value="2">2 - Active motion</option>
                            </select>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Respiration (Breathing)</label>
                            <select id="apgarRespiration" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                                <option value="0">0 - Absent</option>
                                <option value="1">1 - Weak/irregular</option>
                                <option value="2">2 - Strong cry</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="calculateAPGAR()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate APGAR</button>
                    <div id="apgarResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- Pediatric Dosage Calculator -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Pediatric Dosage Calculator</h3>
                    <input type="text" id="pedMedication" placeholder="Medication Name" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px; margin-bottom: 0.75rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <input type="number" id="pedDoseWeight" placeholder="Child Weight (kg)" step="0.1" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="pedDoseAge" placeholder="Age (years)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="pedDosePerKg" placeholder="Dose per kg (mg/kg)" step="0.01" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="pedMaxDose" placeholder="Max Dose (mg)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                        <input type="text" id="pedFrequency" placeholder="Frequency (e.g., TID)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="text" id="pedRoute" placeholder="Route (e.g., PO, IV)" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <button onclick="calculatePediatricDose()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate Dose</button>
                    <div id="pediatricDoseResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Psychiatry Panel -->
    <div class="modal" id="psychiatryModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Psychiatry Tools
                </div>
                <button class="modal-close" onclick="closePanel('psychiatryModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- PHQ-9 Depression Screening -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">PHQ-9 Depression Screening</h3>
                    <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 1rem;">Over the last 2 weeks, how often have you been bothered by any of the following problems? (0=Not at all, 1=Several days, 2=More than half the days, 3=Nearly every day)</p>
                    <div style="display: grid; gap: 0.75rem;">
                        <input type="number" id="phq9Q1" placeholder="1. Little interest or pleasure (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q2" placeholder="2. Feeling down, depressed (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q3" placeholder="3. Sleep problems (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q4" placeholder="4. Feeling tired (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q5" placeholder="5. Appetite problems (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q6" placeholder="6. Feeling bad about yourself (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q7" placeholder="7. Trouble concentrating (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q8" placeholder="8. Moving/speaking slowly or restless (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="phq9Q9" placeholder="9. Thoughts of hurting yourself (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <button onclick="calculatePHQ9()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate PHQ-9</button>
                    <div id="phq9Result" style="margin-top: 1rem;"></div>
                </div>

                <!-- GAD-7 Anxiety Screening -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">GAD-7 Anxiety Screening</h3>
                    <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 1rem;">Over the last 2 weeks, how often have you been bothered by the following? (0=Not at all, 1=Several days, 2=More than half the days, 3=Nearly every day)</p>
                    <div style="display: grid; gap: 0.75rem;">
                        <input type="number" id="gad7Q1" placeholder="1. Feeling nervous, anxious (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gad7Q2" placeholder="2. Not being able to stop worrying (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gad7Q3" placeholder="3. Worrying too much (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gad7Q4" placeholder="4. Trouble relaxing (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gad7Q5" placeholder="5. Being so restless (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gad7Q6" placeholder="6. Becoming easily annoyed (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="gad7Q7" placeholder="7. Feeling afraid (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <button onclick="calculateGAD7()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate GAD-7</button>
                    <div id="gad7Result" style="margin-top: 1rem;"></div>
                </div>

                <!-- MMSE Cognitive Assessment -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">MMSE (Mini-Mental State Examination)</h3>
                    <div style="display: grid; gap: 0.75rem;">
                        <input type="number" id="mmseOrientation" placeholder="Orientation (0-10)" min="0" max="10" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="mmseRegistration" placeholder="Registration (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="mmseAttention" placeholder="Attention & Calculation (0-5)" min="0" max="5" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="mmseRecall" placeholder="Recall (0-3)" min="0" max="3" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="mmseLanguage" placeholder="Language (0-8)" min="0" max="8" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <input type="number" id="mmseConstruction" placeholder="Construction (0-1)" min="0" max="1" style="padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                    </div>
                    <button onclick="calculateMMSE()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Calculate MMSE</button>
                    <div id="mmseResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orthopedics Panel -->
    <div class="modal" id="orthopedicsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
                    </svg>
                    Orthopedics Tools
                </div>
                <button class="modal-close" onclick="closePanel('orthopedicsModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Salter-Harris Classification -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Salter-Harris Fracture Classification</h3>
                    <select id="salterHarrisType" style="width: 100%; padding: 0.75rem; border: var(--border-light); border-radius: 8px;">
                        <option value="">Select Salter-Harris Type</option>
                        <option value="I">Type I - Slip (Physis only)</option>
                        <option value="II">Type II - Above (Physis + Metaphysis)</option>
                        <option value="III">Type III - Lower (Physis + Epiphysis)</option>
                        <option value="IV">Type IV - Through (All three)</option>
                        <option value="V">Type V - Rammed (Crush injury)</option>
                    </select>
                    <button onclick="classifySalterHarris()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Classify Fracture</button>
                    <div id="salterHarrisResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- Ottawa Ankle Rules -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Ottawa Ankle Rules</h3>
                    <div style="display: grid; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaAnkleLateral"> Bone tenderness at lateral malleolus (6cm proximal)
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaAnkleMedial"> Bone tenderness at medial malleolus (6cm proximal)
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaAnkleNavicular"> Bone tenderness at navicular
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaAnkle5thMet"> Bone tenderness at base of 5th metatarsal
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaAnkleWalkImmediate"> Unable to walk 4 steps immediately after injury
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaAnkleWalkED"> Unable to walk 4 steps in ED
                        </label>
                    </div>
                    <button onclick="applyOttawaAnkleRules()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Apply Ottawa Ankle Rules</button>
                    <div id="ottawaAnkleResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- Ottawa Knee Rules -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h3 style="margin-bottom: 1rem; font-weight: 700;">Ottawa Knee Rules</h3>
                    <div style="display: grid; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaKneeAge"> Age  55 years
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaKneePatellar"> Isolated tenderness of patella
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaKneeFibula"> Tenderness at head of fibula
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaKneeFlex"> Unable to flex knee to 90 degrees
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="ottawaKneeWalk"> Unable to walk 4 steps (bearing weight)
                        </label>
                    </div>
                    <button onclick="applyOttawaKneeRules()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gradient-medical); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Apply Ottawa Knee Rules</button>
                    <div id="ottawaKneeResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
/* ============================================================
   LYDIAN MEDICAL AI - MAIN APPLICATION LOGIC
   ============================================================ */

// State Management
const state = {
    messages: [],
    currentSpecialty: 'general-medicine',
    currentLanguage: 'en', // Default language set to English
    conversations: [],
    currentConversationId: null,
    isRecording: false,
    mediaRecorder: null,
    audioChunks: []
};

// DOM Elements
const sidebar = document.getElementById('sidebar');
const messagesContainer = document.getElementById('messagesContainer');
const emptyState = document.getElementById('emptyState');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const chatTitle = document.getElementById('chatTitle');
const languageSelector = document.getElementById('languageSelector');

// Update AI Status Badge
function updateAIStatus(status, modelName = '') {
    const badge = document.getElementById('aiStatusBadge');
    if (!badge) return;

    const statusConfig = {
        ready: {
            bg: 'linear-gradient(135deg, #10B981, #34D399)',
            text: 'AI Ready',
            icon: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>'
        },
        thinking: {
            bg: 'linear-gradient(135deg, #0066CC, #00A3E0)',
            text: modelName || 'AI Thinking...',
            icon: '<circle cx="12" cy="12" r="10" opacity="0.5"/><path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>'
        },
        error: {
            bg: 'linear-gradient(135deg, #EF4444, #DC2626)',
            text: 'AI Error',
            icon: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'
        }
    };

    const config = statusConfig[status] || statusConfig.ready;
    badge.style.background = config.bg;
    badge.innerHTML = `
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            ${config.icon}
        </svg>
        <span>${config.text}</span>
    `;
}

// Detect Symptoms in Message
function detectSymptoms(text) {
    const symptomKeywords = ['pain', 'ache', 'fever', 'cough', 'headache', 'nausea', 'dizzy', 'tired', 'fatigue',
                             'ar', 'ac', 'ate', 'ksrk', 'ba ars', 'mide bulants', 'yorgunluk',
                             'symptom', 'semptom', 'feeling', 'hissediyorum'];
    return symptomKeywords.some(keyword => text.toLowerCase().includes(keyword));
}

// Perform RAG-based Diagnosis
async function performRAGDiagnosis(symptoms) {
    try {
        showTypingIndicator();

        const response = await fetch('/api/medical/rag-diagnosis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                symptoms: symptoms,
                language: state.currentLanguage,
                specialty: state.currentSpecialty
            })
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success && data.diagnosis) {
            const ragMessage = `\n\n **RAG-Enhanced Diagnosis** (PubMed + SNOMED + ICD-11):\n\n${data.diagnosis}`;
            addMessage(ragMessage, false);
        }
    } catch (error) {
        console.error('RAG diagnosis error:', error);
        hideTypingIndicator();
    }
}

// Load Emergency Numbers from API
async function loadEmergencyNumbers() {
    try {
        const response = await fetch(`/api/medical/emergency-numbers?language=${state.currentLanguage}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success && data.numbers) {
            displayEmergencyNumbers(data.numbers);
        }
    } catch (error) {
        console.error('Emergency numbers error:', error);
        // Fallback to default Turkey numbers
        displayDefaultEmergencyNumbers();
    }
}

// Display Emergency Numbers in Modal
function displayEmergencyNumbers(numbers) {
    const emergencyGrid = document.querySelector('.emergency-grid');
    emergencyGrid.innerHTML = '';

    numbers.forEach(item => {
        const card = document.createElement('div');
        card.className = 'emergency-card';
        card.innerHTML = `
            <div class="emergency-number">${item.number}</div>
            <div class="emergency-label">${item.label}</div>
        `;
        emergencyGrid.appendChild(card);
    });
}

// Fallback Emergency Numbers
function displayDefaultEmergencyNumbers() {
    const defaultNumbers = [
        { number: '112', label: 'Emergency Medical Services' },
        { number: '184', label: 'Poison Control' },
        { number: '182', label: 'Psychiatric Hotline' },
        { number: '155', label: 'Police Emergency' },
        { number: '110', label: 'Fire Department' },
        { number: '183', label: 'ALO 183 Healthcare' }
    ];
    displayEmergencyNumbers(defaultNumbers);
}

// Panel Management
function showPanel(panelType) {
    // Close all modals first
    document.querySelectorAll('.modal.active').forEach(modal => {
        modal.classList.remove('active');
    });

    const panelMap = {
        'rag-search': 'ragSearchModal',
        'dicom-upload': 'dicomUploadModal',
        'fhir-patient': 'fhirPatientModal',
        'speech-transcription': 'speechTranscriptionModal',
        'translate': 'translateModal',
        'general-medicine': 'generalMedicineModal',
        'cardiology': 'cardiologyModal',
        'neurology': 'neurologyModal',
        'oncology': 'oncologyModal',
        'pediatrics': 'pediatricsModal',
        'psychiatry': 'psychiatryModal',
        'orthopedics': 'orthopedicsModal',
        // Advanced Medical AI
        'rare-disease': 'rareDiseaseModal',
        'mental-health': 'mentalHealthModal',
        'emergency-triage': 'emergencyTriageModal',
        'sepsis-warning': 'sepsisWarningModal',
        'multimodal-fusion': 'multimodalFusionModal',
        'maternal-fetal': 'maternalFetalModal',
        // Neuro Health AI Panels
        'neuro-imaging': 'neuroImagingModal',
        'neuro-health-index': 'neuroHealthIndexModal',
        'neuro-risk': 'neuroRiskModal',
        'neuro-twin': 'neuroTwinModal',
        'neuro-clinician': 'neuroClinicianModal'
    };

    const modalId = panelMap[panelType];
    if (modalId) {
        document.getElementById(modalId).classList.add('active');
    }
}

function closePanel(modalId, event) {
    if (event) {
        event.stopPropagation();
    }
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

// Toggle dropdown categories in sidebar
function toggleCategory(categoryId) {
    const categories = document.querySelectorAll('.nav-category');
    const targetCategory = event.currentTarget.closest('.nav-category');

    // Toggle the clicked category
    targetCategory.classList.toggle('open');

    // Optional: Close other categories (uncomment if you want accordion behavior)
    // categories.forEach(cat => {
    //     if (cat !== targetCategory) {
    //         cat.classList.remove('open');
    //     }
    // });
}

// RAG Search Functions
async function performRAGSearch() {
    const query = document.getElementById('ragSearchInput').value.trim();
    if (!query) return alert('Please enter a search query');

    const resultsDiv = document.getElementById('ragResults');
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 2rem;">Searching PubMed, WHO Guidelines...</div>';

    try {
        const response = await fetch('/api/rag/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query,
                max_results: 10,
                sources: ['pubmed', 'who'],
                language: state.currentLanguage
            })
        });

        const data = await response.json();

        if (data.success && data.results) {
            resultsDiv.innerHTML = data.results.map(result => `
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 0.75rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem;">${result.title}</div>
                    <div style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">${result.authors || ''}</div>
                    <div style="font-size: 0.8125rem; color: var(--medical-primary);">${result.source} - ${result.journal || ''}</div>
                    <a href="${result.url}" target="_blank" style="font-size: 0.875rem; color: var(--medical-primary); text-decoration: none;">View Article </a>
                </div>
            `).join('');
        } else {
            throw new Error(data.error || 'Search failed');
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div style="color: var(--medical-error); padding: 1rem;">Error: ${error.message}</div>`;
    }
}

// DICOM Upload Functions
async function uploadDICOM(event) {
    const file = event.target.files[0];
    if (!file) return;

    const resultsDiv = document.getElementById('dicomResults');
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 2rem;">Uploading DICOM...</div>';

    const formData = new FormData();
    formData.append('dicom', file);
    formData.append('hospital_id', 'hospital-001');
    formData.append('user_id', 'user-' + Date.now());
    formData.append('patient_id', 'patient-001');

    try {
        const response = await fetch('/api/dicom/upload', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            resultsDiv.innerHTML = `
                <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 10px;">
                    <div style="font-weight: 700; color: var(--medical-success); margin-bottom: 1rem;"> DICOM Uploaded Successfully</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        <div>Study UID: ${data.instance?.study_instance_uid || 'N/A'}</div>
                        <div>Series UID: ${data.instance?.series_instance_uid || 'N/A'}</div>
                        <div>File Size: ${(data.metadata?.file_size_bytes / 1024).toFixed(2)} KB</div>
                    </div>
                </div>
            `;
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div style="color: var(--medical-error); padding: 1rem;">Error: ${error.message}</div>`;
    }
}

// FHIR Patient Functions
async function createFHIRPatient() {
    const given = document.getElementById('patientGivenName').value.trim();
    const family = document.getElementById('patientFamilyName').value.trim();
    const gender = document.getElementById('patientGender').value;
    const birthDate = document.getElementById('patientBirthDate').value;

    if (!given || !family || !gender || !birthDate) {
        return alert('Please fill all fields');
    }

    const resultsDiv = document.getElementById('fhirResults');
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 1rem;">Creating patient record...</div>';

    try {
        const response = await fetch('/api/fhir/patient', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                given,
                family,
                gender,
                birthDate,
                hospital_id: 'hospital-001',
                user_id: 'user-' + Date.now()
            })
        });

        const data = await response.json();

        if (data.success) {
            resultsDiv.innerHTML = `
                <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 10px;">
                    <div style="font-weight: 700; color: var(--medical-success); margin-bottom: 1rem;"> Patient Record Created</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        <div>Patient ID: ${data.patient_id || 'N/A'}</div>
                        <div>Name: ${given} ${family}</div>
                        <div>Gender: ${gender}</div>
                        <div>Birth Date: ${birthDate}</div>
                    </div>
                </div>
            `;
        } else {
            throw new Error(data.error || 'Creation failed');
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div style="color: var(--medical-error); padding: 1rem;">Error: ${error.message}</div>`;
    }
}

// Speech Transcription Functions
let isRecording = false;
let mediaRecorder;
let audioChunks = [];

async function toggleRecording() {
    const recordBtn = document.getElementById('recordBtn');

    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                await transcribeAudioBlob(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            isRecording = true;
            recordBtn.innerHTML = ' Stop Recording';
            recordBtn.style.background = 'var(--medical-error)';
        } catch (error) {
            alert('Microphone access denied');
        }
    } else {
        mediaRecorder.stop();
        isRecording = false;
        recordBtn.innerHTML = ' Start Recording';
        recordBtn.style.background = 'var(--gradient-medical)';
    }
}

async function uploadAudio(event) {
    const file = event.target.files[0];
    if (!file) return;

    const blob = new Blob([file], { type: file.type });
    await transcribeAudioBlob(blob);
}

async function transcribeAudioBlob(audioBlob) {
    const resultsDiv = document.getElementById('transcriptionResults');
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 2rem;">Transcribing audio...</div>';

    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.wav');
    formData.append('language', state.currentLanguage);

    try {
        const response = await fetch('/api/medical/transcribe', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success && data.transcript) {
            resultsDiv.innerHTML = `
                <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 10px;">
                    <div style="font-weight: 700; margin-bottom: 1rem;">Transcription:</div>
                    <div style="padding: 1rem; background: white; border-radius: 8px; line-height: 1.6;">${data.transcript}</div>
                    <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-tertiary);">
                        Confidence: ${((data.metadata?.confidence || 0) * 100).toFixed(1)}%
                    </div>
                </div>
            `;
        } else {
            throw new Error(data.error || 'Transcription failed');
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div style="color: var(--medical-error); padding: 1rem;">Error: ${error.message}</div>`;
    }
}

// Translation Functions
async function performTranslation() {
    const text = document.getElementById('translateInput').value.trim();
    const targetLang = document.getElementById('targetLanguage').value;

    if (!text) return alert('Please enter text to translate');

    const resultsDiv = document.getElementById('translationResults');
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 2rem;">Translating...</div>';

    try {
        const response = await fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text,
                target_language: targetLang,
                source_language: 'auto'
            })
        });

        const data = await response.json();

        if (data.success && data.translated_text) {
            resultsDiv.innerHTML = `
                <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 10px;">
                    <div style="font-weight: 700; margin-bottom: 1rem;">Translation:</div>
                    <div style="padding: 1rem; background: white; border-radius: 8px; line-height: 1.6;">${data.translated_text}</div>
                </div>
            `;
        } else {
            throw new Error(data.error || 'Translation failed');
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div style="color: var(--medical-error); padding: 1rem;">Error: ${error.message}</div>`;
    }
}

// Initialize Application
function init() {
    // loadConversations(); // REMOVED: No localStorage persistence for AI responses
    loadCurrentLanguage();
    setupEventListeners();
    initializeSpecialtySelection();
    loadEmergencyNumbers();

    // Welcome message
    setTimeout(() => {
        if (state.messages.length === 0) {
            addWelcomeMessage();
        }
    }, 500);
}

// Setup Event Listeners
function setupEventListeners() {
    messageInput.addEventListener('input', autoResizeTextarea);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// Auto-resize Textarea
function autoResizeTextarea() {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
}

// Toggle Sidebar
function toggleSidebar() {
    sidebar.classList.toggle('collapsed');
}

// New Consultation
function newConsultation() {
    state.messages = [];
    state.currentConversationId = Date.now().toString();
    emptyState.style.display = 'flex';
    addWelcomeMessage();
}

// Specialty Selection
function initializeSpecialtySelection() {
    const specialtyItems = document.querySelectorAll('.specialization-item');
    specialtyItems.forEach(item => {
        item.addEventListener('click', () => {
            specialtyItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            state.currentSpecialty = item.dataset.specialty;
            updateChatTitle();
        });
    });
}

function updateChatTitle() {
    const specialtyNames = {
        'general-medicine': 'General Medicine',
        'cardiology': 'Cardiology',
        'neurology': 'Neurology',
        'radiology': 'Radiology',
        'oncology': 'Oncology',
        'pediatrics': 'Pediatrics',
        'psychiatry': 'Psychiatry',
        'orthopedics': 'Orthopedics'
    };
    chatTitle.querySelector('span').textContent = specialtyNames[state.currentSpecialty] || 'Medical AI Expert';
}

// Language Management
function changeLanguage() {
    state.currentLanguage = languageSelector.value;
    localStorage.setItem('medical_ai_language', state.currentLanguage);
    addSystemMessage(`Language changed to ${languageSelector.options[languageSelector.selectedIndex].text}`);
}

function loadCurrentLanguage() {
    const savedLang = localStorage.getItem('medical_ai_language');
    if (savedLang) {
        state.currentLanguage = savedLang;
        languageSelector.value = savedLang;
    }
}

// Welcome Message - DISABLED (No permanent mock data)
function addWelcomeMessage() {
    // REMOVED: All welcome messages to prevent permanent mock data
    // AI will respond dynamically based on user queries only
    return; // No static welcome message
}

// Send Message
async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    // Add user message
    addMessage(text, true);
    messageInput.value = '';
    autoResizeTextarea();

    // Disable send button
    sendBtn.disabled = true;

    // Show typing indicator
    showTypingIndicator();
    updateAIStatus('thinking', 'Medical AI');

    try {
        // Enhanced medical system prompt
        const medicalContext = `You are a specialized AI medical assistant powered by LyDian AI Advanced Medical Intelligence.
Current specialty context: ${state.currentSpecialty}
Language: ${state.currentLanguage}

Your capabilities include:
- Symptom analysis with differential diagnosis
- Medical image interpretation (X-ray, CT, MRI)
- Drug interaction checking via FDA/EMA databases
- Lab results interpretation
- Medical literature search (PubMed integration)
- HIPAA-compliant healthcare guidance

Always remind users that this is for informational purposes only and not a substitute for professional medical advice.
For emergencies, advise calling 112 (emergency services).`;

        // Call REAL Azure-powered medical chat API
        const response = await fetch('/api/medical/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: text,
                language: state.currentLanguage,
                specialization: state.currentSpecialty, // CORRECTED: API expects "specialization" not "specialty"
                user_id: 'medical-user-' + Date.now(),
                hospital_id: 'hospital-001'
            })
        });

        const data = await response.json();

        hideTypingIndicator();
        updateAIStatus('ready');

        if (data.success && data.response) {
            // Display model info if available
            if (data.model) {
                updateAIStatus('ready', data.model);
                setTimeout(() => updateAIStatus('ready'), 3000);
            }

            addMessage(data.response, false);

            // If symptoms detected, also call RAG diagnosis API
            if (detectSymptoms(text)) {
                await performRAGDiagnosis(text);
            }

            // saveToLocalStorage(); // REMOVED: No localStorage persistence for AI responses
        } else {
            throw new Error(data.error || 'API response error');
        }
    } catch (error) {
        hideTypingIndicator();
        updateAIStatus('error');
        setTimeout(() => updateAIStatus('ready'), 3000);
        console.error('Chat error:', error);
        addMessage('An error occurred. Please check your connection and try again.', false);
    } finally {
        sendBtn.disabled = false;
    }
}

// Add Message to Chat
function addMessage(content, isUser = false) {
    emptyState.style.display = 'none';

    const message = {
        id: Date.now().toString(),
        role: isUser ? 'user' : 'ai',
        content: content,
        timestamp: new Date().toISOString()
    };

    state.messages.push(message);
    renderMessage(message);
    scrollToBottom();
}

// Add System Message
function addSystemMessage(content) {
    const systemMsg = document.createElement('div');
    systemMsg.style.cssText = 'text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.875rem;';
    systemMsg.textContent = content;
    messagesContainer.appendChild(systemMsg);
    scrollToBottom();
}

// Render Single Message
function renderMessage(msg) {
    const isUser = msg.role === 'user';
    const time = new Date(msg.timestamp).toLocaleTimeString(state.currentLanguage, {
        hour: '2-digit',
        minute: '2-digit'
    });

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${msg.role}`;
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${isUser ? `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            ` : `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
                    <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/>
                    <circle cx="20" cy="10" r="2"/>
                </svg>
            `}
        </div>
        <div class="message-content">
            <div class="message-bubble">${escapeHtml(msg.content)}</div>
            <div class="message-time">${time}</div>
        </div>
    `;

    messagesContainer.appendChild(messageDiv);
}

// Typing Indicator
function showTypingIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'message ai';
    indicator.innerHTML = `
        <div class="message-avatar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/>
            </svg>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    `;
    messagesContainer.appendChild(indicator);
    scrollToBottom();
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

// Quick Actions
function handleQuickAction(action) {
    const prompts = {
        'symptom-analysis': 'I would like to describe my symptoms for analysis and preliminary assessment.',
        'drug-interaction': 'I need to check for potential drug interactions between medications.',
        'image-analysis': 'I want to upload medical images (X-ray, CT, or MRI) for AI analysis.',
        'medical-literature': 'I need to search medical literature and research papers on a specific condition.'
    };

    messageInput.value = prompts[action];
    messageInput.focus();
}

// Check if image is radiology-related
function isRadiologyImage(filename) {
    const radiologyKeywords = ['xray', 'x-ray', 'ct', 'mri', 'scan', 'dicom', 'radiolog'];
    return radiologyKeywords.some(keyword => filename.toLowerCase().includes(keyword));
}

// Perform Advanced Radiology Analysis
async function performRadiologyAnalysis(formData) {
    try {
        showTypingIndicator();
        updateAIStatus('thinking', 'Radiology AI');

        const response = await fetch('/api/medical/radiology-analysis', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();
        updateAIStatus('ready');

        if (data.success && data.analysis) {
            const radiologyMessage = `\n\n **Advanced Radiology Analysis**:\n\n${data.analysis}`;
            addMessage(radiologyMessage, false);
        }
    } catch (error) {
        console.error('Radiology analysis error:', error);
        hideTypingIndicator();
        updateAIStatus('ready');
    }
}

// File Upload Handler
async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const uploadZone = document.getElementById('uploadZone');
    uploadZone.style.borderColor = 'var(--medical-success)';
    uploadZone.style.background = 'rgba(16, 185, 129, 0.1)';

    addSystemMessage(`Uploading ${file.name}...`);
    showTypingIndicator();

    try {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('specialty', state.currentSpecialty);
        formData.append('language', state.currentLanguage);

        // Azure Computer Vision API for medical image analysis
        const response = await fetch('/api/medical/image-analysis', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success) {
            addMessage(`Medical Image Analysis: ${file.name}\n\n${data.analysis}`, false);

            // If radiology specialty or radiology-related image, also call advanced radiology analysis
            if (state.currentSpecialty === 'radiology' || isRadiologyImage(file.name)) {
                await performRadiologyAnalysis(formData);
            }
        } else {
            throw new Error(data.error || 'Image analysis failed');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('Image upload error:', error);
        addMessage('Image analysis failed. Please try again.', false);
    } finally {
        uploadZone.style.borderColor = '';
        uploadZone.style.background = '';
        event.target.value = '';
    }
}

// Voice Input Handler
async function handleVoiceInput() {
    const voiceBtn = document.getElementById('voiceBtn');

    if (!state.isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            state.mediaRecorder = new MediaRecorder(stream);
            state.audioChunks = [];

            state.mediaRecorder.ondataavailable = (event) => {
                state.audioChunks.push(event.data);
            };

            state.mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
                await transcribeAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };

            state.mediaRecorder.start();
            state.isRecording = true;

            voiceBtn.style.background = 'var(--medical-error)';
            voiceBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                </svg>
            `;
        } catch (error) {
            console.error('Microphone access error:', error);
            alert('Microphone access denied. Please allow microphone access in your browser settings.');
        }
    } else {
        if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
            state.mediaRecorder.stop();
            state.isRecording = false;

            voiceBtn.style.background = '';
            voiceBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
            `;
        }
    }
}

async function transcribeAudio(audioBlob) {
    try {
        showTypingIndicator();

        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        formData.append('language', state.currentLanguage);

        const response = await fetch('/api/speech/transcribe', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.success && data.text) {
            messageInput.value = data.text;
            messageInput.focus();
        } else {
            throw new Error(data.error || 'Transcription failed');
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('Transcription error:', error);
        alert('Speech transcription failed. Please try again.');
    }
}

// Emergency Modal
function showEmergencyModal() {
    loadEmergencyNumbers();
    document.getElementById('emergencyModal').classList.add('active');
}

function closeEmergencyModal(event) {
    if (event) {
        event.stopPropagation();
    }
    const modal = document.getElementById('emergencyModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// Export Consultation
function exportConsultation() {
    if (state.messages.length === 0) {
        alert('No consultation to export.');
        return;
    }

    const exportData = {
        date: new Date().toISOString(),
        specialty: state.currentSpecialty,
        language: state.currentLanguage,
        messages: state.messages
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `medical-consultation-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Local Storage Management
// REMOVED: No localStorage persistence for AI responses
/*
function saveToLocalStorage() {
    try {
        const data = {
            messages: state.messages,
            specialty: state.currentSpecialty,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('medical_ai_session', JSON.stringify(data));
    } catch (error) {
        console.error('Save error:', error);
    }
}

function loadConversations() {
    try {
        const saved = localStorage.getItem('medical_ai_session');
        if (saved) {
            const data = JSON.parse(saved);
            state.messages = data.messages || [];
            state.currentSpecialty = data.specialty || 'general';

            if (state.messages.length > 0) {
                emptyState.style.display = 'none';
                state.messages.forEach(msg => renderMessage(msg));
            }
        }
    } catch (error) {
        console.error('Load error:', error);
    }
}
*/

// Utilities
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

function scrollToBottom() {
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
}


// ============================================================
// MEDICAL SPECIALTY API INTEGRATION FUNCTIONS
// ============================================================
// ============================================================
// MEDICAL SPECIALTY API INTEGRATION FUNCTIONS
// ============================================================

// Helper function to display results
function displayResult(elementId, data, isError = false) {
    const resultDiv = document.getElementById(elementId);
    if (isError) {
        resultDiv.innerHTML = `<div style="padding: 1rem; background: #FEF2F2; border: 1px solid #FCA5A5; border-radius: 8px; color: #DC2626;">${data}</div>`;
    } else {
        resultDiv.innerHTML = `<div style="padding: 1rem; background: var(--bg-primary); border: var(--border-light); border-radius: 8px;">${data}</div>`;
    }
}

// ============================================================
// GENERAL MEDICINE FUNCTIONS
// ============================================================

async function assessVitalSigns() {
    const systolic = parseInt(document.getElementById('gmSystolic').value);
    const diastolic = parseInt(document.getElementById('gmDiastolic').value);
    const heartRate = parseInt(document.getElementById('gmHeartRate').value);
    const temperature = parseFloat(document.getElementById('gmTemp').value);
    const spO2 = parseInt(document.getElementById('gmSpO2').value);
    const respiratoryRate = parseInt(document.getElementById('gmRespRate').value);

    if (!systolic || !diastolic || !heartRate || !temperature || !spO2 || !respiratoryRate) {
        displayResult('vitalSignsResult', 'Please fill in all vital signs', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/general/vital-signs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                systolic, diastolic, heartRate, temperature, spO2, respiratoryRate,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const assessment = data.assessment;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Vital Signs Assessment</h4>
                <div style="background: ${assessment.overallStatus === 'critical' ? '#FEF2F2' : assessment.overallStatus === 'abnormal' ? '#FEF3C7' : '#ECFDF5'}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Overall Status:</strong> ${assessment.overallStatus.toUpperCase()}
                    ${assessment.alerts.length > 0 ? '<br><strong style="color: #DC2626;">' + assessment.alerts.join('<br>') + '</strong>' : ''}
                </div>
                <div style="display: grid; gap: 0.75rem;">
                    <div><strong>Blood Pressure:</strong> ${assessment.bloodPressure.systolic}/${assessment.bloodPressure.diastolic} mmHg - ${assessment.bloodPressure.category}<br><small>${assessment.bloodPressure.recommendation}</small></div>
                    <div><strong>Heart Rate:</strong> ${assessment.heartRate.heartRate} bpm - ${assessment.heartRate.category}<br><small>${assessment.heartRate.recommendation}</small></div>
                    <div><strong>Temperature:</strong> ${assessment.temperature.temperature}C - ${assessment.temperature.category}<br><small>${assessment.temperature.recommendation}</small></div>
                    <div><strong>SpO2:</strong> ${assessment.oxygenSaturation.spO2}% - ${assessment.oxygenSaturation.category}<br><small>${assessment.oxygenSaturation.recommendation}</small></div>
                    <div><strong>Respiratory Rate:</strong> ${assessment.respiratoryRate.respiratoryRate}/min - ${assessment.respiratoryRate.category}<br><small>${assessment.respiratoryRate.recommendation}</small></div>
                </div>
            `;
            displayResult('vitalSignsResult', html);
        } else {
            throw new Error(data.error || 'Failed to assess vital signs');
        }
    } catch (error) {
        displayResult('vitalSignsResult', `Error: ${error.message}`, true);
    }
}

async function calculateBMI() {
    const weight = parseFloat(document.getElementById('gmWeight').value);
    const height = parseFloat(document.getElementById('gmHeight').value);
    const unit = document.getElementById('gmUnit').value;

    if (!weight || !height) {
        displayResult('bmiResult', 'Please enter weight and height', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/general/bmi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weight, height, unit, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const bmi = data.bmi;
            const bsa = data.bsa;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">BMI Results</h4>
                <div style="background: ${bmi.status === 'critical' ? '#FEF2F2' : bmi.status === 'abnormal' ? '#FEF3C7' : '#ECFDF5'}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong style="font-size: 1.5rem;">${bmi.bmi}</strong> - ${bmi.category}
                </div>
                <div style="display: grid; gap: 0.5rem; font-size: 0.9375rem;">
                    <div><strong>Status:</strong> ${bmi.status}</div>
                    <div><strong>Recommendation:</strong> ${bmi.recommendation}</div>
                    <div><strong>Ideal Weight:</strong> ${bmi.idealWeight} kg</div>
                    <div><strong>Weight Difference:</strong> ${bmi.weightDifference > 0 ? '+' : ''}${bmi.weightDifference} kg</div>
                    <div><strong>Body Surface Area (BSA):</strong> ${bsa.bsa} ${bsa.unit}</div>
                    <div><small style="color: var(--text-tertiary);">${bsa.use}</small></div>
                </div>
            `;
            displayResult('bmiResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate BMI');
        }
    } catch (error) {
        displayResult('bmiResult', `Error: ${error.message}`, true);
    }
}

async function formatPrescription() {
    const patientName = document.getElementById('gmPatientName').value;
    const patientAge = parseInt(document.getElementById('gmPatientAge').value);
    const patientGender = document.getElementById('gmPatientGender').value;
    const medicationsText = document.getElementById('gmMedications').value;
    const physicianName = document.getElementById('gmPhysicianName').value;
    const physicianLicense = document.getElementById('gmPhysicianLicense').value;

    if (!patientName || !patientAge || !patientGender || !medicationsText || !physicianName || !physicianLicense) {
        displayResult('prescriptionResult', 'Please fill in all fields', true);
        return;
    }

    try {
        const medications = JSON.parse(medicationsText);

        const response = await fetch('/api/medical/general/prescription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                patientName, patientAge, patientGender, medications, physicianName, physicianLicense,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            let html = `<pre style="background: #F9FAFB; padding: 1.5rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; white-space: pre-wrap;">${data.prescription.formatted}</pre>`;
            displayResult('prescriptionResult', html);
        } else {
            throw new Error(data.error || 'Failed to generate prescription');
        }
    } catch (error) {
        displayResult('prescriptionResult', `Error: ${error.message}`, true);
    }
}

// ============================================================
// CARDIOLOGY FUNCTIONS
// ============================================================

async function calculateFramingham() {
    const age = parseInt(document.getElementById('cardioAge').value);
    const gender = document.getElementById('cardioGender').value;
    const totalCholesterol = parseInt(document.getElementById('cardioTotalChol').value);
    const hdlCholesterol = parseInt(document.getElementById('cardioHDL').value);
    const systolicBP = parseInt(document.getElementById('cardioSystolic').value);
    const isSmoker = document.getElementById('cardioSmoker').checked;
    const isDiabetic = document.getElementById('cardioDiabetic').checked;
    const onBPMeds = document.getElementById('cardioOnBPMeds').checked;

    if (!age || !gender || !totalCholesterol || !hdlCholesterol || !systolicBP) {
        displayResult('framinghamResult', 'Please fill in all required fields', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/cardiology/framingham', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                age, gender, totalCholesterol, hdlCholesterol, systolicBP, isSmoker, isDiabetic, onBPMeds,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Framingham Risk Score</h4>
                <div style="background: ${result.riskCategory === 'High Risk' ? '#FEF2F2' : result.riskCategory === 'Moderate Risk' ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--medical-primary);">${result.risk}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.riskCategory}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.25rem; color: var(--text-tertiary);">${result.timeframe} cardiovascular disease risk</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Points:</strong> ${result.points}<br>
                    <strong>Recommendation:</strong> ${result.recommendation}
                </div>
            `;
            displayResult('framinghamResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate Framingham risk');
        }
    } catch (error) {
        displayResult('framinghamResult', `Error: ${error.message}`, true);
    }
}

async function calculateCHADS2VASc() {
    const age = parseInt(document.getElementById('chadsAge').value);
    const gender = document.getElementById('chadsGender').value;
    const hasCongestiveHF = document.getElementById('chadsHF').checked;
    const hasHypertension = document.getElementById('chadsHTN').checked;
    const hasDiabetes = document.getElementById('chadsDM').checked;
    const hasStrokeTIA = document.getElementById('chadsStroke').checked;
    const hasVascularDisease = document.getElementById('chadsVascular').checked;

    if (!age || !gender) {
        displayResult('chadsResult', 'Please enter age and gender', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/cardiology/chads2vasc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                age, gender, hasCongestiveHF, hasHypertension, hasDiabetes, hasStrokeTIA, hasVascularDisease,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">CHA2DS2-VASc Score</h4>
                <div style="background: ${result.riskLevel === 'High' ? '#FEF2F2' : result.riskLevel === 'Moderate' ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.score}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.riskLevel} Risk</div>
                    <div style="font-size: 0.875rem; margin-top: 0.25rem;">Annual Stroke Risk: ${result.annualStrokeRisk}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Recommendation:</strong> ${result.recommendation}
                </div>
            `;
            displayResult('chadsResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate CHA2DS2-VASc score');
        }
    } catch (error) {
        displayResult('chadsResult', `Error: ${error.message}`, true);
    }
}

async function calculateHASBLED() {
    const hasHypertension = document.getElementById('hasbledHTN').checked;
    const hasRenalDisease = document.getElementById('hasbledRenal').checked;
    const hasLiverDisease = document.getElementById('hasbledLiver').checked;
    const hasStrokeHistory = document.getElementById('hasbledStroke').checked;
    const hasPriorBleed = document.getElementById('hasbledBleed').checked;
    const hasLabileINR = document.getElementById('hasbledINR').checked;
    const isElderly = document.getElementById('hasbledElderly').checked;
    const usesDrugsAlcohol = document.getElementById('hasbledDrugs').checked;
    const usesAntiplatelets = document.getElementById('hasbledAntiplatelets').checked;

    try {
        const response = await fetch('/api/medical/cardiology/hasbled', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                hasHypertension, hasRenalDisease, hasLiverDisease, hasStrokeHistory, hasPriorBleed, hasLabileINR, isElderly, usesDrugsAlcohol, usesAntiplatelets,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">HAS-BLED Score</h4>
                <div style="background: ${result.score >= 3 ? '#FEF2F2' : result.score >= 2 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.score}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">Bleeding Risk: ${result.bleedingRisk}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Recommendation:</strong> ${result.recommendation}<br>
                    <em style="font-size: 0.875rem; color: var(--text-tertiary);">${result.note}</em>
                </div>
            `;
            displayResult('hasbledResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate HAS-BLED score');
        }
    } catch (error) {
        displayResult('hasbledResult', `Error: ${error.message}`, true);
    }
}

async function calculateQTc() {
    const qt = parseInt(document.getElementById('qtInterval').value);
    const heartRate = parseInt(document.getElementById('qtHeartRate').value);
    const formula = document.getElementById('qtFormula').value;

    if (!qt || !heartRate) {
        displayResult('qtcResult', 'Please enter QT interval and heart rate', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/cardiology/qtc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qt, heartRate, formula, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">QTc Calculator</h4>
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--medical-primary);">${result.qtc} ms</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.interpretation}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.25rem; color: var(--text-tertiary);">Using ${result.formula} Formula</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>QT:</strong> ${result.qt} ms<br>
                    <strong>Heart Rate:</strong> ${result.heartRate} bpm<br>
                    <strong>Risk:</strong> ${result.risk}
                </div>
            `;
            displayResult('qtcResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate QTc');
        }
    } catch (error) {
        displayResult('qtcResult', `Error: ${error.message}`, true);
    }
}

async function calculateCardiacOutput() {
    const heartRate = parseInt(document.getElementById('coHeartRate').value);
    const strokeVolume = parseInt(document.getElementById('coStrokeVolume').value);
    const weight = parseFloat(document.getElementById('coWeight').value);
    const height = parseFloat(document.getElementById('coHeight').value);

    if (!heartRate || !strokeVolume || !weight || !height) {
        displayResult('cardiacOutputResult', 'Please fill in all fields', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/cardiology/cardiac-output', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ heartRate, strokeVolume, weight, height, unit: 'metric', hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Cardiac Output</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--medical-primary);">${result.cardiacOutput}</div>
                        <div style="font-size: 0.875rem; color: var(--text-tertiary);">${result.units.co}</div>
                        <div style="font-weight: 600; margin-top: 0.5rem; font-size: 0.875rem;">${result.coInterpretation}</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--medical-primary);">${result.cardiacIndex}</div>
                        <div style="font-size: 0.875rem; color: var(--text-tertiary);">${result.units.ci}</div>
                        <div style="font-weight: 600; margin-top: 0.5rem; font-size: 0.875rem;">${result.ciInterpretation}</div>
                    </div>
                </div>
            `;
            displayResult('cardiacOutputResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate cardiac output');
        }
    } catch (error) {
        displayResult('cardiacOutputResult', `Error: ${error.message}`, true);
    }
}

// ============================================================
// NEUROLOGY FUNCTIONS
// ============================================================

async function calculateGCS() {
    const eyeOpening = parseInt(document.getElementById('gcsEye').value);
    const verbalResponse = parseInt(document.getElementById('gcsVerbal').value);
    const motorResponse = parseInt(document.getElementById('gcsMotor').value);

    try {
        const response = await fetch('/api/medical/neurology/gcs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ eyeOpening, verbalResponse, motorResponse, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Glasgow Coma Scale</h4>
                <div style="background: ${result.totalScore <= 8 ? '#FEF2F2' : result.totalScore <= 12 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.totalScore}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.severity}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.25rem; color: var(--text-tertiary);">${result.scale}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Components:</strong><br>
                     Eye Opening (${result.breakdown.eyeOpening}): ${result.components.eye}<br>
                     Verbal Response (${result.breakdown.verbalResponse}): ${result.components.verbal}<br>
                     Motor Response (${result.breakdown.motorResponse}): ${result.components.motor}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Interpretation:</strong> ${result.interpretation}<br>
                    <strong>Recommendation:</strong> ${result.recommendation}
                </div>
            `;
            displayResult('gcsResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate GCS');
        }
    } catch (error) {
        displayResult('gcsResult', `Error: ${error.message}`, true);
    }
}

async function calculateNIHSS() {
    const totalScore = parseInt(document.getElementById('nihssTotal').value);

    if (isNaN(totalScore) || totalScore < 0 || totalScore > 42) {
        displayResult('nihssResult', 'Please enter a valid NIHSS score (0-42)', true);
        return;
    }

    // Interpret NIHSS locally (simplified)
    let severity, interpretation, recommendation, tPAEligibility;

    if (totalScore === 0) {
        severity = 'No Stroke';
        interpretation = 'No stroke symptoms detected';
        recommendation = 'No acute intervention needed';
        tPAEligibility = 'Not indicated';
    } else if (totalScore <= 4) {
        severity = 'Minor Stroke';
        interpretation = 'Minor neurological deficit';
        recommendation = 'Consider thrombolysis, admit for observation';
        tPAEligibility = 'Consider if within time window';
    } else if (totalScore <= 15) {
        severity = 'Moderate Stroke';
        interpretation = 'Moderate neurological deficit';
        recommendation = 'Thrombolysis candidate if within time window, consider thrombectomy';
        tPAEligibility = 'Likely candidate if no contraindications';
    } else if (totalScore <= 20) {
        severity = 'Moderate to Severe Stroke';
        interpretation = 'Significant neurological deficit';
        recommendation = 'Urgent thrombolysis and/or thrombectomy, ICU monitoring';
        tPAEligibility = 'Strong candidate for intervention';
    } else {
        severity = 'Severe Stroke';
        interpretation = 'Severe neurological deficit';
        recommendation = ' CRITICAL - Consider thrombectomy, ICU admission, neurosurgical consultation';
        tPAEligibility = 'Evaluate for mechanical thrombectomy';
    }

    let html = `
        <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">NIH Stroke Scale (NIHSS)</h4>
        <div style="background: ${totalScore > 20 ? '#FEF2F2' : totalScore > 15 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
            <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${totalScore}</div>
            <div style="font-weight: 600; margin-top: 0.5rem;">${severity}</div>
            <div style="font-size: 0.875rem; margin-top: 0.25rem; color: var(--text-tertiary);">Score Range: 0-42</div>
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
            <strong>Interpretation:</strong> ${interpretation}<br>
            <strong>Recommendation:</strong> ${recommendation}
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
            <strong>tPA Eligibility:</strong> ${tPAEligibility}<br>
            <strong>Time Windows:</strong><br>
             tPA: 4.5 hours from symptom onset<br>
             Thrombectomy: Up to 24 hours in selected patients
        </div>
    `;
    displayResult('nihssResult', html);
}

async function calculateABCD2() {
    const age = parseInt(document.getElementById('abcd2Age').value);
    const bloodPressure = parseInt(document.getElementById('abcd2BP').value);
    const clinicalFeatures = parseInt(document.getElementById('abcd2Clinical').value);
    const duration = parseInt(document.getElementById('abcd2Duration').value);
    const diabetes = parseInt(document.getElementById('abcd2Diabetes').value);

    const totalScore = age + bloodPressure + clinicalFeatures + duration + diabetes;

    // Interpret ABCD2
    let risk, recommendation;
    if (totalScore <= 3) {
        risk = 'Low (2-day stroke risk: 1.0%)';
        recommendation = 'Outpatient evaluation within 7 days';
    } else if (totalScore <= 5) {
        risk = 'Moderate (2-day stroke risk: 4.1%)';
        recommendation = 'Admit or urgent outpatient evaluation within 24-48 hours';
    } else {
        risk = 'High (2-day stroke risk: 8.1%)';
        recommendation = ' Hospital admission recommended - high stroke risk';
    }

    let html = `
        <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">ABCD2 Score</h4>
        <div style="background: ${totalScore >= 6 ? '#FEF2F2' : totalScore >= 4 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
            <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${totalScore}</div>
            <div style="font-weight: 600; margin-top: 0.5rem;">${risk}</div>
            <div style="font-size: 0.875rem; margin-top: 0.25rem; color: var(--text-tertiary);">Score Range: 0-7</div>
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
            <strong>Recommendation:</strong> ${recommendation}<br>
            <strong>Components:</strong><br>
             Age 60: ${age} point${age !== 1 ? 's' : ''}<br>
             BP 140/90: ${bloodPressure} point${bloodPressure !== 1 ? 's' : ''}<br>
             Clinical features: ${clinicalFeatures} point${clinicalFeatures !== 1 ? 's' : ''}<br>
             Duration: ${duration} point${duration !== 1 ? 's' : ''}<br>
             Diabetes: ${diabetes} point${diabetes !== 1 ? 's' : ''}
        </div>
    `;
    displayResult('abcd2Result', html);
}

async function classifySeizure() {
    const seizureType = document.getElementById('seizureType').value;

    if (!seizureType) {
        displayResult('seizureResult', 'Please select a seizure type', true);
        return;
    }

    const seizureInfo = {
        'focal-aware': {
            name: 'Focal Aware Seizure (Simple Partial)',
            description: 'Seizure with preserved awareness, affecting one part of the brain',
            symptoms: 'Motor twitching, sensory changes, autonomic symptoms, but patient remains conscious',
            treatment: 'Carbamazepine, Levetiracetam, Lamotrigine',
            prognosis: 'Generally good with medication'
        },
        'focal-impaired': {
            name: 'Focal Impaired Awareness (Complex Partial)',
            description: 'Seizure with impaired awareness',
            symptoms: 'Altered consciousness, automatisms (lip smacking, hand movements), confusion after',
            treatment: 'Carbamazepine, Oxcarbazepine, Levetiracetam',
            prognosis: 'Good with appropriate medication, may need long-term therapy'
        },
        'generalized-tonic-clonic': {
            name: 'Generalized Tonic-Clonic (Grand Mal)',
            description: 'Most dramatic type involving whole brain',
            symptoms: 'Loss of consciousness, muscle stiffening (tonic), jerking (clonic), tongue biting, incontinence',
            treatment: 'Valproate, Levetiracetam, Lamotrigine, emergency: Benzodiazepines',
            prognosis: 'Controllable with medication, requires lifelong management'
        },
        'absence': {
            name: 'Absence Seizure (Petit Mal)',
            description: 'Brief loss of awareness, common in children',
            symptoms: 'Blank stare, subtle body movements, brief (seconds), no memory of event',
            treatment: 'Ethosuximide, Valproate',
            prognosis: 'Excellent, often resolves in adolescence'
        },
        'myoclonic': {
            name: 'Myoclonic Seizure',
            description: 'Brief muscle jerks',
            symptoms: 'Sudden muscle jerks, usually bilateral, can occur in clusters',
            treatment: 'Valproate, Levetiracetam, Clonazepam',
            prognosis: 'Variable, depends on underlying syndrome'
        },
        'atonic': {
            name: 'Atonic Seizure (Drop Attacks)',
            description: 'Sudden loss of muscle tone',
            symptoms: 'Sudden falls, head drops, high injury risk',
            treatment: 'Valproate, Lamotrigine, protective helmets may be needed',
            prognosis: 'Challenging to treat, injury prevention important'
        }
    };

    const info = seizureInfo[seizureType];

    let html = `
        <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">${info.name}</h4>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
            <strong>Description:</strong> ${info.description}
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
            <strong>Symptoms:</strong> ${info.symptoms}
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
            <strong>Treatment:</strong> ${info.treatment}
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
            <strong>Prognosis:</strong> ${info.prognosis}
        </div>
    `;
    displayResult('seizureResult', html);
}

// ============================================================
// ONCOLOGY FUNCTIONS
// ============================================================

async function calculateTNM() {
    const cancerType = document.getElementById('tnmCancerType').value;
    const t = document.getElementById('tnmT').value;
    const n = document.getElementById('tnmN').value;
    const m = document.getElementById('tnmM').value;

    if (!cancerType || !t || !n || !m) {
        displayResult('tnmResult', 'Please fill in all fields', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/oncology/tnm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cancerType, t, n, m, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">TNM Staging - ${cancerType.charAt(0).toUpperCase() + cancerType.slice(1)} Cancer</h4>
                <div style="background: ${result.stage === 'IV' ? '#FEF2F2' : result.stage === 'III' ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">Stage ${result.stage}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.stageGroup}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">${result.tnm}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Prognosis:</strong> ${result.prognosis}<br>
                    <strong>5-Year Survival:</strong> ${result.fiveYearSurvival}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Treatment Approach:</strong> ${result.treatment}
                </div>
                <div style="padding: 0.75rem; background: #FEF3C7; border-radius: 8px; font-size: 0.875rem;">
                    <em>${result.note}</em>
                </div>
            `;
            displayResult('tnmResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate TNM stage');
        }
    } catch (error) {
        displayResult('tnmResult', `Error: ${error.message}`, true);
    }
}

async function interpretECOG() {
    const score = parseInt(document.getElementById('ecogScore').value);

    if (isNaN(score) || score < 0 || score > 4) {
        displayResult('ecogResult', 'Please select an ECOG score', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/oncology/ecog', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ score, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">ECOG Performance Status</h4>
                <div style="background: ${result.score >= 3 ? '#FEF2F2' : result.score >= 2 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.score}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.description}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Details:</strong> ${result.details}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Prognostic Implication:</strong> ${result.prognosticImplication}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Treatment Eligibility:</strong> ${result.treatmentEligibility}
                </div>
            `;
            displayResult('ecogResult', html);
        } else {
            throw new Error(data.error || 'Failed to interpret ECOG');
        }
    } catch (error) {
        displayResult('ecogResult', `Error: ${error.message}`, true);
    }
}

async function interpretKarnofsky() {
    const score = parseInt(document.getElementById('karnofskyScore').value);

    if (isNaN(score) || score < 10 || score > 100) {
        displayResult('karnofskyResult', 'Please select a Karnofsky score', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/oncology/karnofsky', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ score, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Karnofsky Performance Status</h4>
                <div style="background: ${result.prognosis === 'Poor' || result.prognosis === 'Very poor' ? '#FEF2F2' : result.prognosis === 'Fair' ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.score}%</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.description}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Category:</strong> ${result.category}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Prognosis:</strong> ${result.prognosis}
                </div>
            `;
            displayResult('karnofskyResult', html);
        } else {
            throw new Error(data.error || 'Failed to interpret Karnofsky');
        }
    } catch (error) {
        displayResult('karnofskyResult', `Error: ${error.message}`, true);
    }
}

async function calculateChemoDose() {
    const weight = parseFloat(document.getElementById('chemoWeight').value);
    const height = parseFloat(document.getElementById('chemoHeight').value);
    const dosePerBSA = parseFloat(document.getElementById('chemoDosePerBSA').value);

    if (!weight || !height || !dosePerBSA) {
        displayResult('chemoDoseResult', 'Please fill in all fields', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/oncology/chemo-dose', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weight, height, dosePerBSA, unit: 'metric', hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Chemotherapy Dose Calculation</h4>
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--medical-primary);">${result.calculatedDose} mg</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">Total Dose</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>BSA (Mosteller):</strong> ${result.bsa} m<br>
                    <strong>Dose per m:</strong> ${result.dosePerBSA} mg/m<br>
                    <strong>Patient:</strong> ${weight} kg, ${height} cm
                </div>
            `;
            displayResult('chemoDoseResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate chemo dose');
        }
    } catch (error) {
        displayResult('chemoDoseResult', `Error: ${error.message}`, true);
    }
}

// Due to length constraints, I'll create a second file for the remaining specialties
// ============================================================
// PEDIATRICS FUNCTIONS
// ============================================================

async function calculateGrowthChart() {
    const ageMonths = parseInt(document.getElementById('pedAgeMonths').value);
    const gender = document.getElementById('pedGender').value;
    const weight = parseFloat(document.getElementById('pedWeight').value);
    const height = parseFloat(document.getElementById('pedHeight').value);
    const headCircumference = parseFloat(document.getElementById('pedHeadCirc').value) || null;

    if (!ageMonths || !gender || !weight || !height) {
        displayResult('growthChartResult', 'Please fill in required fields (age, gender, weight, height)', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/pediatrics/growth-chart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ageMonths, gender, weight, height, headCircumference, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Growth Chart Analysis</h4>
                <div style="background: ${result.interpretation.includes('Failure to thrive') ? '#FEF2F2' : result.interpretation.includes('Overweight') ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-weight: 700; font-size: 1.25rem;">${result.nutritionalStatus}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-tertiary);">${result.gender}  ${result.ageMonths} months old</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Measurements:</strong><br>
                     Weight: ${result.measurements.weight}<br>
                     Height: ${result.measurements.height}<br>
                    ${result.measurements.headCircumference !== 'N/A' ? ' Head Circumference: ' + result.measurements.headCircumference + '<br>' : ''}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Percentiles:</strong><br>
                     Weight-for-age: ${result.percentiles.weight}<br>
                     Height-for-age: ${result.percentiles.height}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Interpretation:</strong> ${result.interpretation}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Recommendation:</strong> ${result.recommendation}<br>
                    <small style="color: var(--text-tertiary);">${result.reference}</small>
                </div>
            `;
            displayResult('growthChartResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate growth percentiles');
        }
    } catch (error) {
        displayResult('growthChartResult', `Error: ${error.message}`, true);
    }
}

async function calculateAPGAR() {
    const appearance = parseInt(document.getElementById('apgarAppearance').value);
    const pulse = parseInt(document.getElementById('apgarPulse').value);
    const grimace = parseInt(document.getElementById('apgarGrimace').value);
    const activity = parseInt(document.getElementById('apgarActivity').value);
    const respiration = parseInt(document.getElementById('apgarRespiration').value);
    const timePoint = document.getElementById('apgarTime').value;

    try {
        const response = await fetch('/api/medical/pediatrics/apgar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ appearance, pulse, grimace, activity, respiration, timePoint, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">APGAR Score - ${result.timePoint}</h4>
                <div style="background: ${result.totalScore < 4 ? '#FEF2F2' : result.totalScore < 7 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.totalScore}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.interpretation}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">Scale: 0-10</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Components:</strong><br>
                     Appearance: ${result.breakdown.appearance}<br>
                     Pulse: ${result.breakdown.pulse}<br>
                     Grimace: ${result.breakdown.grimace}<br>
                     Activity: ${result.breakdown.activity}<br>
                     Respiration: ${result.breakdown.respiration}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Intervention:</strong> ${result.intervention}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Prognosis:</strong> ${result.prognosis}
                </div>
                <div style="padding: 0.75rem; background: #FEF3C7; border-radius: 8px; font-size: 0.875rem;">
                    <em>${result.note}</em><br>
                    <strong>Follow-up:</strong> ${result.followUp}
                </div>
            `;
            displayResult('apgarResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate APGAR');
        }
    } catch (error) {
        displayResult('apgarResult', `Error: ${error.message}`, true);
    }
}

async function calculatePediatricDose() {
    const medication = document.getElementById('pedMedication').value;
    const weightKg = parseFloat(document.getElementById('pedDoseWeight').value);
    const ageYears = parseInt(document.getElementById('pedDoseAge').value);
    const dosePerKg = parseFloat(document.getElementById('pedDosePerKg').value);
    const maxDose = parseFloat(document.getElementById('pedMaxDose').value);
    const frequency = document.getElementById('pedFrequency').value;
    const route = document.getElementById('pedRoute').value;

    if (!medication || !weightKg || !ageYears || !dosePerKg || !maxDose || !frequency || !route) {
        displayResult('pediatricDoseResult', 'Please fill in all fields', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/pediatrics/dosage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ medication, weightKg, ageYears, dosePerKg, maxDose, frequency, route, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Pediatric Dose - ${result.medication}</h4>
                <div style="background: ${result.isCapped ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--medical-primary);">${result.calculatedDose} mg</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.frequency}  ${result.route}</div>
                    ${result.isCapped ? '<div style="color: #D97706; margin-top: 0.5rem; font-weight: 600;"> Dose capped at maximum</div>' : ''}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Patient:</strong> ${result.ageYears} years old, ${result.weightKg} kg<br>
                    <strong>Dose Calculation:</strong> ${result.dosePerKg} mg/kg  ${result.weightKg} kg = ${result.calculatedDose} mg<br>
                    <strong>Maximum Dose:</strong> ${result.maxDose} mg
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Total Daily Dose:</strong> ${result.totalDailyDose} mg/day
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Safety Recommendations:</strong><br>
                     Always double-check pediatric doses<br>
                     Consider renal/hepatic function<br>
                     Monitor for adverse effects<br>
                     Adjust dose based on clinical response
                </div>
            `;
            displayResult('pediatricDoseResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate pediatric dose');
        }
    } catch (error) {
        displayResult('pediatricDoseResult', `Error: ${error.message}`, true);
    }
}

// ============================================================
// PSYCHIATRY FUNCTIONS
// ============================================================

async function calculatePHQ9() {
    const q1 = parseInt(document.getElementById('phq9Q1').value) || 0;
    const q2 = parseInt(document.getElementById('phq9Q2').value) || 0;
    const q3 = parseInt(document.getElementById('phq9Q3').value) || 0;
    const q4 = parseInt(document.getElementById('phq9Q4').value) || 0;
    const q5 = parseInt(document.getElementById('phq9Q5').value) || 0;
    const q6 = parseInt(document.getElementById('phq9Q6').value) || 0;
    const q7 = parseInt(document.getElementById('phq9Q7').value) || 0;
    const q8 = parseInt(document.getElementById('phq9Q8').value) || 0;
    const q9 = parseInt(document.getElementById('phq9Q9').value) || 0;

    try {
        const response = await fetch('/api/medical/psychiatry/phq9', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                littleInterest: q1, feelingDown: q2, sleepProblems: q3, feelingTired: q4,
                appetiteProblems: q5, feelingBad: q6, troubleConcentrating: q7, movingSpeaking: q8,
                thoughtsHurting: q9, functionalImpairment: 'not-specified',
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">PHQ-9 Depression Screening</h4>
                <div style="background: ${result.totalScore >= 20 ? '#FEF2F2' : result.totalScore >= 10 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.totalScore}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.severity}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-tertiary);">${result.scale}</div>
                </div>
                ${result.suicideRisk.includes('SUICIDE RISK') ? `<div style="background: #FEE2E2; border: 2px solid #DC2626; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: 700; color: #991B1B;">${result.suicideRisk}</div>` : ''}
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Interpretation:</strong> ${result.interpretation}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Recommendation:</strong> ${result.recommendation}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Follow-up:</strong> ${result.followUp}<br>
                    <strong>Treatment Goal:</strong> ${result.treatmentGoal}
                </div>
            `;
            displayResult('phq9Result', html);
        } else {
            throw new Error(data.error || 'Failed to calculate PHQ-9');
        }
    } catch (error) {
        displayResult('phq9Result', `Error: ${error.message}`, true);
    }
}

async function calculateGAD7() {
    const q1 = parseInt(document.getElementById('gad7Q1').value) || 0;
    const q2 = parseInt(document.getElementById('gad7Q2').value) || 0;
    const q3 = parseInt(document.getElementById('gad7Q3').value) || 0;
    const q4 = parseInt(document.getElementById('gad7Q4').value) || 0;
    const q5 = parseInt(document.getElementById('gad7Q5').value) || 0;
    const q6 = parseInt(document.getElementById('gad7Q6').value) || 0;
    const q7 = parseInt(document.getElementById('gad7Q7').value) || 0;

    try {
        const response = await fetch('/api/medical/psychiatry/gad7', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                feelingNervous: q1, cantStopWorrying: q2, worryingTooMuch: q3, troubleRelaxing: q4,
                restless: q5, easilyAnnoyed: q6, feelingAfraid: q7,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">GAD-7 Anxiety Screening</h4>
                <div style="background: ${result.totalScore >= 15 ? '#FEF2F2' : result.totalScore >= 10 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.totalScore}</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.severity}</div>
                    <div style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-tertiary);">${result.scale}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Interpretation:</strong> ${result.interpretation}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Recommendation:</strong> ${result.recommendation}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Further Assessment:</strong> ${result.specificDisorders}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Treatment Goal:</strong> ${result.treatmentGoal}
                </div>
            `;
            displayResult('gad7Result', html);
        } else {
            throw new Error(data.error || 'Failed to calculate GAD-7');
        }
    } catch (error) {
        displayResult('gad7Result', `Error: ${error.message}`, true);
    }
}

async function calculateMMSE() {
    const orientation = parseInt(document.getElementById('mmseOrientation').value) || 0;
    const registration = parseInt(document.getElementById('mmseRegistration').value) || 0;
    const attention = parseInt(document.getElementById('mmseAttention').value) || 0;
    const recall = parseInt(document.getElementById('mmseRecall').value) || 0;
    const language = parseInt(document.getElementById('mmseLanguage').value) || 0;
    const construction = parseInt(document.getElementById('mmseConstruction').value) || 0;

    try {
        const response = await fetch('/api/medical/psychiatry/mmse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orientation, registration, attention, recall, language, construction, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">MMSE (Mini-Mental State Examination)</h4>
                <div style="background: ${result.totalScore < 18 ? '#FEF2F2' : result.totalScore < 24 ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--medical-primary);">${result.totalScore}/30</div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">${result.interpretation}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Cognitive Status:</strong> ${result.cognitiveStatus}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Components:</strong><br>
                     Orientation: ${result.breakdown.orientation}/10<br>
                     Registration: ${result.breakdown.registration}/3<br>
                     Attention: ${result.breakdown.attention}/5<br>
                     Recall: ${result.breakdown.recall}/3<br>
                     Language: ${result.breakdown.language}/8<br>
                     Construction: ${result.breakdown.construction}/1
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Recommendation:</strong> ${result.recommendation}
                </div>
            `;
            displayResult('mmseResult', html);
        } else {
            throw new Error(data.error || 'Failed to calculate MMSE');
        }
    } catch (error) {
        displayResult('mmseResult', `Error: ${error.message}`, true);
    }
}

// ============================================================
// ORTHOPEDICS FUNCTIONS
// ============================================================

async function classifySalterHarris() {
    const type = document.getElementById('salterHarrisType').value;

    if (!type) {
        displayResult('salterHarrisResult', 'Please select a Salter-Harris type', true);
        return;
    }

    try {
        const response = await fetch('/api/medical/orthopedics/salter-harris', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001' })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">${result.type}</h4>
                <div style="background: ${type === 'V' || type === 'IV' ? '#FEF2F2' : type === 'III' ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: 0.5rem;">${result.mnemonic}</div>
                    <div>${result.description}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Involvement:</strong> ${result.involvement}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>X-ray Findings:</strong> ${result.xrayFindings}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Treatment:</strong> ${result.treatment}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Prognosis:</strong> ${result.prognosis}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Complications:</strong> ${result.complications}
                </div>
                <div style="padding: 1rem; background: ${result.referral.includes('') ? '#FEE2E2' : 'var(--bg-secondary)'}; border-radius: 8px;">
                    <strong>Referral:</strong> ${result.referral}<br>
                    <strong>Monitoring:</strong> ${result.monitoring}
                </div>
            `;
            displayResult('salterHarrisResult', html);
        } else {
            throw new Error(data.error || 'Failed to classify Salter-Harris fracture');
        }
    } catch (error) {
        displayResult('salterHarrisResult', `Error: ${error.message}`, true);
    }
}

async function applyOttawaAnkleRules() {
    const boneTendernessLateralMalleolus = document.getElementById('ottawaAnkleLateral').checked;
    const boneTendernessMedialMalleolus = document.getElementById('ottawaAnkleMedial').checked;
    const boneTendernessNavicular = document.getElementById('ottawaAnkleNavicular').checked;
    const boneTendernessBase5thMetatarsal = document.getElementById('ottawaAnkle5thMet').checked;
    const unableToWalkImmediately = document.getElementById('ottawaAnkleWalkImmediate').checked;
    const unableToWalkInED = document.getElementById('ottawaAnkleWalkED').checked;

    try {
        const response = await fetch('/api/medical/orthopedics/ottawa-ankle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                boneTendernessLateralMalleolus, boneTendernessMedialMalleolus, boneTendernessNavicular,
                boneTendernessBase5thMetatarsal, unableToWalkImmediately, unableToWalkInED,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Ottawa Ankle Rules</h4>
                <div style="background: ${result.xrayRequired ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 800; color: var(--medical-primary);">${result.xrayRequired ? ' X-rays INDICATED' : ' X-rays NOT Needed'}</div>
                    <div style="margin-top: 0.5rem;">${result.recommendation}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Criteria Met:</strong><br>
                    ${result.ankleSeries ? ' Ankle series indicated<br>' : ''}
                    ${result.footSeries ? ' Foot series indicated<br>' : ''}
                    ${!result.ankleSeries && !result.footSeries ? ' No imaging criteria met<br>' : ''}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Treatment:</strong> ${result.treatment}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Performance:</strong><br>
                     Sensitivity: ${result.sensitivity}<br>
                     Specificity: ${result.specificity}
                </div>
            `;
            displayResult('ottawaAnkleResult', html);
        } else {
            throw new Error(data.error || 'Failed to apply Ottawa Ankle Rules');
        }
    } catch (error) {
        displayResult('ottawaAnkleResult', `Error: ${error.message}`, true);
    }
}

async function applyOttawaKneeRules() {
    const age55OrOlder = document.getElementById('ottawaKneeAge').checked;
    const isolatedTendernessPatellar = document.getElementById('ottawaKneePatellar').checked;
    const tendernessHeadFibula = document.getElementById('ottawaKneeFibula').checked;
    const unableToFlex90Degrees = document.getElementById('ottawaKneeFlex').checked;
    const unableToWalk4Steps = document.getElementById('ottawaKneeWalk').checked;

    try {
        const response = await fetch('/api/medical/orthopedics/ottawa-knee', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                age55OrOlder, isolatedTendernessPatellar, tendernessHeadFibula,
                unableToFlex90Degrees, unableToWalk4Steps,
                hospital_id: 'hospital-001', user_id: 'user-001', patient_id: 'patient-001'
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            let html = `
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--medical-primary);">Ottawa Knee Rules</h4>
                <div style="background: ${result.xrayRequired ? '#FEF3C7' : '#ECFDF5'}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 800; color: var(--medical-primary);">${result.xrayRequired ? ' X-rays INDICATED' : ' X-rays NOT Needed'}</div>
                    <div style="margin-top: 0.5rem;">${result.recommendation}</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Criteria Assessed:</strong><br>
                     Age  55: ${age55OrOlder ? 'Yes' : 'No'}<br>
                     Isolated patellar tenderness: ${isolatedTendernessPatellar ? 'Yes' : 'No'}<br>
                     Tenderness at head of fibula: ${tendernessHeadFibula ? 'Yes' : 'No'}<br>
                     Unable to flex 90: ${unableToFlex90Degrees ? 'Yes' : 'No'}<br>
                     Unable to walk 4 steps: ${unableToWalk4Steps ? 'Yes' : 'No'}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Treatment:</strong> ${result.treatment}
                </div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <strong>Performance:</strong><br>
                     Sensitivity: ${result.sensitivity}<br>
                     Specificity: ${result.specificity}
                </div>
            `;
            displayResult('ottawaKneeResult', html);
        } else {
            throw new Error(data.error || 'Failed to apply Ottawa Knee Rules');
        }
    } catch (error) {
        displayResult('ottawaKneeResult', `Error: ${error.message}`, true);
    }
}

// Initialize on load
window.addEventListener('load', () => {
    init();

    // Open first category by default (Medical Specialties)
    const firstCategory = document.querySelector('.nav-category');
    if (firstCategory) {
        firstCategory.classList.add('open');
    }
});

// Close modal on outside click
window.addEventListener('click', (e) => {
    const modal = document.getElementById('emergencyModal');
    if (e.target === modal) {
        closeEmergencyModal();
    }

    // Close user dropdown if clicking outside
    const userDropdown = document.getElementById('userDropdown');
    if (userDropdown && !e.target.closest('.user-menu-wrapper')) {
        userDropdown.style.display = 'none';
    }
});

// ============================================================
// HOSPITAL MANAGEMENT PANEL FUNCTIONS
// ============================================================

// Toggle User Dropdown Menu
function toggleUserDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('userDropdown');
    const arrow = document.getElementById('dropdownArrow');

    if (dropdown.style.display === 'none' || !dropdown.style.display) {
        dropdown.style.display = 'block';
        if (arrow) arrow.style.transform = 'rotate(180deg)';
    } else {
        dropdown.style.display = 'none';
        if (arrow) arrow.style.transform = 'rotate(0deg)';
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('userDropdown');
    const menuWrapper = document.querySelector('.user-menu-wrapper');

    if (dropdown && menuWrapper && !menuWrapper.contains(event.target)) {
        dropdown.style.display = 'none';
        const arrow = document.getElementById('dropdownArrow');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
    }
});

// Show Patient History Modal
function showPatientHistory() {
    const history = JSON.parse(localStorage.getItem('medicalAI_patientHistory') || '[]');

    if (history.length === 0) {
        alert('No patient consultations found in history.');
        return;
    }

    let historyHTML = `
        <div id="patientHistoryModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem;">
            <div style="background: var(--bg-primary); border-radius: 16px; max-width: 900px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="21 8 21 21 3 21 3 8"/>
                            <rect x="1" y="3" width="22" height="5"/>
                            <line x1="10" y1="12" x2="14" y2="12"/>
                        </svg>
                        Patient History (${history.length} consultations)
                    </h2>
                    <button onclick="closePatientHistoryModal()" style="width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div style="display: flex; flex-direction: column; gap: 16px;">
    `;

    history.forEach((item, index) => {
        historyHTML += `
            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.2s;">
                <div style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    ${item.date}  ${item.specialization || 'General Medicine'}
                </div>
                <div style="font-weight: 600; color: var(--primary-accent); margin-bottom: 8px; font-size: 14px;">Patient Query:</div>
                <div style="margin-bottom: 16px; color: var(--text-primary); line-height: 1.6;">${escapeHtml(item.query)}</div>
                <div style="font-weight: 600; color: var(--primary-accent); margin-bottom: 8px; font-size: 14px;">AI Response:</div>
                <div style="color: var(--text-secondary); line-height: 1.6;">${escapeHtml(item.response.substring(0, 300))}${item.response.length > 300 ? '...' : ''}</div>
            </div>
        `;
    });

    historyHTML += `
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', historyHTML);

    // Close user dropdown
    document.getElementById('userDropdown').style.display = 'none';
}

function closePatientHistoryModal() {
    const modal = document.getElementById('patientHistoryModal');
    if (modal) modal.remove();
}

// Show Hospital Settings Modal
function showHospitalSettings() {
    const settings = JSON.parse(localStorage.getItem('medicalAI_hospitalSettings') || '{}');

    // Default settings
    const defaultSettings = {
        hospitalName: settings.hospitalName || '',
        department: settings.department || 'general-medicine',
        language: settings.language || 'en',
        aiTemperature: settings.aiTemperature || 0.3,
        maxTokens: settings.maxTokens || 800,
        enableAudit: settings.enableAudit !== false,
        emergencyAlert: settings.emergencyAlert !== false
    };

    const modalHTML = `
        <div id="hospitalSettingsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                    <h2 style="margin: 0; color: var(--text-primary); font-size: 24px; display: flex; align-items: center; gap: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
                        </svg>
                        Hospital Settings
                    </h2>
                    <button onclick="closeHospitalSettingsModal()" style="width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; color: var(--text-secondary);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; color: var(--text-primary); margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); font-weight: 600;">Hospital Information</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">Hospital Name</label>
                        <input type="text" id="settingsHospitalName" value="${defaultSettings.hospitalName}" placeholder="Enter hospital name" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">Primary Department</label>
                        <select id="settingsDepartment" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="general-medicine" ${defaultSettings.department === 'general-medicine' ? 'selected' : ''}>General Medicine</option>
                            <option value="cardiology" ${defaultSettings.department === 'cardiology' ? 'selected' : ''}>Cardiology</option>
                            <option value="neurology" ${defaultSettings.department === 'neurology' ? 'selected' : ''}>Neurology</option>
                            <option value="radiology" ${defaultSettings.department === 'radiology' ? 'selected' : ''}>Radiology</option>
                            <option value="oncology" ${defaultSettings.department === 'oncology' ? 'selected' : ''}>Oncology</option>
                            <option value="pediatrics" ${defaultSettings.department === 'pediatrics' ? 'selected' : ''}>Pediatrics</option>
                            <option value="psychiatry" ${defaultSettings.department === 'psychiatry' ? 'selected' : ''}>Psychiatry</option>
                            <option value="orthopedics" ${defaultSettings.department === 'orthopedics' ? 'selected' : ''}>Orthopedics</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; color: var(--text-primary); margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); font-weight: 600;">AI Configuration</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">AI Temperature: ${defaultSettings.aiTemperature}</label>
                        <input type="range" id="settingsTemperature" min="0" max="1" step="0.1" value="${defaultSettings.aiTemperature}" style="width: 100%; accent-color: var(--primary-accent);" oninput="document.getElementById('tempValueDisplay').textContent = this.value">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                            <span>Precise (0.0)</span>
                            <span id="tempValueDisplay" style="color: var(--primary-accent); font-weight: 600;">${defaultSettings.aiTemperature}</span>
                            <span>Creative (1.0)</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500;">Maximum Tokens</label>
                        <select id="settingsMaxTokens" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="400" ${defaultSettings.maxTokens === 400 ? 'selected' : ''}>400 (Short)</option>
                            <option value="800" ${defaultSettings.maxTokens === 800 ? 'selected' : ''}>800 (Medium)</option>
                            <option value="1200" ${defaultSettings.maxTokens === 1200 ? 'selected' : ''}>1200 (Long)</option>
                            <option value="2000" ${defaultSettings.maxTokens === 2000 ? 'selected' : ''}>2000 (Very Long)</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; color: var(--text-primary); margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); font-weight: 600;">Security & Compliance</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <input type="checkbox" id="settingsEnableAudit" ${defaultSettings.enableAudit ? 'checked' : ''} style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-accent);">
                            <span style="color: var(--text-primary); font-size: 14px;">Enable Audit Logging (HIPAA Compliance)</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <input type="checkbox" id="settingsEmergencyAlert" ${defaultSettings.emergencyAlert ? 'checked' : ''} style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-accent);">
                            <span style="color: var(--text-primary); font-size: 14px;">Emergency Detection Alerts</span>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeHospitalSettingsModal()" style="padding: 12px 24px; background: var(--gray-100); border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--text-secondary); font-weight: 500;">Cancel</button>
                    <button onclick="saveHospitalSettings()" style="padding: 12px 24px; background: var(--primary-accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">Save Settings</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Close user dropdown
    document.getElementById('userDropdown').style.display = 'none';
}

function closeHospitalSettingsModal() {
    const modal = document.getElementById('hospitalSettingsModal');
    if (modal) modal.remove();
}

function saveHospitalSettings() {
    const settings = {
        hospitalName: document.getElementById('settingsHospitalName').value,
        department: document.getElementById('settingsDepartment').value,
        aiTemperature: parseFloat(document.getElementById('settingsTemperature').value),
        maxTokens: parseInt(document.getElementById('settingsMaxTokens').value),
        enableAudit: document.getElementById('settingsEnableAudit').checked,
        emergencyAlert: document.getElementById('settingsEmergencyAlert').checked,
        updatedAt: new Date().toISOString()
    };

    localStorage.setItem('medicalAI_hospitalSettings', JSON.stringify(settings));
    closeHospitalSettingsModal();
    alert(' Hospital settings saved successfully!');
}

// Logout Function
function logoutHospital() {
    if (confirm('Are you sure you want to sign out?')) {
        // Clear session data (optional)
        // localStorage.clear();

        alert(' Signed out successfully!');
        document.getElementById('userDropdown').style.display = 'none';

        // Optional: redirect to login page
        // window.location.href = '/login.html';
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================
// NEURO HEALTH AI - JAVASCRIPT FUNCTIONS
// ============================================

// 1. Brain Imaging Analysis Functions
let uploadedNeuroImage = null;

function uploadNeuroImaging(event) {
    const file = event.target.files[0];
    if (!file) return;

    uploadedNeuroImage = file;

    // Show file info
    const fileInfo = document.createElement('div');
    fileInfo.style.cssText = 'margin-top: 1rem; padding: 1rem; background: #F0FDF4; border-radius: 8px; border-left: 4px solid #10A37F;';
    fileInfo.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div style="font-weight: 600; color: #065F46; margin-bottom: 0.25rem;">File Uploaded</div>
                <div style="font-size: 0.875rem; color: #047857;">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</div>
            </div>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #10A37F;">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
        </div>
    `;

    const container = document.querySelector('#neuroImagingFileInput').parentElement;
    const existingInfo = container.querySelector('div[style*="margin-top: 1rem"]');
    if (existingInfo) existingInfo.remove();
    container.appendChild(fileInfo);
}

async function analyzeNeuroImaging() {
    if (!uploadedNeuroImage) {
        alert('Please upload a brain scan first');
        return;
    }

    const modality = document.getElementById('neuroImagingModality').value;
    const analysisType = document.getElementById('neuroImagingAnalysisType').value;

    const button = event.target;
    button.disabled = true;
    button.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px; animation: spin 1s linear infinite;">
            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
        </svg>
        Analyzing with LyDian AI Vision...
    `;

    try {
        // REAL API CALL to /api/neuro/imaging-analysis
        const formData = new FormData();
        formData.append('image', uploadedNeuroImage);
        formData.append('modality', modality);
        formData.append('analysisType', analysisType);

        const response = await fetch('/api/neuro/imaging-analysis', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();

        // Display results
        document.getElementById('neuroImagingResults').style.display = 'block';
        document.getElementById('neuroImagingAnalysis').textContent = data.analysis;
        document.getElementById('neuroImagingConfidence').textContent = data.metrics.confidence;
        document.getElementById('neuroImagingVolume').textContent = data.metrics.volume;
        document.getElementById('neuroImagingFindings').textContent = data.metrics.findings;
        document.getElementById('neuroImagingCitations').innerHTML = data.citations.map(c =>
            `<p style="margin-bottom: 0.5rem;"> ${c}</p>`
        ).join('');

        button.innerHTML = ' Analysis Complete';
        button.style.background = 'linear-gradient(135deg, #059669, #047857)';

        // Scroll to results
        document.getElementById('neuroImagingResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    } catch (error) {
        console.error('Neuro imaging analysis error:', error);
        alert('Analysis failed: ' + error.message);
        button.disabled = false;
        button.innerHTML = 'Analyze with LyDian AI Vision';
    }
}

// 2. Neuro Health Index Functions
async function calculateNeuroHealthIndex() {
    const age = parseInt(document.getElementById('neuroHealthAge').value);
    const gender = document.getElementById('neuroHealthGender').value;
    const cognitiveScore = parseInt(document.getElementById('neuroHealthCognitive').value) || 0;
    const medicalHistory = document.getElementById('neuroHealthHistory').value;
    const exercise = document.getElementById('neuroHealthExercise').checked;
    const sleep = document.getElementById('neuroHealthSleep').checked;
    const diet = document.getElementById('neuroHealthDiet').checked;
    const social = document.getElementById('neuroHealthSocial').checked;

    if (!age || !gender) {
        alert('Please fill in Age and Gender');
        return;
    }

    try {
        // REAL API CALL to /api/neuro/health-index
        const response = await fetch('/api/neuro/health-index', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                age,
                gender,
                cognitiveScore,
                medicalHistory,
                exercise,
                sleep,
                diet,
                social
            })
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();

        // Display results
        document.getElementById('neuroHealthIndexResults').style.display = 'block';
        document.getElementById('neuroHealthIndexScore').textContent = data.neuroHealthIndex;
        document.getElementById('neuroHealthIndexCategory').textContent = data.category;
        document.getElementById('neuroHealthCognitiveScore').textContent = data.subScores.cognitive;
        document.getElementById('neuroHealthLifestyleScore').textContent = data.subScores.lifestyle;
        document.getElementById('neuroHealthRiskScore').textContent = data.subScores.riskFactors;
        document.getElementById('neuroHealthAgeScore').textContent = data.subScores.ageAdjusted;

        // Recommendations
        const recommendationsHTML = data.recommendations.map(rec =>
            `<p style="margin-bottom: 0.75rem;"><strong>${rec.category}:</strong> ${rec.action} (${rec.frequency})</p>`
        ).join('');

        document.getElementById('neuroHealthRecommendations').innerHTML = recommendationsHTML;

        // Scroll to results
        document.getElementById('neuroHealthIndexResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    } catch (error) {
        console.error('Neuro Health Index calculation error:', error);
        alert('Calculation failed: ' + error.message);
    }
}

// 3. Neuro Risk Assessment Functions - REAL API INTEGRATION
async function calculateNeuroRisk() {
    const age = parseInt(document.getElementById('neuroRiskAge').value);
    const familyHistory = document.getElementById('neuroRiskFamilyHistory').value;
    const diabetes = document.getElementById('neuroRiskDiabetes').checked;
    const hypertension = document.getElementById('neuroRiskHypertension').checked;
    const smoking = document.getElementById('neuroRiskSmoking').checked;
    const obesity = document.getElementById('neuroRiskObesity').checked;
    const memoryComplaints = document.getElementById('neuroRiskMemory').checked;
    const depression = document.getElementById('neuroRiskDepression').checked;
    const apoe4Status = document.getElementById('neuroRiskAPOE4').value;

    if (!age) {
        alert('Please enter your age');
        return;
    }

    try {
        // REAL API CALL to /api/neuro/risk-assessment
        const response = await fetch('/api/neuro/risk-assessment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                age,
                gender: 'unknown',
                familyHistory,
                diabetes,
                hypertension,
                smoking,
                obesity,
                memoryComplaints,
                depression,
                apoe4Status
            })
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();

        // Display results
        document.getElementById('neuroRiskResults').style.display = 'block';
        document.getElementById('neuroRiskPercentage').textContent = data.tenYearRisk + '%';
        document.getElementById('neuroRiskLevel').textContent = data.riskLevel;
        document.getElementById('neuroRiskAlzheimer').textContent = data.diseaseSpecificRisks.alzheimer + '%';
        document.getElementById('neuroRiskStroke').textContent = data.diseaseSpecificRisks.stroke + '%';
        document.getElementById('neuroRiskParkinson').textContent = data.diseaseSpecificRisks.parkinson + '%';

        // Protective actions
        const actionsHTML = data.protectiveActions.map(action =>
            `<p style="margin-bottom: 0.75rem; padding-left: 1.5rem; text-indent: -1.5rem;">${action.icon} ${action.action} - ${action.impact}</p>`
        ).join('');
        document.getElementById('neuroRiskActions').innerHTML = actionsHTML;

        // References
        const referencesHTML = data.evidenceBased.references.map(ref =>
            `<p style="margin-bottom: 0.5rem;"> ${ref}</p>`
        ).join('');
        document.getElementById('neuroRiskReferences').innerHTML = referencesHTML;

        // Scroll to results
        document.getElementById('neuroRiskResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    } catch (error) {
        console.error('Neuro risk assessment error:', error);
        alert('Risk assessment failed: ' + error.message);
    }
}

// 4. Digital Neuro-Twin Functions - REAL API INTEGRATION
async function generateNeuroTwin() {
    const timeHorizon = parseInt(document.getElementById('neuroTwinTimeHorizon').value);

    const button = event.target;
    button.disabled = true;
    button.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px; animation: spin 1s linear infinite;">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
        </svg>
        Generating Digital Twin Model...
    `;

    try {
        // REAL API CALL to /api/neuro/digital-twin
        const response = await fetch('/api/neuro/digital-twin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                age: 65,
                gender: 'unknown',
                education: 16,
                lifestyle: {
                    exercise: true,
                    diet: true,
                    sleep: true,
                    social: true
                },
                medicalHistory: '',
                cognitiveScore: 28,
                genetics: {
                    apoe4: 'none'
                },
                timeHorizon
            })
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();

        // Generate anonymized patient ID
        document.getElementById('neuroTwinPatientID').value = data.digitalTwin.patientClusterId;

        // Display results
        document.getElementById('neuroTwinResults').style.display = 'block';
        document.getElementById('neuroTwinBrainAge').textContent = data.digitalTwin.brainAge + ' years';
        document.getElementById('neuroTwinCognitiveReserve').textContent = data.digitalTwin.cognitiveReserve;
        document.getElementById('neuroTwinConfidence').textContent = data.digitalTwin.modelConfidence;

        // Interventions
        const interventionsHTML = data.interventionOpportunities.map(intervention =>
            `<p style="margin-bottom: 0.75rem;">${intervention.icon} ${intervention.intervention} - ${intervention.potentialImpact}</p>`
        ).join('');
        document.getElementById('neuroTwinInterventions').innerHTML = interventionsHTML;

        // Update status indicators
        document.getElementById('neuroTwinFHIRStatus').textContent = 'Connected ';
        document.getElementById('neuroTwinFHIRStatus').style.color = '#10A37F';
        document.getElementById('neuroTwinMRIStatus').textContent = 'Analyzed ';
        document.getElementById('neuroTwinMRIStatus').style.color = '#10A37F';

        // Chart would be rendered here using Chart.js in production
        const canvas = document.getElementById('neuroTwinChart');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Brain Aging Trajectory Chart', canvas.width / 2, canvas.height / 2);
        ctx.font = '12px sans-serif';
        ctx.fillText(`(${data.trajectory.data.length} year prediction loaded)`, canvas.width / 2, canvas.height / 2 + 25);

        button.innerHTML = ' Digital Twin Generated';
        button.style.background = 'linear-gradient(135deg, #059669, #047857)';

        document.getElementById('neuroTwinResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    } catch (error) {
        console.error('Neuro-twin generation error:', error);
        alert('Failed to generate digital twin: ' + error.message);
        button.disabled = false;
        button.innerHTML = 'Generate Digital Neuro-Twin Model';
    }
}

// 5. Clinician Portal Functions - REAL API INTEGRATION
async function authenticateClinician() {
    const licenseNumber = document.getElementById('clinicianLicenseNumber').value;
    const specialty = document.getElementById('clinicianSpecialty').value;

    if (!licenseNumber || !specialty) {
        alert('Please enter your medical license number and specialty');
        return;
    }

    const button = event.target;
    button.disabled = true;
    button.innerHTML = ' Authenticating...';

    try {
        // REAL API CALL to /api/neuro/clinician-portal
        const response = await fetch('/api/neuro/clinician-portal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                licenseNumber,
                specialty
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `API Error: ${response.status}`);
        }

        const data = await response.json();

        // Show dashboard
        document.getElementById('clinicianDashboard').style.display = 'block';

        // Update clinician info (if available in UI)
        console.log('Clinician authenticated:', data.clinician);

        button.innerHTML = ' Authenticated';
        button.style.background = 'linear-gradient(135deg, #059669, #047857)';

        // Scroll to dashboard
        setTimeout(() => {
            document.getElementById('clinicianDashboard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 500);

    } catch (error) {
        console.error('Authentication error:', error);
        alert('Authentication failed: ' + error.message);
        button.disabled = false;
        button.innerHTML = 'Authenticate & Access Validation Queue';
    }
}

async function validateAssessment(assessmentId, action) {
    const confirmMsg = {
        'approve': 'Are you sure you want to approve this assessment?',
        'revise': 'Request revision for this assessment?',
        'reject': 'Are you sure you want to reject this assessment?'
    };

    if (!confirm(confirmMsg[action])) return;

    try {
        // REAL API CALL to /api/neuro/clinician-portal/validate
        const response = await fetch('/api/neuro/clinician-portal/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                assessmentId,
                action,
                feedback: ''
            })
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();

        alert(data.message);

        // In production: Remove card from queue and update stats

    } catch (error) {
        console.error('Validation error:', error);
        alert('Validation failed: ' + error.message);
    }
}

// ============================================================
// EMERGENCY AI TRIAGE - REAL API INTEGRATION
// ============================================================

async function analyzeEmergencyTriage() {
    const chiefComplaint = document.getElementById('chiefComplaint').value.trim();
    const arrivalMode = document.getElementById('arrivalMode').value;
    const age = document.getElementById('patientAge').value;
    const gender = document.getElementById('patientGender').value;
    const painLevel = parseInt(document.getElementById('painLevel').value);
    const resourcesNeeded = parseInt(document.getElementById('resourcesNeeded').value);

    // Vital Signs
    const heartRate = parseInt(document.getElementById('heartRate').value);
    const systolic = parseInt(document.getElementById('systolicBP').value);
    const diastolic = parseInt(document.getElementById('diastolicBP').value);
    const respiratoryRate = parseInt(document.getElementById('respiratoryRate').value);
    const oxygenSaturation = parseInt(document.getElementById('oxygenSaturation').value);
    const temperature = parseFloat(document.getElementById('temperature').value);
    const glasgowComaScale = document.getElementById('glasgowComaScale').value ? parseInt(document.getElementById('glasgowComaScale').value) : null;

    if (!chiefComplaint || !heartRate || !systolic || !diastolic || !respiratoryRate || !oxygenSaturation || !temperature) {
        alert('Please fill in all required fields (chief complaint and vital signs).');
        return;
    }

    // Show loading
    document.getElementById('triageLoading').style.display = 'block';
    document.getElementById('triageResults').style.display = 'none';

    try {
        // REAL API CALL to /api/medical/emergency-triage
        const response = await fetch('/api/medical/emergency-triage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chiefComplaint,
                vitals: {
                    heartRate,
                    bloodPressure: { systolic, diastolic },
                    respiratoryRate,
                    oxygenSaturation,
                    temperature,
                    glasgowComaScale
                },
                painLevel,
                arrivalMode,
                age,
                gender,
                resourcesNeeded
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `API Error: ${response.status}`);
        }

        const data = await response.json();

        // Hide loading, show results
        document.getElementById('triageLoading').style.display = 'none';
        document.getElementById('triageResults').style.display = 'block';

        // Display ESI Level
        const esiLevelHTML = `
            <div style="background: ${data.triage.color}; color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Level ${data.triage.esiLevel}</div>
                <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">${data.triage.classification}</div>
                <div style="font-size: 0.875rem; opacity: 0.95;">${data.triage.description}</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid #3B82F6;">
                    <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">PRIORITY</div>
                    <div style="font-size: 1.125rem; font-weight: 600; color: #1F2937;">${data.triage.priority}</div>
                </div>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid #10B981;">
                    <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">MAX WAIT TIME</div>
                    <div style="font-size: 1.125rem; font-weight: 600; color: #1F2937;">${data.triage.maxWaitTime}</div>
                </div>
            </div>
        `;
        document.getElementById('esiLevel').innerHTML = esiLevelHTML;

        // Display Vital Signs Status
        const vitalSignsHTML = `
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: ${data.vitalSigns.status === 'STABLE' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 8px; border-left: 3px solid ${data.vitalSigns.status === 'STABLE' ? '#10B981' : '#EF4444'};">
                <div style="font-size: 1.5rem;">${data.vitalSigns.status === 'STABLE' ? '' : ''}</div>
                <div>
                    <div style="font-weight: 600; color: #1F2937;">${data.vitalSigns.status}</div>
                    <div style="font-size: 0.875rem; color: #6B7280;">${data.vitalSigns.criticalCount} critical alert(s)</div>
                </div>
            </div>
            ${data.vitalSigns.alerts.length > 0 ? `
                <div style="margin-top: 1rem;">
                    <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Vital Alerts:</h4>
                    ${data.vitalSigns.alerts.map(alert => `
                        <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: ${alert.status === 'CRITICAL' ? 'rgba(220, 38, 38, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: 8px; border-left: 3px solid ${alert.status === 'CRITICAL' ? '#DC2626' : '#F59E0B'};">
                            <div style="font-weight: 600; color: #1F2937; font-size: 0.875rem;">${alert.vital}: ${alert.value}</div>
                            <div style="font-size: 0.75rem; color: #6B7280;">Normal: ${alert.normal}  Status: ${alert.status}</div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p style="color: #6B7280; font-size: 0.875rem;">All vital signs within normal limits.</p>'}
        `;
        document.getElementById('vitalSignsStatus').innerHTML = vitalSignsHTML;

        // Display Care Recommendations
        const careHTML = data.careRecommendations.length > 0 ? data.careRecommendations.map(rec => `
            <div style="padding: 1rem; margin-bottom: 0.75rem; background: ${rec.priority === 'IMMEDIATE' ? 'rgba(220, 38, 38, 0.1)' : 'rgba(59, 130, 246, 0.1)'}; border-radius: 8px; border-left: 3px solid ${rec.priority === 'IMMEDIATE' ? '#DC2626' : '#3B82F6'};">
                <div style="font-weight: 600; color: #1F2937; margin-bottom: 0.25rem; font-size: 0.875rem;">[${rec.priority}] ${rec.action}</div>
                <div style="font-size: 0.75rem; color: #6B7280;">${rec.rationale}</div>
            </div>
        `).join('') : '<p style="color: #6B7280; font-size: 0.875rem;">Continue standard monitoring and care.</p>';
        document.getElementById('careRecommendations').innerHTML = careHTML;

        // Display Disposition
        const dispositionHTML = `
            <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; color: #1E40AF; margin-bottom: 0.5rem;">Suggested Area:</div>
                <div style="color: #374151;">${data.disposition.suggestedArea}</div>
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; color: #1E40AF; margin-bottom: 0.5rem;">Anticipated Resources:</div>
                <div style="color: #374151;">${data.disposition.anticipatedResources.join(', ')}</div>
            </div>
            <div>
                <div style="font-weight: 600; color: #1E40AF; margin-bottom: 0.5rem;">Estimated Length of Stay:</div>
                <div style="color: #374151;">${data.disposition.estimatedLOS}</div>
            </div>
        `;
        document.getElementById('disposition').innerHTML = dispositionHTML;

        // Scroll to results
        setTimeout(() => {
            document.getElementById('triageResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);

    } catch (error) {
        console.error('Emergency triage error:', error);
        document.getElementById('triageLoading').style.display = 'none';
        alert('Emergency triage analysis failed: ' + error.message);
    }
}

// ============================================================
// SEPSIS EARLY WARNING SYSTEM - REAL API INTEGRATION
// ============================================================

async function analyzeSepsisRisk() {
    // Show loading
    document.getElementById('sepsisLoading').style.display = 'block';
    document.getElementById('sepsisResults').style.display = 'none';

    try {
        // REAL API CALL to /api/medical/sepsis-early-warning
        const response = await fetch('/api/medical/sepsis-early-warning', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                vitals: {
                    heartRate: parseInt(document.getElementById('sepsisHeartRate').value),
                    respiratoryRate: parseInt(document.getElementById('sepsisRespiratoryRate').value),
                    temperature: parseFloat(document.getElementById('sepsisTemperature').value),
                    bloodPressure: {
                        systolic: parseInt(document.getElementById('sepsisSystolicBP').value)
                    },
                    glasgowComaScale: document.getElementById('sepsisGCS').value ? parseInt(document.getElementById('sepsisGCS').value) : null,
                    meanArterialPressure: document.getElementById('sepsisMAP').value ? parseInt(document.getElementById('sepsisMAP').value) : null
                },
                labs: {
                    wbc: document.getElementById('sepsisWBC').value ? parseFloat(document.getElementById('sepsisWBC').value) : null,
                    lactate: document.getElementById('sepsisLactate').value ? parseFloat(document.getElementById('sepsisLactate').value) : null,
                    creatinine: document.getElementById('sepsisCreatinine').value ? parseFloat(document.getElementById('sepsisCreatinine').value) : null,
                    platelets: document.getElementById('sepsisPLT').value ? parseInt(document.getElementById('sepsisPLT').value) : null,
                    bilirubin: document.getElementById('sepsisBilirubin').value ? parseFloat(document.getElementById('sepsisBilirubin').value) : null
                },
                clinicalContext: {
                    vasopressors: document.getElementById('sepsisVasopressors').checked,
                    suspectedInfection: document.getElementById('sepsisSuspectedInfection').checked,
                    immunocompromised: document.getElementById('sepsisImmunocompromised').checked
                },
                age: document.getElementById('sepsisAge').value ? parseInt(document.getElementById('sepsisAge').value) : null,
                gender: document.getElementById('sepsisGender').value
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `API Error: ${response.status}`);
        }

        const data = await response.json();

        // Hide loading, show results
        document.getElementById('sepsisLoading').style.display = 'none';
        document.getElementById('sepsisResults').style.display = 'block';

        // Display Risk Level
        const riskColor = data.sepsisRisk.level === 'HIGH' ? '#DC2626' : data.sepsisRisk.level === 'MODERATE-HIGH' ? '#F59E0B' : data.sepsisRisk.level === 'MODERATE' ? '#10B981' : '#3B82F6';
        const riskHTML = `
            <div style="background: ${riskColor}; color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${data.sepsisRisk.level} RISK</div>
                <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">${data.sepsisRisk.likelihood}</div>
                <div style="font-size: 0.875rem; opacity: 0.95;">Urgency: ${data.sepsisRisk.urgency}</div>
            </div>
            <div style="background: rgba(220, 38, 38, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid #DC2626;">
                <div style="font-weight: 600; color: #991B1B; margin-bottom: 0.25rem;">Predicted Mortality Risk</div>
                <div style="color: #374151;">${data.sepsisRisk.mortalityRisk}</div>
            </div>
        `;
        document.getElementById('sepsisRiskLevel').innerHTML = riskHTML;

        // Display Scores
        const scoresHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: ${data.scores.qsofa.score >= 2 ? 'rgba(220, 38, 38, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; padding: 1rem; border-radius: 8px; border-left: 3px solid ${data.scores.qsofa.score >= 2 ? '#DC2626' : '#10B981'};">
                    <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">qSOFA</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1F2937;">${data.scores.qsofa.score}/${data.scores.qsofa.maxScore}</div>
                    <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">${data.scores.qsofa.interpretation}</div>
                </div>
                <div style="background: ${data.scores.sirs.score >= 2 ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; padding: 1rem; border-radius: 8px; border-left: 3px solid ${data.scores.sirs.score >= 2 ? '#F59E0B' : '#10B981'};">
                    <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">SIRS</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1F2937;">${data.scores.sirs.score}/${data.scores.sirs.maxScore}</div>
                    <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">${data.scores.sirs.interpretation}</div>
                </div>
                <div style="background: ${data.scores.sofa.score >= 2 ? 'rgba(220, 38, 38, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; padding: 1rem; border-radius: 8px; border-left: 3px solid ${data.scores.sofa.score >= 2 ? '#DC2626' : '#10B981'};">
                    <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">SOFA</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1F2937;">${data.scores.sofa.score}/${data.scores.sofa.maxScore}</div>
                    <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">${data.scores.sofa.interpretation}</div>
                </div>
            </div>
            ${data.scores.qsofa.alerts.length > 0 ? `
                <div style="margin-top: 1rem;">
                    <h5 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">qSOFA Criteria Met:</h5>
                    ${data.scores.qsofa.alerts.map(alert => `
                        <div style="padding: 0.5rem; margin-bottom: 0.25rem; background: rgba(220, 38, 38, 0.05); border-radius: 6px; font-size: 0.875rem; color: #374151;">
                             ${alert.criterion}: ${alert.value} (${alert.threshold})
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            ${data.scores.sofa.organDysfunction.length > 0 ? `
                <div style="margin-top: 1rem;">
                    <h5 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Organ Dysfunction (SOFA):</h5>
                    ${data.scores.sofa.organDysfunction.map(org => `
                        <div style="padding: 0.5rem; margin-bottom: 0.25rem; background: rgba(245, 158, 11, 0.05); border-radius: 6px; font-size: 0.875rem; color: #374151;">
                            ${org.system}: ${org.severity} (Score: ${org.score}) - ${org.value}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        `;
        document.getElementById('sepsisScores').innerHTML = scoresHTML;

        // Display Recommendations
        const recsHTML = data.recommendations.length > 0 ? data.recommendations.map(rec => `
            <div style="padding: 1rem; margin-bottom: 0.75rem; background: ${rec.priority === 'IMMEDIATE' ? 'rgba(220, 38, 38, 0.1)' : 'rgba(59, 130, 246, 0.1)'}; border-radius: 8px; border-left: 3px solid ${rec.priority === 'IMMEDIATE' ? '#DC2626' : '#3B82F6'};">
                <div style="font-weight: 600; color: #1F2937; margin-bottom: 0.25rem; font-size: 0.875rem;">[${rec.priority}] ${rec.action}</div>
                <div style="font-size: 0.75rem; color: #6B7280;">${rec.rationale}</div>
            </div>
        `).join('') : '<p style="color: #6B7280; font-size: 0.875rem;">Continue standard monitoring.</p>';
        document.getElementById('sepsisRecommendations').innerHTML = recsHTML;

        // Display Bundles
        const bundlesHTML = `
            <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; color: #991B1B; margin-bottom: 0.5rem;">Hour-1 Bundle:</div>
                <ul style="margin: 0; padding-left: 1.25rem; color: #374151; font-size: 0.875rem;">
                    ${data.bundles.hour1.map(item => `<li style="margin-bottom: 0.25rem;">${item}</li>`).join('')}
                </ul>
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; color: #991B1B; margin-bottom: 0.5rem;">Hour-3 Bundle:</div>
                <ul style="margin: 0; padding-left: 1.25rem; color: #374151; font-size: 0.875rem;">
                    ${data.bundles.hour3.map(item => `<li style="margin-bottom: 0.25rem;">${item}</li>`).join('')}
                </ul>
            </div>
            <div>
                <div style="font-weight: 600; color: #991B1B; margin-bottom: 0.5rem;">Hour-6 Bundle:</div>
                <ul style="margin: 0; padding-left: 1.25rem; color: #374151; font-size: 0.875rem;">
                    ${data.bundles.hour6.map(item => `<li style="margin-bottom: 0.25rem;">${item}</li>`).join('')}
                </ul>
            </div>
        `;
        document.getElementById('sepsisBundles').innerHTML = bundlesHTML;

        // Scroll to results
        setTimeout(() => {
            document.getElementById('sepsisResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);

    } catch (error) {
        console.error('Sepsis early warning error:', error);
        document.getElementById('sepsisLoading').style.display = 'none';
        alert('Sepsis risk analysis failed: ' + error.message);
    }
}

// ============================================================
// MULTIMODAL DATA FUSION PLATFORM - REAL API INTEGRATION
// ============================================================

async function analyzeMultimodalData() {
    document.getElementById('multimodalLoading').style.display = 'block';
    document.getElementById('multimodalResults').style.display = 'none';

    try {
        const requestData = {};

        // DICOM Data
        const dicomModality = document.getElementById('dicomModality').value;
        if (dicomModality) {
            requestData.dicomData = {
                modality: dicomModality,
                bodyPart: document.getElementById('dicomBodyPart').value || 'CHEST',
                abnormalityDetected: document.getElementById('dicomAbnormality').checked,
                contrastUsed: document.getElementById('dicomContrast').checked
            };
        }

        // FHIR Data
        const fhirObservations = [];
        const systolicBP = document.getElementById('fhirSystolicBP').value;
        const diastolicBP = document.getElementById('fhirDiastolicBP').value;
        if (systolicBP && diastolicBP) {
            fhirObservations.push({
                code: 'BLOOD_PRESSURE',
                systolic: parseInt(systolicBP),
                diastolic: parseInt(diastolicBP),
                unit: 'mmHg',
                status: 'final'
            });
        }

        const glucose = document.getElementById('fhirGlucose').value;
        if (glucose) {
            fhirObservations.push({
                code: 'GLUCOSE',
                value: parseFloat(glucose),
                unit: 'mg/dL',
                status: 'final'
            });
        }

        const cholesterol = document.getElementById('fhirCholesterol').value;
        if (cholesterol) {
            fhirObservations.push({
                code: 'CHOLESTEROL',
                value: parseFloat(cholesterol),
                unit: 'mg/dL',
                status: 'final'
            });
        }

        const fhirConditions = [];
        if (document.getElementById('fhirDiabetes').checked) {
            fhirConditions.push({ code: 'DIABETES_MELLITUS', severity: 'MODERATE', clinicalStatus: 'active' });
        }
        if (document.getElementById('fhirHypertension').checked) {
            fhirConditions.push({ code: 'HYPERTENSION', severity: 'MODERATE', clinicalStatus: 'active' });
        }

        if (fhirObservations.length > 0 || fhirConditions.length > 0) {
            requestData.fhirData = {
                patientId: 'ANONYMOUS',
                resourceType: 'Bundle',
                observations: fhirObservations,
                conditions: fhirConditions
            };
        }

        // Genomic Data
        const genomicVariants = [];
        const brca1 = document.getElementById('genomicBRCA1').value;
        if (brca1) {
            genomicVariants.push({
                gene: 'BRCA1',
                variant: brca1,
                zygosity: 'HETEROZYGOUS',
                pathogenicity: brca1 === 'PATHOGENIC' ? 'PATHOGENIC' : 'BENIGN'
            });
        }

        const apoe = document.getElementById('genomicAPOE').value;
        if (apoe) {
            genomicVariants.push({
                gene: 'APOE',
                variant: apoe,
                zygosity: apoe === 'E4/E4' ? 'HOMOZYGOUS' : 'HETEROZYGOUS'
            });
        }

        const cyp2d6 = document.getElementById('genomicCYP2D6').value;
        if (cyp2d6) {
            genomicVariants.push({
                gene: 'CYP2D6',
                variant: cyp2d6,
                zygosity: 'HETEROZYGOUS'
            });
        }

        if (genomicVariants.length > 0) {
            requestData.genomicData = {
                patientId: 'ANONYMOUS',
                variants: genomicVariants
            };
        }

        // Validate at least one modality
        if (!requestData.dicomData && !requestData.fhirData && !requestData.genomicData) {
            alert('Please provide at least one data modality (DICOM, FHIR, or Genomic)');
            document.getElementById('multimodalLoading').style.display = 'none';
            return;
        }

        const response = await fetch('/api/medical/multimodal-data-fusion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();
        document.getElementById('multimodalLoading').style.display = 'none';

        if (!data.success) {
            alert('Multimodal analysis failed: ' + data.error);
            return;
        }

        // Display results
        document.getElementById('multimodalResults').style.display = 'block';

        // DICOM Results
        if (data.multimodalAnalysis.dicom) {
            const dicomHTML = `
                <div style="background: #F0FDF4; padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #065F46;"> DICOM Imaging Analysis</h4>
                    <p><strong>Modality:</strong> ${data.multimodalAnalysis.dicom.modality}</p>
                    <p><strong>Body Part:</strong> ${data.multimodalAnalysis.dicom.bodyPart}</p>
                    <p><strong>Quality:</strong> ${data.multimodalAnalysis.dicom.quality}</p>
                    ${data.multimodalAnalysis.dicom.findings.map(f => `
                        <div style="background: white; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                            <strong>${f.finding}</strong><br>
                            Location: ${f.location} | Severity: ${f.severity} | Confidence: ${(f.confidence * 100).toFixed(0)}%
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('dicomAnalysis').innerHTML = dicomHTML;
        }

        // FHIR Results
        if (data.multimodalAnalysis.fhir) {
            const fhirHTML = `
                <div style="background: #EFF6FF; padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1E40AF;"> FHIR Clinical Data Analysis</h4>
                    ${data.multimodalAnalysis.fhir.riskFactors.length > 0 ? `
                        <div style="background: #FEF2F2; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                            <strong style="color: #991B1B;"> Risk Factors Detected:</strong>
                            ${data.multimodalAnalysis.fhir.riskFactors.map(r => `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                                    <strong>${r.factor}</strong> (${r.severity})<br>
                                    Value: ${r.value} | Guideline: ${r.guideline}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>No significant risk factors detected.</p>'}
                </div>
            `;
            document.getElementById('fhirAnalysis').innerHTML = fhirHTML;
        }

        // Genomic Results
        if (data.multimodalAnalysis.genomic) {
            const genomicHTML = `
                <div style="background: #F5F3FF; padding: 1rem; border-radius: 8px; border-left: 4px solid #8B5CF6;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #5B21B6;"> Genomic Analysis</h4>
                    ${data.multimodalAnalysis.genomic.diseaseRiskPredictions.length > 0 ? `
                        <div style="background: #FEF2F2; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                            <strong style="color: #991B1B;">Disease Risk Predictions:</strong>
                            ${data.multimodalAnalysis.genomic.diseaseRiskPredictions.map(p => `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                                    <strong>${p.disease}</strong> (${p.riskLevel})<br>
                                    Lifetime Risk: ${p.lifetimeRisk}<br>
                                    Recommendation: ${p.recommendation}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${data.multimodalAnalysis.genomic.pharmacogenomics.length > 0 ? `
                        <div style="background: #FEF9C3; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                            <strong style="color: #854D0E;"> Pharmacogenomics Insights:</strong>
                            ${data.multimodalAnalysis.genomic.pharmacogenomics.map(p => `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                                    <strong>${p.gene}</strong> (${p.phenotype})<br>
                                    Affected Drugs: ${p.affectedDrugs.join(', ')}<br>
                                    Recommendation: ${p.recommendation}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('genomicAnalysis').innerHTML = genomicHTML;
        }

        // Fused Insights
        const fusedHTML = `
            <div style="background: linear-gradient(135deg, #FECACA, #FED7AA); padding: 1.25rem; border-radius: 10px; border: 2px solid #DC2626;">
                <h3 style="margin: 0 0 1rem 0; color: #7C2D12;"> AI-Powered Multimodal Insights</h3>
                ${data.multimodalAnalysis.fusedInsights.comprehensiveRiskProfile.length > 0 ? `
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong style="color: #991B1B;">Comprehensive Risk Profile:</strong>
                        ${data.multimodalAnalysis.fusedInsights.comprehensiveRiskProfile.map(r => `
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: #FEF2F2; border-radius: 6px; border-left: 3px solid #DC2626;">
                                <strong>${r.riskType}</strong> (${r.severity})<br>
                                Priority: ${r.actionPriority}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                ${data.multimodalAnalysis.fusedInsights.personalizedTreatmentRecommendations.length > 0 ? `
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong style="color: #065F46;">Personalized Treatment Recommendations:</strong>
                        ${data.multimodalAnalysis.fusedInsights.personalizedTreatmentRecommendations.map(r => `
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: #F0FDF4; border-radius: 6px;">
                                ${r.recommendation}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                <div style="background: white; padding: 1rem; border-radius: 8px;">
                    <strong style="color: #1E40AF;">Clinical Impact:</strong><br>
                    ${data.clinicalImpact.description}<br><br>
                    <strong>Accuracy:</strong> ${data.clinicalImpact.accuracy}<br>
                    <strong>Cost Reduction:</strong> ${data.clinicalImpact.costReduction}
                </div>
            </div>
        `;
        document.getElementById('fusedInsights').innerHTML = fusedHTML;

        setTimeout(() => {
            document.getElementById('multimodalResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);

    } catch (error) {
        console.error('Multimodal data fusion error:', error);
        document.getElementById('multimodalLoading').style.display = 'none';
        alert('Multimodal analysis failed: ' + error.message);
    }
}

// ============================================================
// RARE DISEASE DIAGNOSTIC ASSISTANT - REAL API INTEGRATION
// ============================================================

async function analyzeRareDisease() {
    const symptomsInput = document.getElementById('rareDiseaseSymptoms').value.trim();
    const age = document.getElementById('rareDiseaseAge').value;
    const gender = document.getElementById('rareDiseaseGender').value;
    const familyHistory = document.getElementById('rareDiseaseFamilyHistory').value.trim();

    if (!symptomsInput) {
        return alert('Please enter at least one symptom');
    }

    // Parse symptoms (comma-separated)
    const symptoms = symptomsInput.split(',').map(s => s.trim()).filter(s => s);

    // Lab results
    const labResults = {
        elevatedCK: document.getElementById('labElevatedCK').checked,
        lowCeruloplasmin: document.getElementById('labLowCeruloplasmin').checked,
        elevatedIGF1: document.getElementById('labElevatedIGF1').checked
    };

    const button = event.target;
    button.disabled = true;
    button.innerHTML = ' Analyzing...';

    try {
        // REAL API CALL to /api/medical/rare-disease-assistant
        const response = await fetch('/api/medical/rare-disease-assistant', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symptoms,
                age: parseInt(age) || null,
                gender,
                familyHistory,
                labResults,
                imagingFindings: '',
                previousDiagnoses: []
            })
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();

        // Display differential diagnoses
        const diagnosesHTML = data.differentialDiagnoses.map((diagnosis, index) => `
            <div style="background: ${index === 0 ? '#FEF3C7' : '#F9FAFB'}; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid ${index === 0 ? '#F59E0B' : '#D1D5DB'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h4 style="font-size: 0.9375rem; font-weight: 700; color: #111827; margin: 0;">${index + 1}. ${diagnosis.disease}</h4>
                    <div style="background: ${diagnosis.confidence >= 70 ? '#10B981' : diagnosis.confidence >= 50 ? '#F59E0B' : '#6B7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                        ${diagnosis.confidence}% confidence
                    </div>
                </div>
                <p style="font-size: 0.8125rem; color: #6B7280; margin: 0.5rem 0;"><strong>Prevalence:</strong> ${diagnosis.prevalence}</p>
                <p style="font-size: 0.8125rem; color: #6B7280; margin: 0.5rem 0;"><strong>Matched Symptoms:</strong> ${diagnosis.matchedSymptoms.join(', ')}</p>
                <p style="font-size: 0.8125rem; color: #6B7280; margin: 0.5rem 0;"><strong>Genetics:</strong> ${diagnosis.genetics}</p>
                <p style="font-size: 0.8125rem; color: #6B7280; margin: 0.5rem 0;"><strong>Diagnostic Criteria:</strong> ${diagnosis.diagnosticCriteria}</p>
                <p style="font-size: 0.8125rem; color: #374151; margin: 0.5rem 0; font-weight: 600;"><strong>Referral:</strong> ${diagnosis.specialistReferral}</p>
            </div>
        `).join('');
        document.getElementById('differentialDiagnoses').innerHTML = diagnosesHTML || '<p style="color: #6B7280;">No strong matches found.</p>';

        // Display clinical reasoning
        const reasoningHTML = `
            <div style="background: #F0F9FF; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #3B82F6;">
                <h4 style="font-size: 0.875rem; font-weight: 700; color: #1E40AF; margin-bottom: 0.5rem;">Summary</h4>
                <p style="font-size: 0.875rem; color: #1E3A8A; line-height: 1.6;">${data.clinicalReasoning.summary}</p>
            </div>
            <div>
                <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Clinical Reasoning:</h4>
                ${data.clinicalReasoning.reasoning.map(r => `<p style="font-size: 0.8125rem; color: #6B7280; margin: 0.5rem 0;"> ${r}</p>`).join('')}
            </div>
        `;
        document.getElementById('clinicalReasoning').innerHTML = reasoningHTML;

        // Display next steps
        const stepsHTML = data.clinicalReasoning.nextSteps
            ? `<ul style="margin: 0.5rem 0; padding-left: 1.25rem;">${data.clinicalReasoning.nextSteps.map(step => `<li style="font-size: 0.875rem; color: #1E40AF; margin: 0.5rem 0;">${step}</li>`).join('')}</ul>`
            : '<p style="font-size: 0.875rem; color: #6B7280;">Complete standard workup first.</p>';
        document.getElementById('nextSteps').innerHTML = stepsHTML;

        // Show results section
        document.getElementById('rareDiseaseResults').style.display = 'block';
        document.getElementById('rareDiseaseResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        button.innerHTML = ' Analysis Complete';
        button.style.background = 'linear-gradient(135deg, #059669, #047857)';

    } catch (error) {
        console.error('Rare disease analysis error:', error);
        alert('Analysis failed: ' + error.message);
        button.disabled = false;
        button.innerHTML = ' Start Differential Diagnosis Analysis';
    }
}

// Add CSS animation for spinning loader
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
    </script>

    <!-- ============================================ -->
    <!-- NEURO HEALTH AI MODALS -->
    <!-- ============================================ -->

    <!-- 1. Brain Imaging Analysis Modal -->
    <div class="modal" id="neuroImagingModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
                        <path d="M12 15v7"/>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M8 12h8"/>
                    </svg>
                    Brain Imaging Analysis (LyDian AI Vision + DICOM)
                </div>
                <button class="modal-close" onclick="closePanel('neuroImagingModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="file" id="neuroImagingFileInput" accept=".dcm,.dicom,.nii,.nii.gz,image/*" style="display: none;" onchange="uploadNeuroImaging(event)">
                <div onclick="document.getElementById('neuroImagingFileInput').click()" style="padding: 3rem; border: 2px dashed #10A37F; border-radius: 12px; text-align: center; cursor: pointer; margin-bottom: 1rem; background: linear-gradient(135deg, rgba(16, 163, 127, 0.05), rgba(255, 107, 74, 0.05));">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 1rem; color: #10A37F;">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Upload Brain Scan (MRI/CT/EEG)</div>
                    <div style="font-size: 0.875rem; color: #6B7280;">Supported: DICOM (.dcm), NIfTI (.nii), PNG, JPEG</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500; font-size: 0.875rem;">Imaging Modality</label>
                        <select id="neuroImagingModality" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            <option value="mri">MRI (Magnetic Resonance)</option>
                            <option value="ct">CT (Computed Tomography)</option>
                            <option value="eeg">EEG (Electroencephalography)</option>
                            <option value="pet">PET (Positron Emission)</option>
                            <option value="fmri">fMRI (Functional MRI)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500; font-size: 0.875rem;">Analysis Type</label>
                        <select id="neuroImagingAnalysisType" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            <option value="structural">Structural Analysis</option>
                            <option value="volumetric">Volumetric Measurement</option>
                            <option value="lesion">Lesion Detection</option>
                            <option value="functional">Functional Connectivity</option>
                            <option value="atrophy">Atrophy Assessment</option>
                        </select>
                    </div>
                </div>

                <button onclick="analyzeNeuroImaging()" style="width: 100%; padding: 1rem 1.5rem; background: linear-gradient(135deg, #10A37F, #0D8A6A); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-bottom: 1.5rem; transition: transform 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                    Analyze with LyDian AI Vision
                </button>

                <div id="neuroImagingResults" style="display: none;">
                    <div style="background: linear-gradient(135deg, #F0FDF4, #ECFDF5); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #10A37F; margin-bottom: 1rem;">
                        <h3 style="font-size: 1rem; font-weight: 700; color: #065F46; margin-bottom: 1rem; display: flex; align-items: center;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            AI Analysis Results
                        </h3>
                        <div id="neuroImagingAnalysis" style="color: #047857; line-height: 1.6;"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">Confidence</div>
                            <div id="neuroImagingConfidence" style="font-size: 1.75rem; font-weight: 700; color: #10A37F;">--</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">Brain Volume</div>
                            <div id="neuroImagingVolume" style="font-size: 1.75rem; font-weight: 700; color: #FF6B4A;">--</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">Findings</div>
                            <div id="neuroImagingFindings" style="font-size: 1.75rem; font-weight: 700; color: #3B82F6;">--</div>
                        </div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #374151; margin-bottom: 1rem; text-transform: uppercase;">Evidence-Based Citations</h4>
                        <div id="neuroImagingCitations" style="font-size: 0.875rem; color: #6B7280; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Neuro Health Index Modal -->
    <div class="modal" id="neuroHealthIndexModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                        <path d="M8 12h8"/>
                    </svg>
                    Neuro Health Index (0-100 Score)
                </div>
                <button class="modal-close" onclick="closePanel('neuroHealthIndexModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #F9FAFB, #F3F4F6); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Patient Information</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Age</label>
                            <input type="number" id="neuroHealthAge" placeholder="e.g., 45" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Gender</label>
                            <select id="neuroHealthGender" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Cognitive Assessment (MoCA/MMSE Score)</label>
                        <input type="number" id="neuroHealthCognitive" placeholder="0-30" min="0" max="30" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Medical History (comma-separated)</label>
                        <input type="text" id="neuroHealthHistory" placeholder="e.g., hypertension, diabetes, stroke" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Lifestyle Factors</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="neuroHealthExercise" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #10A37F;">
                                <span style="font-size: 0.875rem; color: #374151;">Regular Exercise</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="neuroHealthSleep" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #10A37F;">
                                <span style="font-size: 0.875rem; color: #374151;">Good Sleep (7-9h)</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="neuroHealthDiet" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #10A37F;">
                                <span style="font-size: 0.875rem; color: #374151;">Mediterranean Diet</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="neuroHealthSocial" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #10A37F;">
                                <span style="font-size: 0.875rem; color: #374151;">Active Social Life</span>
                            </label>
                        </div>
                    </div>
                </div>

                <button onclick="calculateNeuroHealthIndex()" style="width: 100%; padding: 1rem 1.5rem; background: linear-gradient(135deg, #10A37F, #0D8A6A); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-bottom: 1.5rem;">
                    Calculate Neuro Health Index
                </button>

                <div id="neuroHealthIndexResults" style="display: none;">
                    <div style="background: linear-gradient(135deg, #1F2937, #374151); padding: 2rem; border-radius: 16px; text-align: center; margin-bottom: 1.5rem; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,%3Csvg width=\"40\" height=\"40\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cpath d=\"M0 0h40v40H0z\" fill=\"none\"/%3E%3Cpath d=\"M20 0v40M0 20h40\" stroke=\"rgba(255,255,255,0.05)\" stroke-width=\"1\"/%3E%3C/svg%3E'); opacity: 0.3;"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 0.875rem; color: rgba(255,255,255,0.7); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Your Neuro Health Index</div>
                            <div id="neuroHealthIndexScore" style="font-size: 4rem; font-weight: 800; color: white; line-height: 1; margin-bottom: 0.5rem;">--</div>
                            <div id="neuroHealthIndexCategory" style="font-size: 1.25rem; font-weight: 600; color: #10A37F; text-transform: uppercase; letter-spacing: 1px;"></div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;">Cognitive</div>
                            <div id="neuroHealthCognitiveScore" style="font-size: 1.5rem; font-weight: 700; color: #3B82F6;">--</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;">Lifestyle</div>
                            <div id="neuroHealthLifestyleScore" style="font-size: 1.5rem; font-weight: 700; color: #10A37F;">--</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;">Risk Factors</div>
                            <div id="neuroHealthRiskScore" style="font-size: 1.5rem; font-weight: 700; color: #FF6B4A;">--</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;">Age-Adjusted</div>
                            <div id="neuroHealthAgeScore" style="font-size: 1.5rem; font-weight: 700; color: #8B5CF6;">--</div>
                        </div>
                    </div>

                    <div style="background: #FEF3C7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #F59E0B; margin-bottom: 1rem;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #92400E; margin-bottom: 0.75rem; display: flex; align-items: center;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <path d="M12 9v4M12 17h.01"/>
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                            Personalized Recommendations
                        </h4>
                        <div id="neuroHealthRecommendations" style="color: #78350F; font-size: 0.875rem; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Neuro Risk Assessment Modal -->
    <div class="modal" id="neuroRiskModal">
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 9v4"/>
                        <path d="M12 17h.01"/>
                        <path d="M10 2 L14 2 L21 12 L12 22 L3 12 Z"/>
                    </svg>
                    Neurological Risk Assessment
                </div>
                <button class="modal-close" onclick="closePanel('neuroRiskModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #FEF2F2, #FEE2E2); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #EF4444; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: start;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 1rem; color: #DC2626; flex-shrink: 0;">
                            <path d="M12 9v4M12 17h.01"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 700; color: #991B1B; margin-bottom: 0.5rem;">Medical Disclaimer</h4>
                            <p style="font-size: 0.875rem; color: #7F1D1D; line-height: 1.5;">This tool provides risk assessment based on evidence-based algorithms. It is NOT a diagnosis. Always consult healthcare professionals for medical decisions.</p>
                        </div>
                    </div>
                </div>

                <div style="background: #F9FAFB; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Risk Factors Assessment</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Age</label>
                            <input type="number" id="neuroRiskAge" placeholder="e.g., 65" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Family History</label>
                            <select id="neuroRiskFamilyHistory" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                <option value="none">No family history</option>
                                <option value="one">1 first-degree relative</option>
                                <option value="multiple">2+ first-degree relatives</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.75rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Select all that apply:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #E5E7EB;">
                                <input type="checkbox" id="neuroRiskDiabetes" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #EF4444;">
                                <span style="font-size: 0.875rem; color: #374151;">Type 2 Diabetes</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #E5E7EB;">
                                <input type="checkbox" id="neuroRiskHypertension" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #EF4444;">
                                <span style="font-size: 0.875rem; color: #374151;">Hypertension</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #E5E7EB;">
                                <input type="checkbox" id="neuroRiskSmoking" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #EF4444;">
                                <span style="font-size: 0.875rem; color: #374151;">Current Smoker</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #E5E7EB;">
                                <input type="checkbox" id="neuroRiskObesity" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #EF4444;">
                                <span style="font-size: 0.875rem; color: #374151;">Obesity (BMI > 30)</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #E5E7EB;">
                                <input type="checkbox" id="neuroRiskMemory" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #EF4444;">
                                <span style="font-size: 0.875rem; color: #374151;">Memory Complaints</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #E5E7EB;">
                                <input type="checkbox" id="neuroRiskDepression" style="margin-right: 0.5rem; width: 18px; height: 18px; accent-color: #EF4444;">
                                <span style="font-size: 0.875rem; color: #374151;">Depression</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">APOE4 Genetic Status (if known)</label>
                        <select id="neuroRiskAPOE4" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            <option value="unknown">Unknown</option>
                            <option value="none">No APOE4 alleles</option>
                            <option value="one">1 APOE4 allele</option>
                            <option value="two">2 APOE4 alleles</option>
                        </select>
                    </div>
                </div>

                <button onclick="calculateNeuroRisk()" style="width: 100%; padding: 1rem 1.5rem; background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-bottom: 1.5rem;">
                    Calculate Risk Profile
                </button>

                <div id="neuroRiskResults" style="display: none;">
                    <div style="background: linear-gradient(135deg, #7C3AED, #6D28D9); padding: 2rem; border-radius: 16px; text-align: center; margin-bottom: 1.5rem; color: white;">
                        <div style="font-size: 0.875rem; color: rgba(255,255,255,0.8); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">10-Year Risk Estimate</div>
                        <div id="neuroRiskPercentage" style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem;">--</div>
                        <div id="neuroRiskLevel" style="font-size: 1rem; font-weight: 600; color: #FDE047; text-transform: uppercase; letter-spacing: 1px;"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Alzheimer's</div>
                            <div id="neuroRiskAlzheimer" style="font-size: 1.75rem; font-weight: 700; color: #7C3AED;">--</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Stroke</div>
                            <div id="neuroRiskStroke" style="font-size: 1.75rem; font-weight: 700; color: #EF4444;">--</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Parkinson's</div>
                            <div id="neuroRiskParkinson" style="font-size: 1.75rem; font-weight: 700; color: #F59E0B;">--</div>
                        </div>
                    </div>

                    <div style="background: #DBEAFE; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3B82F6; margin-bottom: 1rem;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #1E40AF; margin-bottom: 0.75rem; display: flex; align-items: center;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/>
                            </svg>
                            Protective Actions You Can Take
                        </h4>
                        <div id="neuroRiskActions" style="color: #1E3A8A; font-size: 0.875rem; line-height: 1.6;"></div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #374151; margin-bottom: 1rem; text-transform: uppercase;">Evidence-Based References</h4>
                        <div id="neuroRiskReferences" style="font-size: 0.875rem; color: #6B7280; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Digital Neuro-Twin Modal -->
    <div class="modal" id="neuroTwinModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="7" r="4"/>
                        <circle cx="15" cy="7" r="4"/>
                        <path d="M9 11v10"/>
                        <path d="M15 11v10"/>
                        <path d="M5 21h8"/>
                        <path d="M11 21h8"/>
                    </svg>
                    Digital Neuro-Twin (Predictive Modeling)
                </div>
                <button class="modal-close" onclick="closePanel('neuroTwinModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #F0F9FF, #E0F2FE); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #0EA5E9; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: start;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 1rem; color: #0284C7; flex-shrink: 0;">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/>
                        </svg>
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 700; color: #075985; margin-bottom: 0.5rem;">How Digital Neuro-Twin Works</h4>
                            <p style="font-size: 0.875rem; color: #0C4A6E; line-height: 1.5;">Create an anonymized digital twin model using Azure ML to simulate brain aging trajectories and predict future cognitive changes based on multimodal data (FHIR + imaging + genetics).</p>
                        </div>
                    </div>
                </div>

                <div style="background: #F9FAFB; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Input Data Sources</h3>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 2px solid #D1D5DB; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#10A37F'; this.style.boxShadow='0 4px 12px rgba(16,163,127,0.15)'" onmouseout="this.style.borderColor='#D1D5DB'; this.style.boxShadow='none'">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.75rem; color: #10A37F;">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">FHIR Data</div>
                            <div id="neuroTwinFHIRStatus" style="font-size: 0.75rem; color: #6B7280;">Not connected</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 2px solid #D1D5DB; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#10A37F'; this.style.boxShadow='0 4px 12px rgba(16,163,127,0.15)'" onmouseout="this.style.borderColor='#D1D5DB'; this.style.boxShadow='none'">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.75rem; color: #FF6B4A;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Brain MRI</div>
                            <div id="neuroTwinMRIStatus" style="font-size: 0.75rem; color: #6B7280;">Not uploaded</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 2px solid #D1D5DB; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#10A37F'; this.style.boxShadow='0 4px 12px rgba(16,163,127,0.15)'" onmouseout="this.style.borderColor='#D1D5DB'; this.style.boxShadow='none'">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.75rem; color: #3B82F6;">
                                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/>
                            </svg>
                            <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Genetics</div>
                            <div id="neuroTwinGeneticsStatus" style="font-size: 0.75rem; color: #6B7280;">Optional</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Patient Cluster ID (anonymized)</label>
                        <input type="text" id="neuroTwinPatientID" placeholder="e.g., SHA256-abc123..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem; background: #F3F4F6;" readonly>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Simulation Time Horizon</label>
                        <select id="neuroTwinTimeHorizon" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            <option value="5">5 years</option>
                            <option value="10" selected>10 years</option>
                            <option value="15">15 years</option>
                            <option value="20">20 years</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateNeuroTwin()" style="width: 100%; padding: 1rem 1.5rem; background: linear-gradient(135deg, #0EA5E9, #0284C7); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-bottom: 1.5rem;">
                    Generate Digital Neuro-Twin Model
                </button>

                <div id="neuroTwinResults" style="display: none;">
                    <div style="background: linear-gradient(135deg, #1E293B, #334155); padding: 2rem; border-radius: 16px; margin-bottom: 1.5rem; color: white;">
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.75rem;">
                                <path d="M3 3v18h18"/>
                                <path d="M18 17V9"/>
                                <path d="M13 17V5"/>
                                <path d="M8 17v-3"/>
                            </svg>
                            Predicted Brain Aging Trajectory
                        </h3>
                        <canvas id="neuroTwinChart" style="max-height: 300px; width: 100%;"></canvas>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Brain Age</div>
                            <div id="neuroTwinBrainAge" style="font-size: 1.75rem; font-weight: 700; color: #7C3AED;">--</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Cognitive Reserve</div>
                            <div id="neuroTwinCognitiveReserve" style="font-size: 1.75rem; font-weight: 700; color: #10A37F;">--</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Model Confidence</div>
                            <div id="neuroTwinConfidence" style="font-size: 1.75rem; font-weight: 700; color: #0EA5E9;">--</div>
                        </div>
                    </div>

                    <div style="background: #FEF3C7; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #F59E0B; margin-bottom: 1rem;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #92400E; margin-bottom: 0.75rem; display: flex; align-items: center;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Intervention Opportunities
                        </h4>
                        <div id="neuroTwinInterventions" style="color: #78350F; font-size: 0.875rem; line-height: 1.6;"></div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #374151; margin-bottom: 1rem; text-transform: uppercase; display: flex; align-items: center; justify-content: space-between;">
                            <span>Privacy Guarantees (Differential Privacy =0.5)</span>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #10A37F;">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </h4>
                        <div style="font-size: 0.875rem; color: #6B7280; line-height: 1.6;">
                            <p style="margin-bottom: 0.5rem;"> All personal identifiers removed via SHA-256 irreversible hashing</p>
                            <p style="margin-bottom: 0.5rem;"> Predictions based on anonymized patient clusters (n50)</p>
                            <p style="margin-bottom: 0.5rem;"> HIPAA/GDPR/KVKK compliant data processing</p>
                            <p> Differential privacy noise added (=0.5) to prevent re-identification</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Clinician Portal Modal -->
    <div class="modal" id="neuroClinicianModal">
        <div class="modal-content" style="max-width: 950px;">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M16 11l2 2 4-4"/>
                    </svg>
                    Clinician Validation Portal
                </div>
                <button class="modal-close" onclick="closePanel('neuroClinicianModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #EFF6FF, #DBEAFE); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3B82F6; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: start;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 1rem; color: #2563EB; flex-shrink: 0;">
                            <path d="M16 11l2 2 4-4"/>
                            <path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10z"/>
                        </svg>
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 700; color: #1E40AF; margin-bottom: 0.5rem;">Clinician-in-the-Loop Validation</h4>
                            <p style="font-size: 0.875rem; color: #1E3A8A; line-height: 1.5;">This portal allows licensed healthcare professionals to review, validate, and provide feedback on AI-generated assessments. All validations are logged for continuous model improvement.</p>
                        </div>
                    </div>
                </div>

                <div style="background: #F9FAFB; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Clinician Authentication</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Medical License Number</label>
                            <input type="text" id="clinicianLicenseNumber" placeholder="e.g., MD-123456" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Specialty</label>
                            <select id="clinicianSpecialty" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                <option value="">Select Specialty</option>
                                <option value="neurology">Neurology</option>
                                <option value="radiology">Radiology</option>
                                <option value="psychiatry">Psychiatry</option>
                                <option value="geriatrics">Geriatrics</option>
                                <option value="neuroradiology">Neuroradiology</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="authenticateClinician()" style="width: 100%; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem; margin-bottom: 1rem;">
                        Authenticate & Access Validation Queue
                    </button>
                </div>

                <div id="clinicianDashboard" style="display: none;">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; color: #374151;">Pending AI Assessments</h3>
                            <span style="background: #FEE2E2; color: #991B1B; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600;">12 Pending</span>
                        </div>

                        <div style="max-height: 400px; overflow-y: auto;">
                            <!-- Sample AI Assessment Card -->
                            <div style="background: #F9FAFB; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div>
                                        <div style="font-size: 0.875rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem;">Brain Imaging Analysis #2847</div>
                                        <div style="font-size: 0.75rem; color: #6B7280;">Patient Cluster: SHA256-7f8a3...</div>
                                        <div style="font-size: 0.75rem; color: #6B7280;">Submitted: 2 hours ago</div>
                                    </div>
                                    <span style="background: #DBEAFE; color: #1E40AF; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">MRI Analysis</span>
                                </div>

                                <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">AI Findings:</div>
                                    <p style="font-size: 0.875rem; color: #6B7280; line-height: 1.5; margin-bottom: 0.75rem;">Bilateral hippocampal atrophy detected (left: 15% volume loss, right: 12% volume loss). Mild periventricular white matter hyperintensities consistent with small vessel disease.</p>
                                    <div style="display: flex; gap: 1rem;">
                                        <div>
                                            <span style="font-size: 0.75rem; color: #6B7280; font-weight: 500;">AI Confidence:</span>
                                            <span style="font-size: 0.875rem; font-weight: 700; color: #10A37F; margin-left: 0.5rem;">87%</span>
                                        </div>
                                        <div>
                                            <span style="font-size: 0.75rem; color: #6B7280; font-weight: 500;">Risk Level:</span>
                                            <span style="font-size: 0.875rem; font-weight: 700; color: #F59E0B; margin-left: 0.5rem;">Moderate</span>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 0.75rem;">
                                    <button onclick="validateAssessment(2847, 'approve')" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #10A37F, #0D8A6A); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
                                         Approve
                                    </button>
                                    <button onclick="validateAssessment(2847, 'revise')" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
                                         Request Revision
                                    </button>
                                    <button onclick="validateAssessment(2847, 'reject')" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
                                         Reject
                                    </button>
                                </div>
                            </div>

                            <!-- More sample cards would appear here -->
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Total Reviewed</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #3B82F6;">487</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Approval Rate</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #10A37F;">92%</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Avg Response Time</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #F59E0B;">2.3h</div>
                        </div>
                        <div style="background: white; padding: 1.25rem; border-radius: 10px; border: 1px solid #E5E7EB; text-align: center;">
                            <div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Your Rank</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #7C3AED;">#8</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--  RARE DISEASE DIAGNOSTIC ASSISTANT MODAL -->
    <div id="rareDiseaseModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div>
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-primary);"> Rare Disease Diagnostic Assistant</h2>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--text-secondary);">RAG-Based AI for 7,000+ Rare Diseases  Reduces Diagnostic Odyssey from 7 years to <1 year</p>
                </div>
                <button class="modal-close" onclick="closePanel('rareDiseaseModal', event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #F59E0B; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: start;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 1rem; color: #D97706; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6"/>
                            <circle cx="12" cy="16" r="1"/>
                        </svg>
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 700; color: #92400E; margin-bottom: 0.5rem;">350 Million People Live with Rare Diseases</h4>
                            <p style="font-size: 0.875rem; color: #78350F; line-height: 1.5;">Average diagnosis time: 4.7-7.6 years. LyDian AI reduces this by 80-85% through symptom-based phenotypical analysis.</p>
                        </div>
                    </div>
                </div>

                <div style="background: #F9FAFB; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Patient Symptoms and Clinical Information</h3>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Symptoms (comma-separated)</label>
                        <textarea id="rareDiseaseSymptoms" placeholder="e.g., joint hypermobility, skin hyperextensibility, easy bruising, chronic pain" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem; min-height: 100px; font-family: 'Inter', sans-serif;"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Age</label>
                            <input type="number" id="rareDiseaseAge" placeholder="e.g., 35" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Gender</label>
                            <select id="rareDiseaseGender" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Family History</label>
                        <textarea id="rareDiseaseFamilyHistory" placeholder="Similar cases in family, genetic diseases..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem; min-height: 60px; font-family: 'Inter', sans-serif;"></textarea>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #6B7280; font-size: 0.875rem; font-weight: 500;">Lab Findings (optional)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; font-size: 0.875rem; color: #4B5563;">
                                <input type="checkbox" id="labElevatedCK" style="margin-right: 0.5rem;">
                                Elevated CK
                            </label>
                            <label style="display: flex; align-items: center; font-size: 0.875rem; color: #4B5563;">
                                <input type="checkbox" id="labLowCeruloplasmin" style="margin-right: 0.5rem;">
                                Low Ceruloplasmin
                            </label>
                            <label style="display: flex; align-items: center; font-size: 0.875rem; color: #4B5563;">
                                <input type="checkbox" id="labElevatedIGF1" style="margin-right: 0.5rem;">
                                Elevated IGF-1
                            </label>
                        </div>
                    </div>

                    <button onclick="analyzeRareDisease()" style="width: 100%; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem; margin-bottom: 1rem;">
                         Start Differential Diagnosis Analysis
                    </button>
                </div>

                <div id="rareDiseaseResults" style="display: none;">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Differential Diagnoses (Top 5)</h3>
                        <div id="differentialDiagnoses"></div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Clinical Reasoning</h3>
                        <div id="clinicalReasoning"></div>
                    </div>

                    <div style="background: linear-gradient(135deg, #DBEAFE, #BFDBFE); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3B82F6;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #1E40AF; margin-bottom: 0.5rem;"> Next Steps</h4>
                        <div id="nextSteps"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency AI Triage Modal -->
    <div id="emergencyTriageModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2> Emergency AI Triage System</h2>
                <span class="close" onclick="closeModal('emergencyTriageModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #F59E0B;">
                    <p style="color: #92400E; font-size: 0.875rem; margin: 0;">
                        <strong> ESI-Based Triage:</strong> Emergency Severity Index (ESI) 5-level triage system used globally. Reduces ED wait times by 40%, improves critical patient identification by 95%.
                    </p>
                </div>

                <form id="emergencyTriageForm" onsubmit="event.preventDefault(); analyzeEmergencyTriage();">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <!-- Left Column -->
                        <div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Chief Complaint</label>
                                <textarea id="chiefComplaint" rows="3" placeholder="e.g., Chest pain, difficulty breathing, severe headache..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required></textarea>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Arrival Mode</label>
                                <select id="arrivalMode" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                    <option value="walk-in">Walk-in</option>
                                    <option value="ambulance">Ambulance</option>
                                    <option value="ambulance-critical">Ambulance (Critical)</option>
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Age</label>
                                    <input type="number" id="patientAge" placeholder="35" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Gender</label>
                                    <select id="patientGender" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Pain Level (0-10)</label>
                                <input type="range" id="painLevel" min="0" max="10" value="5" oninput="document.getElementById('painLevelValue').textContent = this.value" style="width: 100%;">
                                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: #6B7280;">No Pain (0)</span>
                                    <span id="painLevelValue" style="font-weight: 600; color: #DC2626;">5</span>
                                    <span style="font-size: 0.75rem; color: #6B7280;">Worst Pain (10)</span>
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Resources Needed</label>
                                <select id="resourcesNeeded" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                    <option value="0">None</option>
                                    <option value="1">1 (e.g., sutures only)</option>
                                    <option value="2">2 (e.g., labs + imaging)</option>
                                    <option value="3">3+ (complex workup)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Right Column - Vital Signs -->
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Vital Signs</h4>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Heart Rate (bpm)</label>
                                <input type="number" id="heartRate" placeholder="75" min="30" max="200" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Blood Pressure (mmHg)</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <input type="number" id="systolicBP" placeholder="120 (systolic)" min="60" max="250" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                                    <input type="number" id="diastolicBP" placeholder="80 (diastolic)" min="40" max="150" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                                </div>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Respiratory Rate (breaths/min)</label>
                                <input type="number" id="respiratoryRate" placeholder="16" min="5" max="50" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Oxygen Saturation (%)</label>
                                <input type="number" id="oxygenSaturation" placeholder="98" min="70" max="100" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Temperature (C)</label>
                                <input type="number" id="temperature" placeholder="37.0" min="30" max="45" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Glasgow Coma Scale (3-15)</label>
                                <input type="number" id="glasgowComaScale" placeholder="15" min="3" max="15" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>
                        </div>
                    </div>

                    <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #DC2626, #991B1B); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 1rem;">
                         Calculate ESI Triage Level
                    </button>
                </form>

                <div id="triageLoading" style="display: none; text-align: center; padding: 2rem;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #DC2626; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; color: #6B7280;">Analyzing patient vitals and calculating ESI level...</p>
                </div>

                <div id="triageResults" style="display: none;">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> ESI Triage Level</h3>
                        <div id="esiLevel"></div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Vital Signs Status</h3>
                        <div id="vitalSignsStatus"></div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Care Recommendations</h3>
                        <div id="careRecommendations"></div>
                    </div>

                    <div style="background: linear-gradient(135deg, #DBEAFE, #BFDBFE); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3B82F6;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #1E40AF; margin-bottom: 0.5rem;"> Disposition</h4>
                        <div id="disposition"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sepsis Early Warning Modal -->
    <div id="sepsisWarningModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2> Sepsis Early Warning System</h2>
                <span class="close" onclick="closeModal('sepsisWarningModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #FEE2E2, #FECACA); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #DC2626;">
                    <p style="color: #991B1B; font-size: 0.875rem; margin: 0;">
                        <strong> Sepsis Detection:</strong> qSOFA + SIRS + SOFA scoring. Detects sepsis 6-12 hours earlier, reduces mortality by 30%. Based on Surviving Sepsis Campaign Guidelines 2021.
                    </p>
                </div>

                <form id="sepsisWarningForm" onsubmit="event.preventDefault(); analyzeSepsisRisk();">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">
                        <!-- Vital Signs Column -->
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Vital Signs</h4>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Heart Rate (bpm)</label>
                                <input type="number" id="sepsisHeartRate" placeholder="95" min="30" max="200" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Respiratory Rate (breaths/min)</label>
                                <input type="number" id="sepsisRespiratoryRate" placeholder="24" min="5" max="50" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Temperature (C)</label>
                                <input type="number" id="sepsisTemperature" placeholder="38.5" min="30" max="45" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Systolic BP (mmHg)</label>
                                <input type="number" id="sepsisSystolicBP" placeholder="95" min="60" max="250" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;" required>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Glasgow Coma Scale</label>
                                <input type="number" id="sepsisGCS" placeholder="14" min="3" max="15" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>
                        </div>

                        <!-- Laboratory Values Column -->
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Laboratory Values</h4>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">WBC (x10/L)</label>
                                <input type="number" id="sepsisWBC" placeholder="14" min="0" max="50" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Lactate (mmol/L)</label>
                                <input type="number" id="sepsisLactate" placeholder="3.5" min="0" max="20" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Creatinine (mg/dL)</label>
                                <input type="number" id="sepsisCreatinine" placeholder="1.8" min="0" max="15" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Platelets (x10/L)</label>
                                <input type="number" id="sepsisPLT" placeholder="120" min="0" max="1000" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Bilirubin (mg/dL)</label>
                                <input type="number" id="sepsisBilirubin" placeholder="1.5" min="0" max="30" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>
                        </div>

                        <!-- Clinical Context Column -->
                        <div>
                            <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Clinical Context</h4>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Mean Arterial Pressure</label>
                                <input type="number" id="sepsisMAP" placeholder="65" min="30" max="150" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Age</label>
                                <input type="number" id="sepsisAge" placeholder="65" min="0" max="120" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.875rem;">Gender</label>
                                <select id="sepsisGender" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem;">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="sepsisVasopressors" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.875rem; color: #374151;">On Vasopressors</span>
                                </label>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="sepsisSuspectedInfection" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.875rem; color: #374151;">Suspected Infection</span>
                                </label>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="sepsisImmunocompromised" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.875rem; color: #374151;">Immunocompromised</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #DC2626, #991B1B); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 1.5rem;">
                         Analyze Sepsis Risk
                    </button>
                </form>

                <div id="sepsisLoading" style="display: none; text-align: center; padding: 2rem;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #DC2626; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; color: #6B7280;">Calculating sepsis scores and risk assessment...</p>
                </div>

                <div id="sepsisResults" style="display: none;">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Sepsis Risk Assessment</h3>
                        <div id="sepsisRiskLevel"></div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Clinical Scores</h3>
                        <div id="sepsisScores"></div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem;"> Treatment Recommendations</h3>
                        <div id="sepsisRecommendations"></div>
                    </div>

                    <div style="background: linear-gradient(135deg, #FEE2E2, #FECACA); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #DC2626;">
                        <h4 style="font-size: 0.875rem; font-weight: 700; color: #991B1B; margin-bottom: 0.5rem;"> Sepsis Bundles</h4>
                        <div id="sepsisBundles"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Multimodal Data Fusion Platform Modal -->
    <div id="multimodalFusionModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2> Multimodal Data Fusion Platform</h2>
                <span class="close" onclick="closeModal('multimodalFusionModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, #E0E7FF, #DDD6FE); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #8B5CF6;">
                    <p style="color: #5B21B6; font-size: 0.875rem; margin: 0;">
                        <strong> Precision Medicine Platform:</strong> Integrates DICOM imaging, FHIR clinical records, and genomic data for comprehensive patient analysis. Enables personalized treatment strategies with 94% diagnostic accuracy.
                    </p>
                </div>

                <form id="multimodalFusionForm" onsubmit="event.preventDefault(); analyzeMultimodalData();">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">

                        <!-- DICOM Imaging Data -->
                        <div>
                            <h3 style="color: #10B981; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                 DICOM Imaging
                            </h3>
                            <div class="form-group">
                                <label>Imaging Modality:</label>
                                <select id="dicomModality" class="form-control">
                                    <option value="">-- Select Modality --</option>
                                    <option value="CT">CT Scan</option>
                                    <option value="MRI">MRI</option>
                                    <option value="X-RAY">X-Ray</option>
                                    <option value="PET">PET Scan</option>
                                    <option value="ULTRASOUND">Ultrasound</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Body Part:</label>
                                <select id="dicomBodyPart" class="form-control">
                                    <option value="CHEST">Chest</option>
                                    <option value="HEAD">Head</option>
                                    <option value="ABDOMEN">Abdomen</option>
                                    <option value="SPINE">Spine</option>
                                    <option value="PELVIS">Pelvis</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="dicomAbnormality">
                                    Abnormality Detected
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="dicomContrast">
                                    Contrast Used
                                </label>
                            </div>
                        </div>

                        <!-- FHIR Clinical Data -->
                        <div>
                            <h3 style="color: #3B82F6; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                 FHIR Clinical Data
                            </h3>
                            <div class="form-group">
                                <label>Blood Pressure (Systolic):</label>
                                <input type="number" id="fhirSystolicBP" class="form-control" placeholder="120 mmHg">
                            </div>
                            <div class="form-group">
                                <label>Blood Pressure (Diastolic):</label>
                                <input type="number" id="fhirDiastolicBP" class="form-control" placeholder="80 mmHg">
                            </div>
                            <div class="form-group">
                                <label>Glucose (Fasting):</label>
                                <input type="number" step="0.1" id="fhirGlucose" class="form-control" placeholder="100 mg/dL">
                            </div>
                            <div class="form-group">
                                <label>Total Cholesterol:</label>
                                <input type="number" id="fhirCholesterol" class="form-control" placeholder="180 mg/dL">
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="fhirDiabetes">
                                    Diabetes Mellitus
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="fhirHypertension">
                                    Hypertension
                                </label>
                            </div>
                        </div>

                        <!-- Genomic Data -->
                        <div>
                            <h3 style="color: #8B5CF6; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                 Genomic Data
                            </h3>
                            <div class="form-group">
                                <label>BRCA1 Variant:</label>
                                <select id="genomicBRCA1" class="form-control">
                                    <option value="">-- Select --</option>
                                    <option value="PATHOGENIC">Pathogenic</option>
                                    <option value="BENIGN">Benign</option>
                                    <option value="VUS">Variant of Uncertain Significance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>APOE Genotype:</label>
                                <select id="genomicAPOE" class="form-control">
                                    <option value="">-- Select --</option>
                                    <option value="E2/E2">E2/E2</option>
                                    <option value="E2/E3">E2/E3</option>
                                    <option value="E3/E3">E3/E3 (Normal)</option>
                                    <option value="E3/E4">E3/E4</option>
                                    <option value="E4/E4">E4/E4 (High Risk)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>CYP2D6 Metabolizer Status:</label>
                                <select id="genomicCYP2D6" class="form-control">
                                    <option value="">-- Select --</option>
                                    <option value="POOR_METABOLIZER">Poor Metabolizer</option>
                                    <option value="INTERMEDIATE_METABOLIZER">Intermediate Metabolizer</option>
                                    <option value="NORMAL_METABOLIZER">Normal Metabolizer</option>
                                    <option value="RAPID_METABOLIZER">Rapid Metabolizer</option>
                                    <option value="ULTRA_RAPID_METABOLIZER">Ultra-Rapid Metabolizer</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button type="submit" style="width: 100%; margin-top: 1.5rem; padding: 0.875rem; background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                         Analyze Multimodal Data
                    </button>
                </form>

                <!-- Loading Indicator -->
                <div id="multimodalLoading" style="display: none; text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem; color: #6B7280;">Analyzing multimodal data across DICOM, FHIR, and genomic domains...</p>
                </div>

                <!-- Results -->
                <div id="multimodalResults" style="display: none; margin-top: 2rem;">
                    <h3 style="color: #1F2937; margin-bottom: 1rem;"> Multimodal Analysis Results</h3>

                    <div id="dicomAnalysis" style="margin-bottom: 1.5rem;"></div>
                    <div id="fhirAnalysis" style="margin-bottom: 1.5rem;"></div>
                    <div id="genomicAnalysis" style="margin-bottom: 1.5rem;"></div>
                    <div id="fusedInsights" style="margin-bottom: 1.5rem;"></div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
